<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MerSam OS v3.9 - Smooth Spidey</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FCE4EC">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MerSam">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700;800&family=Caveat:wght@700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        /* Touch Optimierung */
        * { -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text; }
        
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #FCE4EC;
            color: #2D3748;
            padding-bottom: 100px;
            overflow-x: hidden;
            overscroll-behavior-y: none;
            transition: background 0.5s ease;
            position: relative;
        }

        /* --- THEMES --- */
        body.theme-original { background: linear-gradient(-45deg, #E0F2F1, #FCE4EC, #E0F7FA, #F8BBD0); background-size: 400% 400%; animation: gradient 15s ease infinite; }
        body.theme-midnight { background: linear-gradient(to bottom, #0f172a, #334155); color: #e2e8f0; }
        body.theme-sunset { background: linear-gradient(to bottom right, #ffedd5, #fdba74, #fb7185); }
        body.theme-fresh { background: linear-gradient(to top left, #d1fae5, #ecfccb, #ccfbf1); }
        
        /* SPIDERMAN THEME SPECIALS */
        body.theme-spiderman { 
            background: 
                radial-gradient(circle at 50% 50%, rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(135deg, #0d47a1 0%, #b71c1c 100%); 
            background-size: 20px 20px, 100% 100%; 
            color: #1a202c; 
        }
        body.theme-spiderman .pink-btn { background-color: #d32f2f; box-shadow: 0 4px 0 #b71c1c; } 
        body.theme-spiderman .pink-btn:active { background-color: #b71c1c; transform: translateY(4px); box-shadow: none; }
        body.theme-spiderman .teal-btn { background-color: #1565c0; box-shadow: 0 4px 0 #0d47a1; } 
        body.theme-spiderman .teal-btn:active { background-color: #0d47a1; transform: translateY(4px); box-shadow: none; }
        body.theme-spiderman .mint-card { border: 3px solid #ef5350; } 
        
        /* WICHTIG: Spinne nur anzeigen wenn Theme aktiv ist */
        body.theme-spiderman .hanging-spider { display: block !important; }
        
        /* Timeline Spidey Adjustments */
        body.theme-spiderman .timeline-line { background: white !important; width: 1px !important; opacity: 0.6; }
        body.theme-spiderman .timeline-dot { background: #d32f2f !important; border-color: white !important; box-shadow: 0 0 10px #d32f2f !important; }

        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* H√§ngende Spinne (Standard: AUSGEBLENDET) */
        .hanging-spider {
            display: none; /* WICHTIG: Default off */
            position: fixed; top: -20px; right: 20px; width: 60px; height: 100px;
            z-index: 40; pointer-events: none;
            animation: swingSpider 3s ease-in-out infinite alternate; transform-origin: top center;
        }
        @keyframes swingSpider { from { transform: rotate(-5deg) translateY(0); } to { transform: rotate(5deg) translateY(5px); } }

        /* Krabbelnde Spinne */
        .spawned-spider { position: fixed; width: 25px; height: 25px; z-index: 10000; pointer-events: none; opacity: 0.9; }
        .spawned-spider svg { fill: #222; filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.3)); }
        
        @keyframes peekTopAnim { 0% { top: -30px; opacity: 0; } 20% { top: 5px; opacity: 1; } 80% { top: 5px; opacity: 1; } 100% { top: -30px; opacity: 0; } }
        @keyframes peekBottomAnim { 0% { bottom: -30px; opacity: 0; } 20% { bottom: 5px; opacity: 1; } 80% { bottom: 5px; opacity: 1; } 100% { bottom: -30px; opacity: 0; } }
        @keyframes peekLeftAnim { 0% { left: -30px; opacity: 0; } 20% { left: 5px; opacity: 1; } 80% { left: 5px; opacity: 1; } 100% { left: -30px; opacity: 0; } }
        @keyframes peekRightAnim { 0% { right: -30px; opacity: 0; } 20% { right: 5px; opacity: 1; } 80% { right: 5px; opacity: 1; } 100% { right: -30px; opacity: 0; } }

        /* TIMELINE STYLES */
        .timeline-wrapper { position: relative; padding-left: 24px; margin-bottom: 20px; }
        .timeline-line {
            position: absolute; left: 7px; top: 10px; bottom: -30px; width: 3px;
            background: linear-gradient(to bottom, #F472B6, #2DD4BF);
            border-radius: 2px;
        }
        .timeline-wrapper:last-child .timeline-line { bottom: 30px; background: linear-gradient(to bottom, #2DD4BF, transparent); }
        .timeline-dot {
            position: absolute; left: 0; top: 18px; width: 17px; height: 17px;
            border-radius: 50%; background: white; border: 4px solid #F472B6;
            z-index: 2; box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
        }
        .timeline-content { margin-left: 10px; position: relative; }
        .timeline-content::before {
            content: ''; position: absolute; left: -6px; top: 20px;
            width: 10px; height: 10px; background: white;
            transform: rotate(45deg); border-left: 1px solid rgba(178, 223, 219, 0.5); border-bottom: 1px solid rgba(178, 223, 219, 0.5);
        }

        /* Buttons & Cards */
        .pink-btn { background-color: #FF80AB; color: white; transition: all 0.2s; }
        .pink-btn:active { transform: scale(0.96); }
        .teal-btn { background-color: #14B8A6; color: white; transition: all 0.2s; }
        .teal-btn:active { transform: scale(0.96); }
        .mint-card { background: white; border-radius: 28px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); border: 1px solid rgba(178, 223, 219, 0.5); }
        .hidden { display: none !important; }
        
        /* Floating Hearts (Nur in Original Themes) */
        .floating-heart { position: absolute; color: rgba(255, 128, 171, 0.6); animation: float 5s infinite linear; z-index: 0; pointer-events: none; }
        @keyframes float { 0% { transform: translateY(110vh) scale(0.5) rotate(0deg); opacity: 0; } 20% { opacity: 0.8; } 100% { transform: translateY(-10vh) scale(1.2) rotate(360deg); opacity: 0; } }

        /* 3D W√ºrfel */
        .scene { width: 80px; height: 80px; perspective: 600px; margin: 0 auto; cursor: pointer; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transform: translateZ(-40px); transition: transform 1s; }
        .cube.is-spinning { animation: spinCube 0.8s linear infinite; }
        @keyframes spinCube { 0% { transform: translateZ(-40px) rotateX(0deg) rotateY(0deg); } 100% { transform: translateZ(-40px) rotateX(360deg) rotateY(720deg); } }
        .cube__face { position: absolute; width: 80px; height: 80px; border: 2px solid white; background: linear-gradient(145deg, #ffffff, #f0f0f0); border-radius: 16px; display: flex; justify-content: center; align-items: center; backface-visibility: hidden; }
        .face-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); width: 60%; height: 60%; gap: 2px; }
        .dot { background-color: #EC4899; border-radius: 50%; width: 100%; height: 100%; }
        .d-center { grid-area: 2 / 2 / 3 / 3; } .d-tl { grid-area: 1 / 1 / 2 / 2; } .d-tr { grid-area: 1 / 3 / 2 / 4; } .d-ml { grid-area: 2 / 1 / 3 / 2; } .d-mr { grid-area: 2 / 3 / 3 / 4; } .d-bl { grid-area: 3 / 1 / 4 / 2; } .d-br { grid-area: 3 / 3 / 4 / 4; } 
        .cube__face--1 { transform: rotateY(  0deg) translateZ(40px); } .cube__face--2 { transform: rotateY( 90deg) translateZ(40px); } .cube__face--3 { transform: rotateY(180deg) translateZ(40px); } .cube__face--4 { transform: rotateY(-90deg) translateZ(40px); } .cube__face--5 { transform: rotateX( 90deg) translateZ(40px); } .cube__face--6 { transform: rotateX(-90deg) translateZ(40px); }

        /* Animationen */
        .animate-fade-in-down { animation: fadeInDown 0.8s ease-out forwards; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-scale-in { animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .magic-pop-in { animation: magicPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; transform-origin: center center; }
        @keyframes magicPop { 0% { opacity: 0; transform: scale(0.1) rotate(-10deg); filter: blur(10px); } 60% { transform: scale(1.1) rotate(2deg); } 100% { opacity: 1; transform: scale(1) rotate(0deg); filter: blur(0); } }

        /* Lock SVG */
        .lock-svg { width: 100px; height: 120px; overflow: visible; }
        .lock-body { fill: #EC4899; } .lock-shackle { fill: none; stroke: #9CA3AF; stroke-width: 12; stroke-linecap: round; transform-origin: 50% 35px; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .lock-pop-in { animation: popInLock 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popInLock { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .lock-rattle { animation: rattle 0.1s linear infinite; }
        @keyframes rattle { 0% { transform: rotate(0deg); } 25% { transform: rotate(2deg); } 75% { transform: rotate(-2deg); } 100% { transform: rotate(0deg); } }
        .lock-open .lock-shackle { transform: translateY(-25px) rotate(-45deg); stroke: #10B981; } .lock-open .lock-body { fill: #10B981; transition: fill 0.3s; }

        .flash-overlay { position: absolute; inset: 0; background: white; pointer-events: none; z-index: 50; opacity: 0; transition: opacity 1s; border-radius: 28px; }
        .do-flash { animation: flashAnim 0.8s ease-out forwards; }
        @keyframes flashAnim { 0% { opacity: 0; } 10% { opacity: 1; } 100% { opacity: 0; } }
        .unfold-anim { animation: unfold 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes unfold { 0% { transform: scaleY(0); opacity: 0; transform-origin: top; } 100% { transform: scaleY(1); opacity: 1; transform-origin: top; } }
        
        .quiz-flip { transition: transform 0.6s; transform-style: preserve-3d; }
        .quiz-flip-active { transform: rotateY(180deg); }
        .quiz-front, .quiz-back { backface-visibility: hidden; }
        .quiz-back { transform: rotateY(180deg); }
        /* --- QUIZ ARENA v2 (A/B/C + Timer) --- */
        .quiz2-chip { display:inline-flex; align-items:center; gap:6px; font-size:10px; font-weight:900; text-transform:uppercase; letter-spacing:0.12em;
            background: rgba(255,255,255,0.7); border: 1px solid #fbcfe8; padding: 6px 10px; border-radius: 999px; }
        .quiz2-chip input { accent-color: #ec4899; }

        .quiz2-timer-ring { width:38px; height:38px; border-radius:999px; display:flex; align-items:center; justify-content:center;
            border: 3px solid rgba(236,72,153,0.25); background: rgba(255,255,255,0.65); }

        .quiz2-ans-btn { width:100%; display:flex; align-items:center; gap:10px; text-align:left;
            padding: 14px 14px; border-radius: 16px; background: rgba(244,63,94,0.06);
            border: 1px solid rgba(251,207,232,0.9); box-shadow: 0 6px 16px rgba(15,23,42,0.06);
            transition: transform .12s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease; }
        .quiz2-ans-btn:active { transform: scale(0.98); }
        .quiz2-ans-btn[disabled] { opacity: 0.65; filter: grayscale(0.15); }

        .quiz2-badge { width:28px; height:28px; border-radius:10px; display:flex; align-items:center; justify-content:center;
            font-weight: 900; background: rgba(236,72,153,0.12); color:#be185d; }
        .quiz2-ans-text { font-weight: 800; font-size: 12px; color: #0f172a; }

        @keyframes quiz2Shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-6px)} 40%{transform:translateX(6px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
        .quiz2-wrong { border-color: rgba(248,113,113,0.9)!important; background: rgba(248,113,113,0.10)!important; animation: quiz2Shake .35s ease; }
        .quiz2-right { border-color: rgba(34,197,94,0.95)!important; background: rgba(34,197,94,0.10)!important; box-shadow: 0 10px 26px rgba(34,197,94,0.18); }
        .quiz2-reveal { outline: 2px solid rgba(34,197,94,0.55); outline-offset: 2px; }


        .user-badge { font-size: 9px; padding: 2px 8px; border-radius: 99px; font-weight: bold; text-transform: uppercase; }
        .badge-meriam { background-color: #fce4ec; color: #f06292; } .badge-samet { background-color: #e0f2f1; color: #00897b; }
        .filter-select { background-color: #f0fdfa; border: 1px solid #99f6e4; border-radius: 0.75rem; padding: 0.5rem; font-size: 0.875rem; outline: none; }
        .online-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; } .online { background-color: #4ADE80; box-shadow: 0 0 8px #4ADE80; } .offline { background-color: #CBD5E1; }
        .stat-card { text-align: center; padding: 18px 5px; display: flex; flex-direction: column; justify-content: space-between; }
        .stat-title { font-size: 0.55rem; text-transform: uppercase; color: #94A3B8; font-weight: 800; letter-spacing: 0.1em; margin-bottom: 4px; }
        .stat-val { font-size: 2rem; font-weight: 900; color: #111827; line-height: 1; }
        .stat-label { font-size: 0.5rem; color: #64748B; font-weight: 700; margin-top: 6px; text-transform: uppercase; }
        .rating-btn { width: 24px; height: 24px; font-size: 9px; font-weight: bold; border-radius: 6px; border: 1px solid #E2E8F0; background: white; color: #64748B; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        
        .nav-bar { 
            position: fixed; bottom: 0; width: 100%; max-width: 448px; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            border-top: 1px solid #B2DFDB; display: flex; justify-content: space-around; 
            padding: 12px 0 25px 0; 
            z-index: 1000; 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; font-weight: bold; color: #94A3B8; cursor: pointer; transition: transform 0.1s; } 
        .nav-item:active { transform: scale(0.9); }
        .nav-item.active { color: #14B8A6; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; } .switch input { opacity: 0; width: 0; height: 0; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; } .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: #FF80AB; } input:checked + .slider:before { transform: translateX(20px); }
        .bucket-card { border: 2px solid #FFD700; background: linear-gradient(to bottom right, #FFFFFF, #FFFDF0); }
        .sparkle-btn { background: linear-gradient(135deg, #A855F7, #EC4899); color: white; transition: all 0.3s ease; } .sparkle-btn:hover { filter: brightness(1.1); transform: scale(1.05); box-shadow: 0 0 15px rgba(168, 85, 247, 0.4); }
        .chest-shake { animation: shakeChest 1s infinite; } @keyframes shakeChest { 0% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 50% { transform: rotate(10deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; } @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* MAP */
        #map { height: 70vh; width: 100%; border-radius: 32px; border: 4px solid white; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04), inset 0 0 40px rgba(0,0,0,0.05); z-index: 1; background-color: #f8fafc; }
        .custom-map-marker-container { display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .custom-map-marker-container:hover { transform: scale(1.2) translateY(-10px); z-index: 1000 !important; }
        .custom-map-marker { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(4px); border: 2px solid #EC4899; border-radius: 12px; padding: 6px 12px; text-align: center; font-weight: 800; font-size: 11px; color: #831843; box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3); white-space: nowrap; position: relative; transform: translateY(-10px); }
        .custom-map-marker::after { content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px; border-width: 6px 6px 0; border-style: solid; border-color: #EC4899 transparent transparent transparent; }
        .map-photo-pin { width: 48px; height: 48px; border-radius: 50%; border: 3px solid white; outline: 3px solid #14B8A6; object-fit: cover; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); background-color: white; transition: all 0.3s; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .custom-map-marker-container::before { content: ''; position: absolute; width: 10px; height: 10px; background-color: #EC4899; border-radius: 50%; bottom: -5px; opacity: 0.5; animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.33); opacity: 0.8; } 80%, 100% { transform: scale(2); opacity: 0; } }
        .leaflet-control-zoom { border: none !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important; margin-bottom: 80px !important; }
        .leaflet-control-zoom a { background-color: white !important; color: #EC4899 !important; border-radius: 8px !important; border: 1px solid #fce7f3 !important; }
        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background-color: rgba(236, 72, 153, 0.2) !important; }
        .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div { background-color: #EC4899 !important; color: white !important; font-family: 'Quicksand', sans-serif; font-weight: 800; border-radius: 50%; box-shadow: 0 0 10px rgba(236, 72, 153, 0.4); }

        /* GALERIE (Polaroids) */
        .polaroid { background: white; padding: 6px 6px 24px 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 4px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; cursor: pointer; }
        .polaroid:active { transform: scale(0.98) !important; }
        .polaroid img { width: 100%; height: 130px; object-fit: cover; border-radius: 2px; background-color: #f0f0f0; }
        .polaroid-caption { font-size: 11px; color: #333; text-align: center; margin-top: 8px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: 'Caveat', cursive; letter-spacing: 0.5px; }
        .polaroid:nth-child(3n+1) { transform: rotate(2deg); }
        .polaroid:nth-child(3n+2) { transform: rotate(-2deg); margin-top: 10px; }
        .polaroid:nth-child(3n+3) { transform: rotate(1deg); }

        /* Theme Circles */
        .theme-circle { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; }
        .theme-circle.active { border-color: #333; transform: scale(1.1); }
    
        /* --- SMOOTH UI TRANSITIONS (nur Animationen, keine Logik) --- */
        .ui-enter {
            opacity: 0;
            transform: translateY(8px) scale(0.99);
        }
        .ui-enter.ui-enter-active{
            opacity: 1;
            transform: translateY(0) scale(1);
            transition: opacity 360ms cubic-bezier(0.22, 1, 0.36, 1),
                        transform 360ms cubic-bezier(0.22, 1, 0.36, 1);
            will-change: opacity, transform;
        }
        .ui-exit-active{
            opacity: 0;
            transform: translateY(8px) scale(0.99);
            transition: opacity 220ms cubic-bezier(0.4, 0, 1, 1),
                        transform 220ms cubic-bezier(0.4, 0, 1, 1);
            will-change: opacity, transform;
        }
        .input-pop{
            animation: inputPop 320ms cubic-bezier(0.22, 1, 0.36, 1);
        }
        @keyframes inputPop{
            0%{ transform: scale(0.99); filter: saturate(0.95); }
            60%{ transform: scale(1.015); filter: saturate(1.1); }
            100%{ transform: scale(1); filter: saturate(1); }
        }
        .soft-typing{
            transition: box-shadow 240ms ease, border-color 240ms ease, transform 240ms ease;
        }
        .soft-typing.is-typing{
            box-shadow: 0 10px 25px rgba(236, 72, 153, 0.18);
            transform: translateY(-1px);
        }
        @media (prefers-reduced-motion: reduce){
            .ui-enter, .ui-enter.ui-enter-active, .ui-exit-active{ transition: none !important; transform: none !important; }
            .input-pop{ animation: none !important; }
        }


/* --- PIN styles (C24-like) --- */
.pin-dot{
  width: 14px; height: 14px; border-radius: 999px;
  border: 2px solid rgba(20,184,166,0.35);
  background: rgba(255,255,255,0.6);
  box-shadow: inset 0 0 0 1px rgba(236,72,153,0.08);
  transition: transform .12s ease, background .12s ease, border-color .12s ease;
}
.pin-dot.filled{
  background: rgba(20,184,166,0.95);
  border-color: rgba(20,184,166,0.95);
  transform: scale(1.08);
}
.pin-key{
  width: 64px; height: 64px;
  border-radius: 999px;
  background: rgba(255,255,255,0.75);
  border: 1px solid rgba(148,163,184,0.25);
  box-shadow: 0 10px 25px rgba(0,0,0,0.06);
  font-weight: 900;
  font-size: 1.35rem;
  color: #0f172a;
  display: grid;
  place-items: center;
  transition: transform .08s ease, filter .12s ease;
}
.pin-key:active{ transform: scale(0.96); filter: brightness(0.97); }
.pin-key-icon{ font-size: 1rem; color: #64748b; }
        .pin-spacer{ width: 64px; height: 64px; }


/* --- NEW (Index04): Instax Mini Polaroids --- */
.instax-card{
  background: white;
  border-radius: 10px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  border: 1px solid rgba(226,232,240,0.9);
  padding: 8px 8px 12px 8px;
  transform: rotate(0.5deg);
  transition: transform 0.2s;
  cursor: pointer;
}
.instax-card:active{ transform: scale(0.98); }
.instax-photo{
  width: 100%;
  aspect-ratio: 54 / 54;
  border-radius: 6px;
  object-fit: cover;
  background: #ffffff;
}
.instax-meta{
  margin-top: 8px;
  padding: 8px 8px 6px 8px;
  border-top: 1px solid rgba(226,232,240,0.9);
}
.instax-note{
  font-family: 'Caveat', cursive;
  font-size: 18px;
  color: #334155;
  line-height: 1.1;
  white-space: pre-wrap;
}
.instax-sub{
  margin-top: 4px;
  font-size: 9px;
  font-weight: 800;
  text-transform: uppercase;
  color: #94a3b8;
  letter-spacing: 0.12em;
}



/* --- FUNZONE: Eins oder Zwei (Wheel) --- */
.one-two-wheel-wrap{ position: relative; width: 220px; height: 220px; }
.one-two-wheel{
  width: 220px; height: 220px; border-radius: 999px;
  background: conic-gradient(#FF80AB 0deg 180deg, #14B8A6 180deg 360deg);
  border: 8px solid rgba(255,255,255,0.95);
  box-shadow: 0 18px 40px rgba(0,0,0,0.12), inset 0 0 30px rgba(0,0,0,0.05);
  transition: transform 2200ms cubic-bezier(0.22, 1, 0.36, 1);
  will-change: transform;
}
.one-two-wheel::after{
  content:"";
  position:absolute;
  inset: 18px;
  border-radius: 999px;
  border: 2px dashed rgba(255,255,255,0.7);
  pointer-events:none;
}
.one-two-pointer{
  position:absolute;
  top: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 14px solid transparent;
  border-right: 14px solid transparent;
  border-top: 22px solid white;
  filter: drop-shadow(0 6px 6px rgba(0,0,0,0.18));
}
.one-two-wheel-label{
  position:absolute;
  inset: 0;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding: 0 18px;
  font-weight: 900;
  color: rgba(255,255,255,0.95);
  text-shadow: 0 2px 8px rgba(0,0,0,0.25);
  pointer-events:none;
}
.one-two-wheel-label span{
  width: 46px;
  height: 46px;
  display:grid;
  place-items:center;
  border-radius: 999px;
  background: rgba(0,0,0,0.12);
  backdrop-filter: blur(3px);
}

</style>
</head>
<body class="theme-original min-h-screen flex flex-col items-center select-none transition-colors duration-500">

    <div id="heart-container" class="fixed inset-0 pointer-events-none z-0 overflow-hidden"></div>

    <div class="hanging-spider">
        <svg viewBox="0 0 100 200" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="50" y1="0" x2="50" y2="150" stroke="white" stroke-width="1.5" />
            <circle cx="50" cy="160" r="10" fill="#b71c1c" stroke="white" stroke-width="2"/>
            <path d="M40 160 Q30 150 25 165 M40 160 Q30 170 25 180 M60 160 Q70 150 75 165 M60 160 Q70 170 75 180" stroke="#b71c1c" stroke-width="2" fill="none"/>
            <circle cx="47" cy="162" r="2" fill="white"/>
            <circle cx="53" cy="162" r="2" fill="white"/>
        </svg>
    </div>

    <div id="login-screen" class="w-full max-w-md px-8 flex flex-col justify-start min-h-screen pt-20 pb-10 relative overflow-hidden z-10">
        <div class="mint-card p-12 text-center relative z-10 bg-white/95 backdrop-blur-xl border-t-8 border-pink-400 shadow-2xl animate-scale-in">
            <div class="mb-10">
                <div class="flex items-center justify-center gap-3 mb-3">
                    <div class="w-4 h-4 border-2 border-pink-500 border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-pink-500 font-black text-xs uppercase tracking-[0.3em] animate-pulse">System Loading</p>
                </div>
                <h1 class="text-4xl font-black text-teal-800 tracking-tighter">MerSam OS</h1>
                <p class="text-[10px] text-gray-400 font-bold uppercase mt-2">Valentinstag '26 - Special Build</p>
            </div>
            
            <div id="auth-stage" class="mt-10">
            <div id="user-selection" class="space-y-4">
                <p class="text-xs font-bold text-gray-500 uppercase mb-4">Profil ausw√§hlen</p>
                <button onclick="playSound('click'); startAuth('Meriam')" class="pink-btn w-full py-6 rounded-3xl font-black text-xl shadow-lg transition-all">Meriam</button>
                <button onclick="playSound('click'); startAuth('Samet')" class="teal-btn w-full py-6 rounded-3xl font-black text-xl shadow-lg transition-all">Samet</button>
            </div>

            <div id="pin-area" class="hidden animate-fade-in">
  <p id="pin-msg" class="text-xs font-bold text-gray-500 mb-6 uppercase">PIN erforderlich</p>

  <div class="flex justify-center gap-4 mb-8" aria-label="PIN Eingabe">
    <span class="pin-dot" data-pin-dot="0"></span>
    <span class="pin-dot" data-pin-dot="1"></span>
    <span class="pin-dot" data-pin-dot="2"></span>
    <span class="pin-dot" data-pin-dot="3"></span>
  </div>

  <div class="grid grid-cols-3 gap-4 justify-items-center">
    <button class="pin-key" onclick="pinPress('1')">1</button>
    <button class="pin-key" onclick="pinPress('2')">2</button>
    <button class="pin-key" onclick="pinPress('3')">3</button>

    <button class="pin-key" onclick="pinPress('4')">4</button>
    <button class="pin-key" onclick="pinPress('5')">5</button>
    <button class="pin-key" onclick="pinPress('6')">6</button>

    <button class="pin-key" onclick="pinPress('7')">7</button>
    <button class="pin-key" onclick="pinPress('8')">8</button>
    <button class="pin-key" onclick="pinPress('9')">9</button>
    <div class="pin-spacer" aria-hidden="true"></div>

<button class="pin-key" onclick="pinPress('0')">0</button>

    <button class="pin-key pin-key-icon" onclick="pinBackspace()" aria-label="L√∂schen">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 6H9.5a2 2 0 0 0-1.6.8L4 12l3.9 5.2a2 2 0 0 0 1.6.8H20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        <path d="M15 9l-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M9 9l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>

  <button onclick="pinForgot()" class="mt-8 text-[10px] text-gray-400 underline uppercase font-bold">PIN vergessen?</button>
  <button onclick="playSound('click'); location.reload()" class="text-[10px] text-gray-400 mt-4 underline uppercase font-bold">Abbrechen</button>
</div>
            </div>
        </div>
        <footer class="text-center mt-12 relative z-10">
            <p class="text-[9px] text-teal-900 font-black uppercase tracking-widest leading-loose opacity-70">
                Coded, Assembled & Designed by <br>
                <span class="text-teal-500 text-xs">Samet</span> f√ºr <span class="text-pink-500 text-xs">Meriam</span>
            </p>
        </footer>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="mint-card p-6 w-full max-w-sm relative shadow-2xl border-2 border-gray-200 animate-scale-in">
            <h3 class="text-xl font-black text-gray-700 mb-4">Einstellungen ‚öôÔ∏è</h3>
            
            <p class="text-xs font-bold text-gray-400 uppercase mb-2">Hintergrund Design</p>
            <div class="flex gap-3 mb-6 justify-center flex-wrap">
                <div onclick="setTheme('theme-original')" class="theme-circle bg-gradient-to-br from-pink-100 to-teal-100 shadow-md"></div>
                <div onclick="setTheme('theme-midnight')" class="theme-circle bg-slate-800 shadow-md"></div>
                <div onclick="setTheme('theme-spiderman')" class="theme-circle bg-gradient-to-br from-blue-700 to-red-700 shadow-md border-2 border-white relative overflow-hidden"><div class="absolute inset-0 opacity-30 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMCIgaGVpZ2h0PSIxMCI+PGNpcmNsZSBjeD0iNSIgY3k9IjUiIHI9IjEiIGZpbGw9IndoaXRlIi8+PC9zdmc+')]"></div></div>
                <div onclick="setTheme('theme-sunset')" class="theme-circle bg-orange-200 shadow-md"></div>
                <div onclick="setTheme('theme-fresh')" class="theme-circle bg-green-100 shadow-md"></div>
            </div>

            <p class="text-xs font-bold text-gray-400 uppercase mb-2">App Sounds</p>
            <div class="flex justify-between items-center mb-6 p-3 bg-gray-50 rounded-xl">
                <span class="text-sm font-bold text-gray-600">Sound Effekte</span>
                <label class="switch"><input type="checkbox" id="sound-toggle" onchange="toggleSound(this)"><span class="slider"></span></label>
            </div>

            <button onclick="localStorage.clear(); location.reload()" class="w-full text-xs text-red-400 font-bold border border-red-200 p-3 rounded-xl mb-2 hover:bg-red-50">‚ö†Ô∏è App Daten zur√ºcksetzen</button>
            <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="w-full bg-gray-200 text-gray-600 font-bold p-3 rounded-xl text-xs uppercase mt-2">Schlie√üen</button>
        </div>
    </div>

    <div id="view-memory-modal" class="hidden fixed inset-0 bg-black/80 z-[210] flex items-center justify-center p-6 backdrop-blur-md transition-opacity">
        <div class="relative w-full max-w-sm animate-scale-in">
            <button onclick="document.getElementById('view-memory-modal').classList.add('hidden')" class="absolute -top-10 right-0 text-white text-3xl font-bold">√ó</button>
            <div class="bg-white p-2 rounded-2xl shadow-2xl rotate-1">
                <img id="view-img" class="w-full rounded-xl object-cover max-h-[60vh] bg-gray-100">
                
                <button id="view-prev" class="hidden absolute left-3 top-1/2 -translate-y-1/2 bg-black/40 text-white w-10 h-10 rounded-full text-2xl font-black flex items-center justify-center backdrop-blur-sm">‚Äπ</button>
                <button id="view-next" class="hidden absolute right-3 top-1/2 -translate-y-1/2 bg-black/40 text-white w-10 h-10 rounded-full text-2xl font-black flex items-center justify-center backdrop-blur-sm">‚Ä∫</button>
<div class="p-6 text-center">
                    <h3 id="view-title" class="font-black text-2xl text-gray-800 mb-1 font-['Caveat']"></h3>
                    <p id="view-date" class="text-[10px] uppercase font-bold text-gray-400 mb-4"></p>
                    <div id="view-dots" class="hidden flex justify-center gap-2 mb-4"></div>
                    <p id="view-note" class="text-sm text-gray-600 italic font-medium leading-relaxed"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="memory-modal" class="hidden fixed inset-0 bg-black/50 z-[150] flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <div class="mint-card p-6 w-full max-w-sm relative shadow-2xl border-2 border-teal-100 animate-scale-in">
            <h3 class="text-xl font-black text-teal-800 mb-2">Gedanken zum Date üì∏</h3>
            <p class="text-xs text-gray-500 mb-4 font-medium">Halte den Moment fest!</p>
            <div class="space-y-3">
                <label class="block w-full p-4 bg-teal-50 rounded-xl border border-dashed border-teal-300 text-center cursor-pointer hover:bg-teal-100 transition-colors relative">
                    <span id="upload-text" class="text-xs font-bold text-teal-600 uppercase tracking-widest">üì∏ Foto hinzuf√ºgen</span>
                    <input id="memory-photo-file" type="file" accept="image/*" multiple class="hidden" onchange="handleMemoryFilesUpload(this)">
                </label>
                <img id="preview-image" class="hidden w-full h-32 object-cover rounded-xl mt-2 border border-teal-100 shadow-sm animate-fade-in">
                
                <div id="memory-thumbs" class="hidden flex gap-2 mt-2">
                    <!-- thumbs injected by JS -->
                </div>
<textarea id="memory-note" placeholder="Schreibe einen Kommentar..." class="w-full p-4 bg-teal-50 rounded-xl outline-none text-sm h-24 resize-none border border-transparent focus:border-teal-300 transition-all"></textarea>
            </div>
            <div class="mt-6 space-y-2">
                <button id="btn-save-memory" onclick="playSound('success')" class="pink-btn w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg text-xs">Speichern / Kommentieren</button>
                <button onclick="closeMemoryModal()" class="text-[10px] text-gray-400 font-bold uppercase w-full py-2 hover:text-gray-600">Abbrechen</button>
            </div>
        </div>
    </div>
    <!-- NEW (Index04): Polaroid Upload Modal -->
    <div id="polaroid-modal" class="hidden fixed inset-0 bg-black/50 z-[180] flex items-start justify-center p-4 backdrop-blur-sm transition-opacity duration-300 overflow-y-auto">
        <div class="mint-card p-6 w-full max-w-sm relative shadow-2xl border-2 border-pink-100 animate-scale-in my-8">
            <h3 class="text-xl font-black text-pink-600 mb-1">Instax Mini Polaroid üì∑</h3>
            <p class="text-[10px] text-gray-500 mb-4 font-bold uppercase tracking-widest">Scan / Upload</p>

            <label class="block w-full p-4 bg-teal-50 rounded-xl border border-dashed border-teal-300 text-center cursor-pointer hover:bg-teal-100 transition-colors relative">
                <span id="polaroid-upload-text" class="text-xs font-bold text-teal-600 uppercase tracking-widest">üì∏ Foto ausw√§hlen</span>
                <input id="polaroid-file" type="file" accept="image/*" class="hidden">
            </label>

            <div id="polaroid-crop-area" class="hidden mt-4">
                <div class="bg-white rounded-2xl p-4 border border-gray-100 shadow-inner">
                    <canvas id="polaroid-crop-canvas" width="260" height="360" class="w-full rounded-xl bg-gray-50"></canvas>
                    <div class="mt-3">
                        <p class="text-[9px] font-black text-gray-400 uppercase mb-1 tracking-widest">Zoom</p>
                        <input id="polaroid-zoom" type="range" min="0.2" max="3" step="0.01" value="1" class="w-full">
                        <p class="text-[9px] text-gray-400 mt-2">Ziehe das Bild im Rahmen, um es auszurichten.</p>
                    </div>
                </div>

                <div class="mt-4 space-y-2 text-sm">
                    <input id="polaroid-date" type="date" class="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none text-center text-gray-700">
                    <input id="polaroid-location" type="text" placeholder="üìç Ort" class="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none text-sm">
                    <textarea id="polaroid-note" placeholder="Notiz (wie auf dem wei√üen Rand)..." class="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none text-sm h-20 resize-none font-['Caveat'] text-[18px] leading-snug"></textarea>
                </div>
            </div>

            <div class="mt-5 space-y-2">
                <button id="btn-save-polaroid" class="pink-btn w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg text-xs">Speichern</button>
                <button id="btn-cancel-polaroid" class="text-[10px] text-gray-400 font-bold uppercase w-full py-2 hover:text-gray-600">Abbrechen</button>
            </div>
        </div>
    </div>


    <div id="milestone-modal" class="hidden fixed inset-0 bg-black/50 z-[160] flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
        <div class="mint-card p-6 w-full max-w-sm relative shadow-2xl border-2 border-teal-100 animate-scale-in my-8">
            <h3 id="modal-title" class="text-xl font-black text-teal-800 mb-2">Eintrag bearbeiten ‚úèÔ∏è</h3>
            <input type="hidden" id="ms-id">
            <div class="space-y-2 text-sm">
                <input id="ms-title" type="text" placeholder="Titel / Was?" class="w-full p-3 bg-teal-50 rounded-xl outline-none">
                <input id="ms-location" type="text" placeholder="üìç Ort" class="w-full p-3 bg-teal-50 rounded-xl outline-none" data-original-location="">
                <input id="ms-info" type="text" placeholder="üí° Insider-Info" class="w-full p-3 bg-teal-50 rounded-xl outline-none">
                <div class="flex gap-2">
                    <select id="ms-cat" class="flex-1 bg-teal-50 p-2 rounded-xl outline-none text-xs"><option value="Sofort">‚ö° Spontan</option><option value="Planung">üìÖ Planung</option></select>
                    <select id="ms-weather" class="flex-1 bg-teal-50 p-2 rounded-xl outline-none text-xs"><option value="Egal">‚òÅÔ∏è Egal</option><option value="Sonne">‚òÄÔ∏è Sonne</option><option value="Regen">üè† Regen</option></select>
                </div>
                <div id="ms-memory-fields">
                    <p class="text-[10px] font-bold text-gray-400 mt-2 uppercase">Wann war das?</p>
                    <input id="ms-date" type="datetime-local" class="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none text-center">
                    <p class="text-[10px] font-bold text-gray-400 mt-2 uppercase">Bewertungen (1-10)</p>
                    <div class="flex gap-2">
                        <div class="flex-1"><label class="text-[9px] font-bold text-pink-400 uppercase">Meriam</label><input id="ms-rating-m" type="number" min="1" max="10" class="w-full p-2 bg-pink-50 rounded-lg text-center outline-none border border-pink-100"></div>
                        <div class="flex-1"><label class="text-[9px] font-bold text-teal-400 uppercase">Samet</label><input id="ms-rating-s" type="number" min="1" max="10" class="w-full p-2 bg-teal-50 rounded-lg text-center outline-none border border-teal-100"></div>
                    </div>
                    <label class="block w-full p-3 bg-teal-50 rounded-xl border border-dashed border-teal-300 text-center cursor-pointer hover:bg-teal-100 transition-colors relative mt-3">
                        <span id="ms-upload-text" class="text-xs font-bold text-teal-600 uppercase tracking-widest">üì∏ Fotos hinzuf√ºgen (max 3)</span>
                        <input id="ms-photo-file" type="file" accept="image/*" multiple class="hidden" onchange="handleMilestonePhotoUpload(this)">
                    </label>
                    <img id="ms-preview-image" class="hidden w-full h-24 object-cover rounded-xl mt-2 border border-teal-100 shadow-sm">
                    <div id="ms-photo-thumbs" class="hidden flex gap-2 mt-2"></div>
                    <button id="ms-manage-toggle" type="button" class="hidden mt-2 w-full py-2 rounded-xl border border-teal-200 bg-white/70 text-teal-700 font-semibold">Fotos bearbeiten</button>
                    <div id="ms-photo-hint" class="hidden text-[11px] text-teal-500 mt-1">Tippe ein Mini-Foto an, um es als Thumbnail (Karte & Zeitreise) zu w√§hlen.</div>
                    <textarea id="ms-note" placeholder="Notiz..." class="w-full p-3 bg-teal-50 rounded-xl outline-none h-20 resize-none mt-2"></textarea>
                </div>
            </div>
            <div class="mt-6 space-y-2">
                <button onclick="saveMilestone(); playSound('success')" class="teal-btn w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg text-xs">Speichern</button>
                <button onclick="document.getElementById('milestone-modal').classList.add('hidden')" class="text-[10px] text-gray-400 font-bold uppercase w-full py-2 hover:text-gray-600">Abbrechen</button>
            </div>
        </div>
    </div>

    <div id="countdown-modal" class="hidden fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="mint-card p-6 w-full max-w-sm relative shadow-2xl border-2 border-pink-100 animate-scale-in my-8">
            <h3 class="text-xl font-black text-pink-600 mb-4">Countdown setzen ‚è≥</h3>
            <input id="new-cd-title" type="text" placeholder="Ereignis (z.B. Urlaub üå¥)" class="w-full p-3 bg-pink-50 rounded-xl mb-2 outline-none text-sm font-bold text-gray-700">
            <input id="new-cd-date" type="datetime-local" class="w-full p-3 bg-white border border-gray-200 rounded-xl mb-4 outline-none text-sm text-center text-gray-700">
            <button id="btn-save-countdown" onclick="playSound('success')" type="button" class="pink-btn w-full py-3 rounded-xl font-black uppercase tracking-widest text-xs">Starten</button>
            <button onclick="playSound('click'); document.getElementById('countdown-modal').classList.add('hidden')" class="text-[10px] text-gray-400 font-bold uppercase w-full py-2 mt-2 hover:text-gray-600">Abbrechen</button>
        </div>
    </div>

    <div id="reward-modal" class="hidden fixed inset-0 bg-black/60 z-[250] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="mint-card p-8 w-full max-w-sm relative shadow-2xl border-4 border-yellow-300 bg-gradient-to-br from-yellow-50 to-white text-center pop-in">
            <div class="text-6xl mb-4 animate-bounce">üéÅ</div>
            <h3 class="text-2xl font-black text-yellow-600 mb-2 tracking-tight">Belohnung!</h3>
            <p class="text-xs text-gray-500 font-bold uppercase mb-6">F√ºr mehr Quality Time & Verw√∂hnmomente!</p>
            <div class="bg-white p-6 rounded-2xl border-2 border-dashed border-yellow-200 mb-6 shadow-inner animate-fade-in">
                <p id="reward-text" class="text-lg font-black text-teal-800 leading-relaxed"></p>
            </div>
            <button onclick="playSound('reveal'); document.getElementById('reward-modal').classList.add('hidden')" class="bg-yellow-400 text-white w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg text-xs hover:bg-yellow-500 transition-colors">Einl√∂sen & Reset üîÑ</button>
        </div>
    </div>

    <div id="main-dashboard" class="hidden w-full max-w-md p-4 relative z-10">
        <header class="flex flex-col mb-8 mt-2 px-2 animate-fade-in-down">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h1 class="text-3xl font-black text-teal-800 tracking-tighter drop-shadow-sm">MerSam OS <span class="text-pink-400 text-lg">v3.9</span></h1>
                    <p id="user-greeting" class="text-xs text-teal-600 font-bold uppercase tracking-widest mt-1"></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="openSettings()" class="bg-white/80 backdrop-blur-sm border border-gray-200 text-gray-400 hover:text-teal-600 p-3 rounded-2xl transition-all shadow-sm active:scale-95">‚öôÔ∏è</button>
                    <button id="btn-logout" class="bg-white/80 backdrop-blur-sm border border-pink-100 text-pink-400 hover:text-pink-600 hover:bg-pink-50 p-3 rounded-2xl transition-all shadow-sm active:scale-95" title="Abmelden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    </button>
                </div>
            </div>
            <div class="flex flex-wrap gap-2 justify-center items-center mt-2">
                <button onclick="editSystemStart();" id="uptime-display" class="bg-white/60 backdrop-blur-md border border-teal-100 text-[10px] text-teal-600 font-bold uppercase tracking-wider px-3 py-1.5 rounded-full shadow-sm hover:bg-white transition-all flex items-center gap-2">
                    <span class="animate-pulse text-teal-400 text-xs">‚óè</span> System Uptime: Laden...
                </button>
                <div class="bg-white/60 backdrop-blur-md border border-pink-100 text-[10px] text-gray-500 font-bold px-3 py-1.5 rounded-full shadow-sm flex items-center gap-2">
                    <span id="partner-status" class="online-indicator offline"></span>
                    <span id="partner-last-seen">Suche Partner...</span>
                </div>
            </div>
        </header>

        <div id="tab-home" class="animate-fade-in">
            <div id="countdown-card" class="mint-card p-6 mb-6 bg-gradient-to-r from-pink-50 to-teal-50 border-none shadow-md relative overflow-hidden hidden animate-scale-in">
                <div class="absolute top-2 right-2 flex gap-2 z-20">
                    <button onclick="editCountdown()" class="text-gray-400 hover:text-teal-500 p-2 bg-white/80 rounded-full shadow-sm transition-colors active:scale-95" title="Bearbeiten">‚úèÔ∏è</button>
                    <button onclick="deleteCountdown()" class="text-gray-400 hover:text-red-500 p-2 bg-white/80 rounded-full shadow-sm transition-colors active:scale-95" title="L√∂schen">üóëÔ∏è</button>
                </div>
                <p class="text-center text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">N√§chstes Highlight</p>
                <h3 id="countdown-title" class="text-center text-xl font-black text-gray-800 mb-3 tracking-tight truncate px-4"></h3>
                <div class="flex justify-center gap-4 text-center">
                    <div class="bg-white/60 rounded-lg p-2 min-w-[50px]"><span id="cd-days" class="block text-2xl font-black text-pink-500 leading-none">0</span><span class="text-[7px] uppercase font-bold text-gray-400">Tage</span></div>
                    <div class="bg-white/60 rounded-lg p-2 min-w-[50px]"><span id="cd-hours" class="block text-2xl font-black text-teal-500 leading-none">0</span><span class="text-[7px] uppercase font-bold text-gray-400">Std</span></div>
                    <div class="bg-white/60 rounded-lg p-2 min-w-[50px]"><span id="cd-min" class="block text-2xl font-black text-indigo-500 leading-none">0</span><span class="text-[7px] uppercase font-bold text-gray-400">Min</span></div>
                </div>
            </div>
            <div id="countdown-placeholder" class="mb-6 text-center hidden animate-fade-in">
                <button onclick="openCountdownModal()" class="w-full text-[10px] font-bold text-gray-400 border-2 border-dashed border-gray-200 px-6 py-6 rounded-2xl uppercase tracking-widest hover:bg-white hover:border-pink-300 hover:text-pink-400 transition-all flex flex-col items-center justify-center gap-2">
                    <span class="text-2xl opacity-50">‚ûï</span> <span>Countdown hinzuf√ºgen</span>
                </button>
            </div>
            <div class="mint-card p-2 mb-6 grid grid-cols-3 gap-0 divide-x divide-teal-50 shadow-sm border-b-4 border-teal-200 animate-slide-up">
                <div class="stat-card"><p class="stat-title">Date-Serie</p><p id="stat-streak" class="stat-val text-pink-500">0</p><p class="stat-label">Wochen</p><p id="streak-info" class="streak-status italic text-[7px] leading-tight mt-1"></p></div>
                <div class="stat-card"><p class="stat-title">Ideen-Duell</p><p id="stat-vs" class="stat-val text-teal-600">0:0</p><p id="vs-label" class="stat-label text-[7px]">Ich vs Partner</p></div>
                <div class="stat-card"><p class="stat-title">Erf√ºllt</p><p id="stat-progress" class="stat-val text-indigo-500">0%</p><p class="stat-label">Der W√ºnsche</p></div>
            </div>
            <div id="reward-card" class="mint-card p-4 mb-6 border-l-4 border-yellow-300 bg-gradient-to-r from-yellow-50 to-white shadow-sm flex items-center justify-between animate-slide-up" style="animation-delay: 0.1s;">
                <div class="flex-1">
                    <p class="text-[9px] font-black text-yellow-600 uppercase tracking-widest mb-1">N√§chstes Level üèÜ</p>
                    <div class="w-full bg-gray-100 rounded-full h-2.5 mb-1 overflow-hidden"><div id="reward-progress-bar" class="bg-yellow-400 h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                    <p id="reward-progress-text" class="text-[9px] font-bold text-gray-400">0 / 5 Dates bis zur Belohnung</p>
                </div>
                <div class="ml-4"><button id="btn-claim-reward" onclick="playSound('reveal'); claimReward()" class="text-3xl filter grayscale opacity-50 transition-all transform hover:scale-110 active:scale-95 disabled:cursor-not-allowed" disabled>üéÅ</button></div>
            </div>
            <div class="bg-yellow-100 border-l-8 border-yellow-400 p-4 mb-8 rounded-r-2xl shadow-sm relative rotate-1 animate-slide-up" style="animation-delay: 0.2s;">
                <p id="love-letter-title" class="text-[10px] font-black text-yellow-600 uppercase tracking-widest mb-1">Post-it</p>
                <p id="love-letter-display" class="text-sm text-yellow-800 italic font-medium">Laden...</p>
                <div class="flex justify-between items-center mt-3 gap-2">
                    
                    <input id="love-letter-input" type="text" placeholder="Hinterlasse eine Nachricht..." class="bg-white/50 text-xs p-2 rounded-lg border-none outline-none flex-1 italic">
                    <button id="btn-send-letter" onclick="playSound('success')" class="bg-yellow-400 text-white p-2 rounded-lg text-xs font-bold uppercase">Senden</button>
                </div>
            </div>
            <div class="mint-card p-6 mb-6 animate-slide-up" style="animation-delay: 0.3s;">
                <h3 class="font-black text-teal-800 mb-4 uppercase text-xs tracking-widest">F√ºge eine Date-Idee hinzu ‚ú®</h3>
                <div class="flex gap-2 mb-3 items-center">
                    <textarea id="wish-input" rows="1" placeholder="Was machen wir?" class="flex-1 p-4 bg-teal-50 rounded-xl outline-none text-lg" style="resize:none; overflow:hidden; min-height:56px; max-height:220px;"></textarea>
                    <button id="btn-ai-wish" onclick="playSound('pop')" class="sparkle-btn h-14 w-14 rounded-xl shadow-lg flex items-center justify-center text-xl active:scale-95" title="Idee generieren">‚ú®</button>
                </div>
                <input id="location-input" type="text" placeholder="üìç Wo? (F√ºr die Karte)" class="w-full p-3 bg-white border border-teal-100 rounded-xl mb-2 outline-none text-sm">
                <input id="info-input" type="text" placeholder="üí° Insider-Info?" class="w-full p-3 bg-white border border-teal-100 rounded-xl mb-4 outline-none text-sm italic">
                <div class="flex gap-2 mb-6">
                    <select id="cat-select" class="flex-1 filter-select"><option value="Sofort">‚ö° Spontan?</option><option value="Planung">üìÖ Planung</option></select>
                    <select id="weather-select" class="flex-1 filter-select"><option value="Egal">‚òÅÔ∏è Wetter egal?</option><option value="Sonne">‚òÄÔ∏è Sonne</option><option value="Regen">üè† Regen</option></select>
                </div>
                <div class="flex justify-between items-center px-2 mb-6">
                    <span class="text-[10px] font-bold text-gray-400 uppercase">Geheim? ü§´ <label class="switch"><input type="checkbox" id="surprise-toggle"><span class="slider"></span></label></span>
                    <span class="text-[10px] font-bold text-yellow-600 uppercase">In die Bucket List legen? <label class="switch"><input type="checkbox" id="bucket-toggle"><span class="slider"></span></label></span>
                </div>
                <button id="btn-add" onclick="playSound('success')" class="pink-btn w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg">Hinzuf√ºgen</button>
            </div>
            <div class="mint-card p-8 mb-6 text-center bg-gradient-to-b from-white to-teal-50 animate-slide-up" style="animation-delay: 0.4s;">
                <h3 class="font-black text-teal-800 mb-4 uppercase text-xs tracking-widest">üé≤ Zufallsgenerator Date Maker</h3>
                <div class="flex gap-2 mb-6 justify-center text-[10px] font-bold">
                    <select id="filter-cat" class="flex-1 filter-select"><option value="Alle">F√ºr alle Optionen offen?</option><option value="Sofort">‚ö° Spontan</option><option value="Planung">üìÖ Planung</option></select>
                    <select id="filter-weather" class="flex-1 filter-select"><option value="Alle">Wetter egal?</option><option value="Sonne">‚òÄÔ∏è Sonne</option><option value="Regen">üè† Regen</option></select>
                </div>
                <div class="relative overflow-hidden rounded-3xl p-4">
                    <div id="flash-layer" class="flash-overlay"></div>
                    <div id="dice-container" class="transition-all duration-500 py-6">
                        <div class="scene"><div id="cube-3d" class="cube"><div class="cube__face cube__face--1"><div class="face-grid"><div class="dot d-center"></div></div></div><div class="cube__face cube__face--2"><div class="face-grid"><div class="dot d-tl"></div><div class="dot d-br"></div></div></div><div class="cube__face cube__face--3"><div class="face-grid"><div class="dot d-tl"></div><div class="dot d-center"></div><div class="dot d-br"></div></div></div><div class="cube__face cube__face--4"><div class="face-grid"><div class="dot d-tl"></div><div class="dot d-tr"></div><div class="dot d-bl"></div><div class="dot d-br"></div></div></div><div class="cube__face cube__face--5"><div class="face-grid"><div class="dot d-tl"></div><div class="dot d-tr"></div><div class="dot d-center"></div><div class="dot d-bl"></div><div class="dot d-br"></div></div></div><div class="cube__face cube__face--6"><div class="face-grid"><div class="dot d-tl"></div><div class="dot d-tr"></div><div class="dot d-ml"></div><div class="dot d-mr"></div><div class="dot d-bl"></div><div class="dot d-br"></div></div></div></div></div>
                    </div>
                    <div id="lock-screen" class="hidden flex flex-col items-center justify-center py-8">
                        <svg class="lock-svg" viewBox="0 0 100 120"><path id="lock-shackle-path" class="lock-shackle" d="M25,50 V25 A25,25 0 0,1 75,25 V50" /><rect id="lock-body-rect" class="lock-body" x="15" y="50" width="70" height="60" rx="10" /><circle cx="50" cy="80" r="6" fill="white" opacity="0.5"/><rect x="48" y="80" width="4" height="15" fill="white" opacity="0.5"/></svg>
                        <p id="lock-text" class="text-pink-500 font-black text-xs mt-6 tracking-[0.2em] uppercase">Secret Locked</p>
                    </div>
                </div>
                <div id="result-box" class="mt-2 hidden">
                    <div id="unfold-wrapper">
                        <p class="text-[10px] uppercase text-gray-400 mb-1 tracking-widest font-bold">Euer Schicksal:</p>
                        <h2 id="final-choice" class="text-2xl font-bold text-pink-600 mb-1 leading-tight"></h2>
                        <p id="final-info" class="text-sm text-gray-600 mb-4 italic"></p>
                        <div id="map-container" class="hidden mb-6 rounded-3xl overflow-hidden border-4 border-white shadow-sm"><iframe id="map-frame" width="100%" height="180" frameborder="0" style="border:0"></iframe></div>
                        <div id="result-info" class="mb-6 flex flex-col items-center justify-center"><span id="result-creator-badge" class="user-badge mb-2"></span><div id="result-labels" class="flex justify-center gap-2"></div></div>
                        <div class="flex flex-col gap-3">
                            <button id="btn-accept-date-only-main" onclick="playSound('success')" class="w-full bg-teal-500 text-white py-4 rounded-2xl font-bold uppercase text-[11px] shadow-lg">Date annehmen ‚úì</button>
                            <div id="challenge-section" class="border-t border-pink-50 pt-4">
                                <div id="challenge-btn-container"><button id="btn-show-challenge" onclick="playSound('pop')" class="text-[10px] font-bold text-pink-500 border-2 border-pink-200 px-8 py-2 rounded-full uppercase tracking-widest hover:bg-pink-50 transition-colors">‚ú® Bonus-Challenge? ‚ú®</button></div>
                                <div id="challenge-display" class="hidden mt-2 p-6 bg-gradient-to-br from-pink-50 to-white rounded-3xl border-2 border-pink-100 shadow-inner">
                                    <p id="challenge-text" class="text-pink-700 font-bold italic mb-6 text-base leading-relaxed"></p>
                                    <div class="flex flex-col gap-3"><button id="btn-accept-both" onclick="playSound('success')" class="w-full pink-btn py-4 rounded-2xl font-bold uppercase text-[11px] shadow-lg">Date & Challenge annehmen</button><button id="btn-accept-date-only-sub" onclick="playSound('click')" class="w-full text-gray-400 font-bold text-[9px] uppercase py-2">Nur Date annehmen</button><button id="btn-reroll-challenge" class="text-[9px] text-pink-400 font-bold uppercase mt-2 tracking-widest hover:text-pink-600 transition-colors">‚Üª Andere Challenge</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="btn-roll" onclick="playSound('click')" class="mt-6 bg-teal-700 text-white px-12 py-5 rounded-full font-bold shadow-xl w-full active:scale-95 uppercase tracking-widest">W√úRFELN</button>
            </div>
            <h3 class="font-black text-teal-800 mb-4 px-2 text-sm uppercase tracking-widest text-center italic animate-fade-in" style="animation-delay: 0.5s;">Unsere Ideen üí°</h3>
            <div id="wish-list" class="space-y-4 mb-10"></div>
            <div class="flex items-center justify-between px-2 mb-4">
                <h3 class="font-bold text-gray-400 text-sm uppercase tracking-widest italic text-center flex-1">Unsere Zeitreise üèÜ</h3>
                <button onclick="playSound('pop'); openMilestoneModal('add', null, 'archive')" class="text-xs bg-pink-100 text-pink-500 px-3 py-1 rounded-lg font-bold hover:bg-pink-200 transition-colors shadow-sm">+</button>
            </div>
            <div id="archive-list" class="space-y-0 pb-20"></div>
        </div>

        <div id="tab-map" class="hidden pb-20 animate-fade-in">
            <h2 class="text-2xl font-bold text-teal-700 mb-4 text-center mt-2">Unsere Welt üåç</h2>
            <p class="text-center text-[10px] text-gray-400 mb-4">Wo wir schon √ºberall unsere Spuren hinterlassen haben.</p>
            <div id="map" class="shadow-xl"></div>
        </div>

        <div id="tab-gallery" class="hidden pb-20 animate-fade-in">
            <h2 class="text-2xl font-bold text-pink-600 mb-2 text-center mt-2">Erinnerungen üì∏</h2>
            <p class="text-center text-[10px] text-gray-400 mb-4">Unsere sch√∂nsten Momente</p>

            <!-- NEW (Index04): Galerie Unterteilung -->
            <div class="flex justify-center gap-2 mb-5 px-2">
                <button id="btn-gallery-dates" class="px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/80 border border-gray-200 text-gray-700 shadow-sm active:scale-95">Dates</button>
                <button id="btn-gallery-polaroids" class="px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/60 border border-gray-200 text-gray-500 shadow-sm active:scale-95">Polaroids</button>
            </div>

            <!-- Dates (bestehend) -->
            <div id="gallery-grid" class="grid grid-cols-2 gap-4 px-2"></div>

            <!-- Polaroids (neu) -->
            <div id="polaroid-pane" class="hidden px-2">
                <button id="btn-open-polaroid" class="w-full mb-4 pink-btn py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg text-xs">‚ûï Polaroid hochladen</button>
                <div id="polaroid-grid" class="grid grid-cols-2 gap-4"></div>
            </div>
        </div>

        <div id="tab-bucket" class="hidden pb-20 animate-fade-in">
            <div class="flex items-center justify-center relative mb-2">
                <h2 class="text-2xl font-bold text-yellow-600 text-center">Bucket List ‚ú®</h2>
                <button onclick="playSound('pop'); openMilestoneModal('add', null, 'bucket')" class="absolute right-2 text-xs bg-yellow-100 text-yellow-600 px-3 py-1 rounded-lg font-bold hover:bg-yellow-200 transition-colors shadow-sm">+ Neu</button>
            </div>
            <p class="text-center text-[10px] text-gray-500 mb-6 italic px-6 leading-relaxed">Unsere gro√üen Lebenstr√§ume: Ob Bungee-Jumping, Weltreisen oder verr√ºckte Abenteuer ‚Äì hier sammeln wir alles, was wir in diesem Leben unbedingt noch gemeinsam erleben wollen! üåç‚úàÔ∏èüöÄ</p>
            <div id="bucket-list-content" class="space-y-4"></div>
        </div>

        <div id="tab-fun" class="hidden pb-20 animate-fade-in">

            <!-- FUNZONE: Eins oder Zwei -->
            <div class="mint-card p-6 mb-6 animate-slide-up">
                <h3 class="font-black text-teal-800 mb-2 uppercase text-xs tracking-widest text-center">Eins oder Zwei? üé°</h3>
                <p class="text-center text-[10px] text-gray-500 mb-5 italic px-2 leading-relaxed">
                    Tragt zwei Optionen ein ‚Äì dann wird zuf√§llig ausgelost.
                </p>

                <div class="space-y-3">
                    <input id="one-two-opt1" type="text" placeholder="1Ô∏è‚É£ Option 1 (z.B. Eis essen üç¶)" class="w-full p-3 bg-teal-50 rounded-xl outline-none text-sm font-bold text-gray-700">
                    <input id="one-two-opt2" type="text" placeholder="2Ô∏è‚É£ Option 2 (z.B. Zuhause bleiben üè†)" class="w-full p-3 bg-teal-50 rounded-xl outline-none text-sm font-bold text-gray-700">
                </div>

                <div class="mt-6 flex flex-col items-center">
                    <div class="one-two-wheel-wrap my-4">
                        <div id="one-two-wheel" class="one-two-wheel relative"></div>
                        <div class="one-two-wheel-label">
                            <span>1</span>
                            <span>2</span>
                        </div>
                        <div class="one-two-pointer" aria-hidden="true"></div>
                    </div>

                    <button id="btn-one-two-spin" class="teal-btn w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg text-xs">Auslosen</button>
                    <p id="one-two-result" class="mt-4 text-center text-sm font-bold text-gray-700"></p>
                </div>
            </div>

            <div class="mint-card p-8 mb-6 text-center animate-slide-up">
                <h3 class="font-black text-indigo-600 mb-4 uppercase text-xs tracking-widest">üó£Ô∏è Deep Talk</h3>
                <p class="text-[10px] text-gray-400 mb-6">Keine Lust auf Smalltalk? Lass uns tiefer gehen.</p>
                <div id="deeptalk-chips" class="text-left mb-5">
                    <p class="text-[10px] text-gray-500 mb-2 font-bold uppercase tracking-widest text-center">Chips</p>

                    <!-- Kategorien -->
                    <div class="mb-4">
                        <p class="text-[10px] text-gray-500 mb-2 font-bold uppercase tracking-widest">Kategorien</p>
                        <div class="flex flex-wrap gap-2 justify-center">
                            <button type="button" class="dt-chip px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-cat="Alltag & N√§he">Alltag</button>
                            <button type="button" class="dt-chip px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-cat="Werte & Moral">Werte</button>
                            <button type="button" class="dt-chip px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-cat="Grenzen & Respekt">Grenzen</button>
                            <button type="button" class="dt-chip px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-cat="Intimit√§t (emotional)">Intimit√§t</button>
                            <button type="button" class="dt-chip px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-cat="Humor & Leichtigkeit">Humor</button>
                            <button type="button" class="dt-chip px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-cat="Konflikte & Kommunikation">Konflikte</button>
                            <button type="button" class="dt-chip px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-cat="Familie & Freundschaft">Familie</button>
                            <button type="button" class="dt-chip px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-cat="Geld & Lebensstil">Geld</button>
                            <button type="button" class="dt-chip px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-cat="Spiritualit√§t & Glaube (inkl. Islam)">Glaube</button>
                            <button type="button" class="dt-chip px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-cat="Identit√§t & Pers√∂nlichkeit">Ich</button>
                            <button type="button" class="dt-chip px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-cat="Vergangenheit">Vergangenheit</button>
                            <button type="button" class="dt-chip px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-cat="Zukunft">Zukunft</button>
                        </div>
                    </div>

                    <!-- Mood -->
                    <div class="mb-4">
                        <p class="text-[10px] text-gray-500 mb-2 font-bold uppercase tracking-widest">Stimmung</p>
                        <div class="flex flex-wrap gap-2 justify-center">
                            <button type="button" class="dt-mood px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-mood="Sanft & liebevoll">Sanft</button>
                            <button type="button" class="dt-mood px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-mood="Tief & reflektiert">Tief</button>
                            <button type="button" class="dt-mood px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-mood="Spielerisch & witzig">Spielerisch</button>
                            <button type="button" class="dt-mood px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-mood="Direkt & ehrlich (ohne verletzend zu sein)">Direkt</button>
                            <button type="button" class="dt-mood px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/70 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95" data-dt-mood="Romantisch & verbindend">Romantisch</button>
                        </div>
                    </div>

                    <!-- Custom -->
                    <div class="mb-2">
                        <p class="text-[10px] text-gray-500 mb-2 font-bold uppercase tracking-widest">Eigene Chips</p>
                        <div class="flex gap-2">
                            <input id="dt-custom-input" type="text" placeholder="z.B. Eifersucht, Ramadan, Social Media‚Ä¶" class="flex-1 px-4 py-3 rounded-2xl border border-indigo-100 bg-white/80 text-[12px] shadow-inner focus:outline-none focus:ring-2 focus:ring-indigo-200" />
                            <button id="btn-dt-add-custom" type="button" class="bg-indigo-500 text-white px-4 py-3 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-md active:scale-95">+</button>
                        </div>
                        <div id="dt-custom-list" class="flex flex-wrap gap-2 mt-3 justify-center"></div>
                    </div>
                </div>

                <div id="deeptalk-container" class="bg-indigo-50 p-6 rounded-2xl mb-6 hidden border border-indigo-100 shadow-inner">
                    <p id="deeptalk-question" class="text-lg font-bold text-indigo-900 italic leading-relaxed"></p>
                </div>
                <button id="btn-deeptalk" onclick="playSound('deep-reveal')" class="bg-indigo-500 text-white px-8 py-3 rounded-2xl font-bold uppercase text-[10px] tracking-widest shadow-md hover:bg-indigo-600 transition-colors w-full">‚ú® Neues Thema</button>
            </div>
            <div class="mint-card p-6 mb-6 text-center animate-slide-up">
                <h3 class="font-black text-red-600 mb-2 uppercase text-xs tracking-widest">üé¨ Netflix Diplomat</h3>
                <p class="text-[10px] text-gray-400 mb-4">Film-Streit? Ich finde den perfekten Kompromiss!</p>
                <div class="space-y-3 mb-4">
                    <div class="relative"><span class="absolute left-3 top-3 text-xs">üë©</span><input id="movie-pref-meriam" type="text" placeholder="Worauf hat Meriam Lust?" class="w-full pl-8 p-3 bg-red-50 rounded-xl outline-none text-xs border border-red-100 placeholder-red-300 text-red-900 font-medium"></div>
                    <div class="relative"><span class="absolute left-3 top-3 text-xs">üë®</span><input id="movie-pref-samet" type="text" placeholder="Worauf hat Samet Lust?" class="w-full pl-8 p-3 bg-gray-50 rounded-xl outline-none text-xs border border-gray-200 placeholder-gray-400 text-gray-800 font-medium"></div>
                </div>
                <button id="btn-movie-diplomat" onclick="playSound('netflix-pop')" class="bg-red-600 text-white w-full py-3 rounded-xl font-bold uppercase text-[10px] tracking-widest shadow-md active:scale-95 transition-all hover:bg-red-700">üçø Film finden</button>
                <div id="movie-result" class="hidden mt-4 text-left bg-white border border-red-100 rounded-xl p-4 shadow-inner relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div><p class="text-[9px] font-black text-gray-400 uppercase mb-2">Die Vorschl√§ge der Jury:</p><div id="movie-text" class="text-xs text-gray-700 leading-relaxed whitespace-pre-line"></div>
                </div>
            </div>
            <div class="mint-card p-8 mb-6 text-center animate-slide-up" style="animation-delay: 0.1s;">
                <h3 class="font-bold text-teal-800 mb-4 uppercase text-xs tracking-widest font-black">üé° Entscheidungs-Roulette</h3>
                <p class="text-[10px] text-gray-400 mb-6">Wer kocht? Wer w√§hlt den Film? Das Schicksal entscheidet!</p>
                <div id="roulette-result" class="text-3xl font-black text-teal-600 mb-8 h-12 flex items-center justify-center bg-teal-50 rounded-2xl shadow-inner border border-teal-100">?</div>
                <button id="btn-spin-roulette" class="teal-btn px-12 py-4 rounded-2xl font-bold uppercase tracking-widest text-xs shadow-md">Spin Roulette</button>
            </div>
            
            <div class="mint-card p-6 animate-slide-up" style="animation-delay: 0.2s;">
                <h3 class="font-bold text-pink-600 mb-4 uppercase text-xs tracking-widest">‚ùì Quiz-Arena</h3>

                <!-- NEW (Index04V8+): Quiz Arena v2 (A/B/C + Timer + Reveal) -->
                <div id="quiz2-wrap">

                    <!-- Create -->
                    <div class="border-b pb-4 mb-4">
                        <p class="text-[9px] font-bold text-gray-400 uppercase mb-2">Neue Frage erstellen:</p>
                        <input id="quiz2-q" type="text" placeholder="Deine Frage..." class="w-full p-3 bg-pink-50 rounded-xl mb-2 outline-none text-sm">
                        <input id="quiz2-a" type="text" placeholder="A: Option..." class="w-full p-3 bg-pink-50 rounded-xl mb-2 outline-none text-sm">
                        <input id="quiz2-b" type="text" placeholder="B: Option..." class="w-full p-3 bg-pink-50 rounded-xl mb-2 outline-none text-sm">
                        <input id="quiz2-c" type="text" placeholder="C: Option..." class="w-full p-3 bg-pink-50 rounded-xl mb-3 outline-none text-sm">

                        <div class="flex items-center justify-between gap-3 mb-3">
                            <p class="text-[9px] font-bold text-gray-400 uppercase">Richtige Antwort:</p>
                            <div class="flex gap-2">
                                <label class="quiz2-chip"><input type="radio" name="quiz2-correct" value="A" checked> A</label>
                                <label class="quiz2-chip"><input type="radio" name="quiz2-correct" value="B"> B</label>
                                <label class="quiz2-chip"><input type="radio" name="quiz2-correct" value="C"> C</label>
                            </div>
                        </div>

                        <button id="btn-quiz2-add" onclick="playSound('success')" class="pink-btn w-full py-2 rounded-xl font-bold text-xs uppercase">Speichern</button>
                        <p id="quiz2-create-hint" class="text-[10px] text-gray-400 mt-2 hidden"></p>
                    </div>

                    <!-- Open / Answered list -->
                    <div class="mb-4">
                        <p class="text-[9px] font-bold text-gray-400 uppercase mb-2">Offen / Beantwortet:</p>
                        <div id="quiz2-list-open" class="space-y-3"></div>
                    </div>

                    <!-- Done list -->
                    <div class="mb-4">
                        <p class="text-[9px] font-bold text-gray-400 uppercase mb-2">Erledigt (abgehakt):</p>
                        <div id="quiz2-list-done" class="space-y-3"></div>
                    </div>

                    <!-- Play / Reveal -->
                    <div id="quiz2-play" class="hidden text-center">
                        <div class="bg-white/70 border border-pink-100 rounded-2xl p-4 shadow-sm">
                            <p class="text-[9px] uppercase font-bold text-gray-400 mb-2">Frage von <span id="quiz2-by"></span></p>
                            <p id="quiz2-question" class="text-lg font-black leading-tight text-gray-800">?</p>

                            <div class="mt-4 flex items-center justify-center gap-3">
                                <div class="quiz2-timer-ring">
                                    <span id="quiz2-timer" class="text-[10px] font-black text-pink-600">10</span>
                                </div>
                                <p id="quiz2-status" class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Du hast 10 Sekunden.</p>
                            </div>

                            <div class="mt-4 grid grid-cols-1 gap-2">
                                <button id="quiz2-btn-A" class="quiz2-ans-btn" data-choice="A"><span class="quiz2-badge">A</span><span id="quiz2-text-A" class="quiz2-ans-text">...</span></button>
                                <button id="quiz2-btn-B" class="quiz2-ans-btn" data-choice="B"><span class="quiz2-badge">B</span><span id="quiz2-text-B" class="quiz2-ans-text">...</span></button>
                                <button id="quiz2-btn-C" class="quiz2-ans-btn" data-choice="C"><span class="quiz2-badge">C</span><span id="quiz2-text-C" class="quiz2-ans-text">...</span></button>
                            </div>

                            <div class="mt-4">
                                <p id="quiz2-result" class="text-[11px] font-black text-gray-700"></p>
                                <p id="quiz2-result-sub" class="text-[10px] text-gray-400 mt-1"></p>
                            </div>

                            <button id="btn-quiz2-check" class="mt-4 teal-btn w-full py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-md hidden">‚úÖ Abhaken</button>
                            <button id="btn-quiz2-back" class="text-[10px] text-gray-400 font-bold uppercase mt-4 underline">Zur√ºck</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <nav class="nav-bar hidden shadow-2xl" id="app-nav">
        <button onclick="switchTab('home')" class="nav-item active" id="nav-home"><span class="text-xl mb-1">üè†</span><span>Home</span></button>
        <button onclick="switchTab('gallery')" class="nav-item" id="nav-gallery"><span class="text-xl mb-1">üì∏</span><span>Galerie</span></button>
        <button onclick="switchTab('map')" class="nav-item" id="nav-map"><span class="text-xl mb-1">üåç</span><span>Karte</span></button>
        <button onclick="switchTab('bucket')" class="nav-item" id="nav-bucket"><span class="text-xl mb-1">‚ú®</span><span>Bucket</span></button>
        <button onclick="switchTab('fun')" class="nav-item" id="nav-fun"><span class="text-xl mb-1">üé°</span><span>Fun</span></button>
    </nav>

    <script type="module">
    // Safety: ensure playSound exists so onclick handlers don't break login.
    window.playSound = window.playSound || function(){ /* no-op */ };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, set, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        
        const firebaseConfig = { apiKey: "AIzaSyCKF4yb7X6XDt5PSTMwiXmn0y7j9aTVMjc", authDomain: "date-decision-maker.firebaseapp.com", databaseURL: "https://date-decision-maker-default-rtdb.europe-west1.firebasedatabase.app", projectId: "date-decision-maker", storageBucket: "date-decision-maker.firebasestorage.app", messagingSenderId: "187389563873", appId: "1:187389563873:web:4fa5fea6a44c42e18078a0", measurementId: "G-LKDJCYHYQW" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);


        // --- SOUND & SETTINGS ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false'; 
        let currentTheme = localStorage.getItem('theme') || 'theme-original';

        document.body.className = currentTheme + " min-h-screen flex flex-col items-center select-none transition-colors duration-500";
        document.getElementById('sound-toggle').checked = soundEnabled;

        // --- SMOOTH UI HELPERS (nur Animationen) ---
        const smoothPopIn = (el) => {
            if (!el) return;
            el.classList.remove('hidden');
            el.classList.remove('ui-enter', 'ui-enter-active', 'ui-exit-active');
            el.classList.add('ui-enter');
            requestAnimationFrame(() => {
                el.classList.add('ui-enter-active');
                el.classList.remove('ui-enter');
            });
            const done = (e) => {
                if (e && e.target !== el) return;
                el.classList.remove('ui-enter-active');
                el.removeEventListener('transitionend', done);
            };
            el.addEventListener('transitionend', done);
        };

        const smoothHide = (el) => {
            if (!el || el.classList.contains('hidden')) return;
            el.classList.remove('ui-enter', 'ui-enter-active');
            el.classList.add('ui-exit-active');

            // Fallback, falls transitionend nicht feuert
            const fallback = setTimeout(() => {
                el.classList.add('hidden');
                el.classList.remove('ui-exit-active');
                el.removeEventListener('transitionend', done);
            }, 160);

            const done = (e) => {
                if (e && e.target !== el) return;
                clearTimeout(fallback);
                el.classList.add('hidden');
                el.classList.remove('ui-exit-active');
                el.removeEventListener('transitionend', done);
            };
            el.addEventListener('transitionend', done);
        };
        // run after layout settles (prevents auth-stage height = 0 on first paint)


        const pulseInput = (el) => {
            if (!el) return;
            el.classList.remove('input-pop');
            void el.offsetWidth;
            el.classList.add('input-pop');
        };

const autoResizeField = (el) => {
            if (!el) return;
            // Reset then grow/shrink to content
            el.style.height = 'auto';
            const max = parseInt(getComputedStyle(el).maxHeight || '220', 10) || 220;
            const next = Math.min(el.scrollHeight, max);
            el.style.height = next + 'px';
            el.style.overflowY = (el.scrollHeight > max) ? 'auto' : 'hidden';
        };

        // Auto-resize for Date-Idee field (wish-input)
        const wishInputEl = document.getElementById('wish-input');
        if (wishInputEl) {
            autoResizeField(wishInputEl);
            wishInputEl.addEventListener('input', () => autoResizeField(wishInputEl));
        }


        // SPIDEY RANDOM EVENT (Swarm)
        const spiderSVGStr = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 40 C 50 30 60 30 60 40 C 60 50 50 50 50 40" fill="black" /><circle cx="55" cy="40" r="8" fill="black" /><path d="M55 40 Q 30 20 20 30 M55 40 Q 80 20 90 30 M55 40 Q 20 40 10 50 M55 40 Q 90 40 100 50 M55 40 Q 30 60 20 50 M55 40 Q 80 60 90 50 M55 40 Q 40 70 30 80 M55 40 Q 70 70 80 80" stroke="black" stroke-width="3" fill="none" /></svg>`;
        const spawnSpiderSwarm = () => {
            if (currentTheme !== 'theme-spiderman') return;
            if(Math.random() > 0.7 && soundEnabled) playSound('click'); 
            const count = Math.floor(Math.random() * 3) + 2; 
            for(let i=0; i<count; i++) {
                const spider = document.createElement('div');
                spider.className = "spawned-spider";
                spider.innerHTML = spiderSVGStr;
                document.body.appendChild(spider);
                const edge = ['top', 'bottom', 'left', 'right'][Math.floor(Math.random() * 4)];
                const duration = 1.2 + Math.random() * 0.5;
                const delay = Math.random() * 0.5;
                spider.style.animation = `peek${edge.charAt(0).toUpperCase() + edge.slice(1)}Anim ${duration}s ease-in-out ${delay}s forwards`;
                if(edge === 'top' || edge === 'bottom') {
                    spider.style.left = (Math.random() * 90 + 5) + "vw";
                    if(edge==='top') spider.style.transform = 'rotate(180deg)';
                } else {
                    spider.style.top = (Math.random() * 90 + 5) + "vh";
                    if(edge==='left') spider.style.transform = 'rotate(90deg)'; else spider.style.transform = 'rotate(-90deg)';
                }
                setTimeout(() => { spider.remove(); }, 2000);
            }
        };
        setInterval(() => { if(Math.random() > 0.5) spawnSpiderSwarm(); }, 8000);

        window.openSettings = () => { document.getElementById('settings-modal').classList.remove('hidden'); };
        window.toggleSound = (el) => { soundEnabled = el.checked; localStorage.setItem('soundEnabled', soundEnabled); };
        window.setTheme = (theme) => { 
            document.body.className = theme + " min-h-screen flex flex-col items-center select-none transition-colors duration-500"; 
            localStorage.setItem('theme', theme); 
            currentTheme = theme;
        };

        window.playSound = function(type) {
            if (!soundEnabled) return;
            if (audioCtx.state === 'suspended') { try { audioCtx.resume(); } catch(e){} }

            const now = audioCtx.currentTime;

            // helper: short noise burst
            const noiseBurst = (duration = 0.08, gainVal = 0.03, hp = 800) => {
                const bufferSize = Math.max(1, Math.floor(audioCtx.sampleRate * duration));
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * (1 - i / bufferSize);

                const src = audioCtx.createBufferSource();
                src.buffer = buffer;

                const filter = audioCtx.createBiquadFilter();
                filter.type = "highpass";
                filter.frequency.setValueAtTime(hp, now);

                const g = audioCtx.createGain();
                g.gain.setValueAtTime(gainVal, now);
                g.gain.exponentialRampToValueAtTime(0.0001, now + duration);

                src.connect(filter);
                filter.connect(g);
                g.connect(audioCtx.destination);

                src.start(now);
                src.stop(now + duration);
            };

            // helper: simple tone blip
            const tone = (freqA, freqB, dur = 0.12, gainVal = 0.05, typeOsc = "sine") => {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.type = typeOsc;

                osc.frequency.setValueAtTime(freqA, now);
                if (freqB) osc.frequency.exponentialRampToValueAtTime(freqB, now + dur);

                g.gain.setValueAtTime(gainVal, now);
                g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

                osc.connect(g);
                g.connect(audioCtx.destination);

                osc.start(now);
                osc.stop(now + dur);
            };

            // keep everything subtle (nicht nervig)
            switch(type){
                case 'click':      // UI Tap
                    tone(520, 180, 0.06, 0.045, "sine");
                    break;

                case 'pop':        // small UI pop (marker, modal)
                    tone(240, 520, 0.10, 0.040, "triangle");
                    noiseBurst(0.04, 0.012, 1200);
                    break;

                case 'success':    // confirm
                    tone(660, 990, 0.14, 0.050, "sine");
                    break;

                case 'reveal':     // reveal / mission
                    tone(220, 880, 0.22, 0.040, "sawtooth");
                    noiseBurst(0.12, 0.010, 700);
                    break;

                case 'lock':       // little metallic clink
                    tone(780, 260, 0.10, 0.030, "square");
                    tone(1200, 600, 0.08, 0.018, "triangle");
                    break;

                case 'dice':       // quick dice roll impression
                    noiseBurst(0.18, 0.018, 500);
                    tone(180, 140, 0.12, 0.020, "triangle");
                    break;

                case 'idea':       // gentle sparkle
                    tone(880, 1320, 0.10, 0.030, "sine");
                    tone(1320, 1760, 0.10, 0.015, "sine");
                    break;

                case 'photo':      // photo open (soft pop + shimmer)
                    tone(320, 980, 0.16, 0.035, "triangle");
                    noiseBurst(0.06, 0.010, 900);
                    break;

                case 'deep-reveal': // deep talk reveal (warmer whoosh)
                    tone(180, 720, 0.28, 0.035, "sawtooth");
                    noiseBurst(0.14, 0.010, 500);
                    break;

                case 'netflix-pop': // movie pick (snappy double blip)
                    tone(520, 1040, 0.10, 0.040, "square");
                    tone(780, 520, 0.08, 0.020, "triangle");
                    break;

                case 'roulette':   // roulette / spinner (tiny roll)
                    noiseBurst(0.22, 0.014, 650);
                    tone(220, 160, 0.18, 0.018, "triangle");
                    break;

                case 'photo':      // soft camera-ish pop
                    tone(320, 640, 0.08, 0.030, "triangle");
                    noiseBurst(0.05, 0.008, 1800);
                    break;

                default:
                    // fail-safe: very soft click
                    tone(420, 220, 0.05, 0.020, "sine");
            }
        };// --- AI CONFIGURATION (MerSam OS v3.9 - OpenAI via Firebase Function) ---
const AI_ENDPOINT = "https://us-central1-date-decision-maker.cloudfunctions.net/testOpenAI";

async function callAI(prompt) {
  const r = await fetch(AI_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  if (!r.ok) {
    const t = await r.text();
    console.error("AI error:", r.status, t);
    return null;
  }

  const data = await r.json();
  return data.text || null;
}



        // --- MAP LOGIC ---
        let map;
        let markers = [];
        let markerClusterGroup; 

        window.initMap = function() { 
            if (map) return;
            map = L.map('map').setView([51.1657, 10.4515], 6); 
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors ¬© <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);
        }

        async function getCoordinates(location) {
            // Schneller: Cache + Timeout (damit Map nicht "wartet")
            try {
                const cacheKey = `geo:${location}`.toLowerCase();
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    const obj = JSON.parse(cached);
                    if (obj && typeof obj.lat === 'number' && typeof obj.lon === 'number') return obj;
                }
            } catch (_) {}

            try {
                const controller = new AbortController();
                const t = setTimeout(() => controller.abort(), 1500); // max ~1.5s warten
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`,
                    { signal: controller.signal }
                );
                clearTimeout(t);
                const data = await response.json();
                if (data && data.length > 0) {
                    const coords = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                    try { localStorage.setItem(`geo:${location}`.toLowerCase(), JSON.stringify(coords)); } catch (_) {}
                    return coords;
                }
            } catch (e) {
                // Timeout/Netzwerkfehler => ok, wir skippen und versuchen ggf. sp√§ter neu
                console.warn("Geocoding skipped/timeout", e);
            }
            return null;
        }

        function loadMapMarkers() {
            if (!map) initMap();
            if (markerClusterGroup) map.removeLayer(markerClusterGroup);
            
            markerClusterGroup = L.markerClusterGroup({
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                spiderfyOnMaxZoom: true,
                animate: true
            });

            markers = [];

            onValue(ref(db, 'wishes'), (snapshot) => {
                // immer neu zeichnen, damit Thumbnail/Cover sofort auf der Karte aktualisiert wird
                try { markerClusterGroup && markerClusterGroup.clearLayers(); } catch(_) {}
                markers = [];
                const data = snapshot.val();
                if (!data) return;

                const bounds = [];
                const pending = [];
                const addMarkerForWish = (id, item, lat, lon, boundsArr) => {
                    const isPhoto = item.memoryPhoto ? true : false;
                    let borderColor = '#EC4899';
                    if (item.by === 'Samet') borderColor = '#14B8A6';
                    if (item.isBucket) borderColor = '#EAB308';

                    const customIcon = L.divIcon({
                        className: 'custom-map-marker-container',
                        html: isPhoto
                            ? `<img src="${item.memoryThumb || item.memoryPhoto}" class="map-photo-pin" style="outline-color: ${borderColor}">`
                            : `<div class="custom-map-marker" style="border-color: ${borderColor}; color: ${borderColor === '#EAB308' ? '#854d0e' : '#831843'}">${item.text}</div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    });

                    const marker = L.marker([lat, lon], { icon: customIcon });
                    marker.on('click', () => {
                        playSound('pop');
                        if (isPhoto) openMemoryView(id);
                        else openMilestoneModal('edit', id);
                    });
                    markerClusterGroup.addLayer(marker);
                    boundsArr.push([lat, lon]);
                };

                // 1) Alles mit Koordinaten sofort rendern (instant)
                for (const id in data) {
                    const item = data[id];
                    if (item.status === 'done' && item.location) {
                        const lat = item.lat;
                        const lon = item.lon;
                        if (lat && lon) {
                            addMarkerForWish(id, item, lat, lon, bounds);
                        } else {
                            // 2) Fehlende Koordinaten sp√§ter nachladen (ohne UI zu blockieren)
                            pending.push({ id, item });
                        }
                    }
                }

                map.addLayer(markerClusterGroup);
                if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });

                // 3) Geocoding parallel (limitiert) ‚Äì max ~1.5s pro Location
                if (pending.length) {
                    const hadInitialBounds = bounds.length > 0;
                    (async () => {
                        const CONCURRENCY = 3;
                        let cursor = 0;

                        const worker = async () => {
                            while (cursor < pending.length) {
                                const idx = cursor++;
                                const { id, item } = pending[idx];
                                const coords = await getCoordinates(item.location);
                                if (coords && coords.lat && coords.lon) {
                                    // DB updaten (wie vorher), Marker adden
                                    update(ref(db, `wishes/${id}`), { lat: coords.lat, lon: coords.lon });
                                    addMarkerForWish(id, item, coords.lat, coords.lon, bounds);
                                }
                            }
                        };

                        await Promise.all(
                            Array.from({ length: Math.min(CONCURRENCY, pending.length) }, () => worker())
                        );

                        // Wenn vorher gar nix da war, nach dem Nachladen einmal passend zoomen
                        if (!hadInitialBounds && bounds.length > 0) {
                            map.fitBounds(bounds, { padding: [50, 50] });
                        }
                    })();
                }
            }, { onlyOnce: true });
        }

        const backupWishes = ["Kochen zusammen üçù", "Picknick im Park üå≥", "Kinoabend daheim üçø", "Spaziergang am See üåä", "Neues Caf√© testen ‚òï", "Spieleabend üé≤", "Zusammen malen üé®", "Massageabend üíÜ", "Sternegucken ‚ú®"];
        const backupLoveNotes = ["Ich liebe dich sehr! ‚ù§Ô∏è", "Du bist mein Ein und Alles üí´", "Danke, dass es dich gibt! üåπ", "Du siehst heute toll aus! üòç"];
        const allChallenges = ["Handy-Verbot üìµ (30 min)", "Filmszene nachstellen üì∏", "Song summen & raten üéµ", "Kompliment fl√ºstern ü§´", "Akzent beim Bestellen üó£Ô∏è"];
        const rewardPool = ["üíÜ 20 Min. Massage", "üßñ‚Äç‚ôÄÔ∏è 10 Min. Kopfkraulen", "ü¶∂ 15 Min. Fu√ümassage", "ü•û Fr√ºhst√ºck ans Bett", "üçù Lieblingsessen wird gekocht", "üé¨ Film-Wahl ohne Veto", "üç´ Lieblings-Snack sofort besorgen"];

        let rolledDateId = null;
        let currentCompletingId = null;
        let currentPhotoBase64 = "";

        // --- NEW (Index04): POLAROID ENGINE (Instax Mini) ---
        let galleryMode = "dates"; // dates | polaroids

        // Polaroid crop state
        let polaroidImg = null;
        let polaroidImgW = 0, polaroidImgH = 0;
        let polaroidPanX = 0, polaroidPanY = 0;
        let polaroidZoom = 1;
        let polaroidDragging = false;
        let polaroidLast = { x: 0, y: 0 };

        let countdownTarget = null;
        let countdownTitle = "";
        let relationshipStart = null;
        let globalDoneCount = 0;
        let globalClaimedCount = 0;
        let currentEditingMilestoneId = null; 
        let currentModalMode = 'archive';

        const createHeart = () => {
            // SPIDEY-CHECK: Keine Herzen im Spiderman-Modus!
            if (currentTheme === 'theme-spiderman') return;
            
            const heart = document.createElement('div'); heart.innerHTML = "‚ù§"; heart.className = "floating-heart";
            heart.style.left = Math.random() * 100 + "vw"; heart.style.fontSize = (Math.random() * 20 + 10) + "px";
            const duration = Math.random() * 8 + 12;
            heart.style.animationDuration = duration + "s";
            document.getElementById('heart-container')?.appendChild(heart); 
            setTimeout(() => heart.remove(), duration * 1000);
        };
        setInterval(createHeart, 300);

        document.getElementById('btn-ai-wish').onclick = async () => {
            const btn = document.getElementById('btn-ai-wish');
            const input = document.getElementById('wish-input');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="animate-spin-slow">‚è≥</div>`; btn.disabled = true;
            
            const rawHistory = sessionStorage.getItem('lastDateIdeas');
            const lastDateIdeas = rawHistory ? (() => { try { return JSON.parse(rawHistory) || []; } catch { return []; } })() : [];
            const last3 = lastDateIdeas.slice(-3).filter(Boolean);
            const avoidText = last3.length ? last3.join(" | ") : "";

            // Rotate between "activity-only" ideas and "location-specific" ideas:
            // Every 5th idea may include a concrete city/spot; otherwise keep it general to avoid being too location-heavy.
            const _cnt = (parseInt(sessionStorage.getItem('dateIdeaCount') || "0", 10) || 0) + 1;
            sessionStorage.setItem('dateIdeaCount', String(_cnt));
            const includeLocation = (_cnt % 5 === 0);

            const locationRule = includeLocation
              ? `Nenne dabei eine konkrete Stadt/Ort (bevorzugt NRW: D√ºsseldorf, Wuppertal & Umgebung, K√∂ln, Dortmund, Essen, Bochum, M√ºnster, Bonn, Aachen etc.). Wenn nicht NRW, dann irgendwo in Deutschland.`
              : `KEINE konkreten Ortsnamen/St√§dte nennen. Fokus auf Aktivit√§t/Idee, die man √ºberall machen kann (du darfst "in eurer N√§he" sagen).`;

            const prompt = `Erstelle EINE Date-Idee f√ºr ein Paar. Sprache: Deutsch.
${locationRule}
Wichtig: JEDES Mal deutlich anders als zuvor ‚Äì keine Variationen derselben Grundidee.
Vermeide inhaltlich √§hnliche Ideen zu: "${avoidText}".
Vermeide Themenschleifen (z.B. wenn es einmal um Kochen ging, dann als N√§chstes NICHT wieder Kochen/Wein/Kochkurs).
Mische Kategorien (abwechselnd): Kultur (Museum/Kino/Show), Natur (Wald/Heide/Schlosspark), Aktiv (Klettern/Bowling/Trampolin), Cozy (Sternehimmel + Kakao, Spieleabend, DIY), Food (Caf√©/Streetfood/Markt), Wellness (Therme/Sauna), √úberraschung (Mini-Roadtrip), Kostenlos/Low Budget, Zuhause/Indoor, Stadtbummel/Hidden Spots.
Erlaubt sind auch klassische einfache Dates (Caf√©, Eisdiele, Spaziergang) ‚Äì aber variiere Hook/Spiel/Challenge.
Vermeide "Spaziergang am See" / "Picknick am See/Park" (nur sehr selten).
Format: 4‚Äì10 W√∂rter + 1 Emoji am Ende. Nur die Idee, kein Intro, kein Punkt.`;

            const idea = await callAI(prompt);
            input.value = idea ? idea.replace(/["']/g, "") : backupWishes[Math.floor(Math.random() * backupWishes.length)];
            // Remember last 3 ideas to avoid repetition
            const normalizedIdea = (input.value || "").trim();
            if (normalizedIdea) {
                const raw = sessionStorage.getItem('lastDateIdeas');
                let hist = [];
                try { hist = raw ? (JSON.parse(raw) || []) : []; } catch { hist = []; }
                hist.push(normalizedIdea);
                hist = hist.filter(Boolean).slice(-3);
                sessionStorage.setItem('lastDateIdeas', JSON.stringify(hist));
            }
            autoResizeField(input);
            pulseInput(input);
            playSound('idea');
            btn.innerHTML = originalText; btn.disabled = false;
        };


        async function generateChallenge() {
            const prompt = "Erstelle eine lustige, kleine 5-Minuten-Challenge f√ºr ein Paar, die man sofort machen kann. Max 1 Satz. Deutsch.";
            const challenge = await callAI(prompt);
            return challenge || allChallenges[Math.floor(Math.random() * allChallenges.length)];
        }

        document.getElementById('btn-show-challenge').onclick = async () => { 
            const textEl = document.getElementById('challenge-text');
            textEl.innerText = "Frage das Orakel... ‚ú®";
            document.getElementById('challenge-display').classList.remove('hidden'); 
            document.getElementById('challenge-btn-container').classList.add('hidden');
            playSound('pop');
            const challengeText = await generateChallenge();
            textEl.innerText = challengeText;
        };
        
        document.getElementById('btn-reroll-challenge').onclick = async () => {
            const textEl = document.getElementById('challenge-text');
            const btn = document.getElementById('btn-reroll-challenge');
            const originalText = btn.innerText;
            btn.innerText = "‚åõ Lade..."; btn.disabled = true; textEl.style.opacity = '0.5';
            playSound('click');
            const challengeText = await generateChallenge();
            textEl.innerText = challengeText;
            textEl.style.opacity = '1'; btn.innerText = originalText; btn.disabled = false;
        };

        
        // --- DEEP TALK: Chipsystem (Kategorien + Mood + Custom) ---
        const DT_LS_CATS = "deepTalkCatsV2";
        const DT_LS_MOOD = "deepTalkMoodV2";
        const DT_LS_CUSTOM = "deepTalkCustomV2";

        const dtState = {
            cats: new Set(),
            mood: "",
            custom: []
        };

        const dtApplyActive = (btn, active) => {
            if (!btn) return;
            if (active) {
                btn.classList.remove('bg-white/70', 'text-indigo-700', 'border-indigo-100');
                btn.classList.add('bg-indigo-500', 'text-white', 'border-indigo-500');
            } else {
                btn.classList.remove('bg-indigo-500', 'text-white', 'border-indigo-500');
                btn.classList.add('bg-white/70', 'text-indigo-700', 'border-indigo-100');
            }
        };

        const dtRenderCustom = () => {
            const box = document.getElementById('dt-custom-list');
            if (!box) return;
            box.innerHTML = "";
            dtState.custom.forEach((txt, idx) => {
                const b = document.createElement('button');
                b.type = "button";
                b.className = "px-3 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-indigo-50 border border-indigo-100 text-indigo-700 shadow-sm active:scale-95";
                b.innerHTML = `${txt} <span style="opacity:.6">√ó</span>`;
                b.onclick = () => {
                    playSound && playSound('click');
                    dtState.custom.splice(idx, 1);
                    dtPersist();
                    dtRenderCustom();
                };
                box.appendChild(b);
            });
        };

        const dtPersist = () => {
            try {
                localStorage.setItem(DT_LS_CATS, JSON.stringify(Array.from(dtState.cats)));
                localStorage.setItem(DT_LS_MOOD, dtState.mood || "");
                localStorage.setItem(DT_LS_CUSTOM, JSON.stringify(dtState.custom || []));
            } catch (e) {}
        };

        const dtRestore = () => {
            try {
                const cats = JSON.parse(localStorage.getItem(DT_LS_CATS) || "[]");
                const mood = localStorage.getItem(DT_LS_MOOD) || "";
                const custom = JSON.parse(localStorage.getItem(DT_LS_CUSTOM) || "[]");
                dtState.cats = new Set(Array.isArray(cats) ? cats : []);
                dtState.mood = (mood || "");
                dtState.custom = Array.isArray(custom) ? custom.slice(0, 12) : [];
            } catch (e) {}
        };

        const initDeepTalkChips = () => {
            const wrap = document.getElementById('deeptalk-chips');
            if (!wrap) return;

            dtRestore();

            // category chips
            const catBtns = wrap.querySelectorAll('[data-dt-cat]');
            catBtns.forEach((btn) => {
                const cat = btn.getAttribute('data-dt-cat');
                dtApplyActive(btn, dtState.cats.has(cat));
                btn.addEventListener('click', () => {
                    playSound && playSound('click');
                    if (dtState.cats.has(cat)) dtState.cats.delete(cat);
                    else dtState.cats.add(cat);
                    dtApplyActive(btn, dtState.cats.has(cat));
                    dtPersist();
                });
            });

            // mood (single select)
            const moodBtns = wrap.querySelectorAll('[data-dt-mood]');
            const setMood = (m) => {
                dtState.mood = m || "";
                moodBtns.forEach((b) => dtApplyActive(b, b.getAttribute('data-dt-mood') === dtState.mood));
                dtPersist();
            };
            moodBtns.forEach((btn) => {
                const m = btn.getAttribute('data-dt-mood');
                btn.addEventListener('click', () => {
                    playSound && playSound('click');
                    setMood(dtState.mood === m ? "" : m);
                });
            });
            if (dtState.mood) setMood(dtState.mood);

            // custom chips
            const input = document.getElementById('dt-custom-input');
            const addBtn = document.getElementById('btn-dt-add-custom');
            const addCustom = () => {
                const v = (input?.value || "").trim();
                if (!v) return;
                if (dtState.custom.map(x => x.toLowerCase()).includes(v.toLowerCase())) { input.value = ""; return; }
                dtState.custom.unshift(v);
                dtState.custom = dtState.custom.slice(0, 12);
                input.value = "";
                playSound && playSound('click');
                dtPersist();
                dtRenderCustom();
            };
            if (addBtn) addBtn.onclick = addCustom;
            if (input) input.addEventListener('keydown', (e) => {
                if (e.key === "Enter") { e.preventDefault(); addCustom(); }
            });
            dtRenderCustom();
        };


document.getElementById('btn-deeptalk').onclick = async () => {
            const qEl = document.getElementById('deeptalk-question');
            const container = document.getElementById('deeptalk-container');
            const btn = document.getElementById('btn-deeptalk');
            const originalText = btn.innerText;
            btn.innerText = "‚ú® Suche Thema..."; btn.disabled = true; container.classList.remove('hidden'); qEl.style.opacity = '0.5';
            playSound('deep-reveal');
            const history = JSON.parse(sessionStorage.getItem('deepTalkHistory') || "[]");
            const last3 = history.slice(-3);
            const topics = [
              "Alltag & N√§he",
              "Werte & Moral",
              "Grenzen & Respekt",
              "Intimit√§t (emotional)",
              "Humor & Leichtigkeit",
              "Konflikte & Kommunikation",
              "Familie & Freundschaft",
              "Geld & Lebensstil",
              "Spiritualit√§t & Glaube (inkl. Islam)",
              "Identit√§t & Pers√∂nlichkeit",
              "Vergangenheit",
              "Zukunft"
            ];

            const historyCats = Array.from(dtState?.cats || []);
            const mood = (dtState?.mood || "").trim();
            const customChips = Array.isArray(dtState?.custom) ? dtState.custom.filter(Boolean) : [];

            // Prim√§res Thema: aus ausgew√§hlten Kategorien, sonst random
            const lastTopic = sessionStorage.getItem('deepTalkLastTopic') || "";
            const pool = (historyCats.length ? historyCats : topics);

            let topic = pool[Math.floor(Math.random() * pool.length)];
            for (let i = 0; i < 14 && topic === lastTopic; i++) {
              topic = pool[Math.floor(Math.random() * pool.length)];
            }

            const prompt = `Erstelle EINE Deep‚ÄëTalk‚ÄëFrage f√ºr ein Paar. Sprache: Deutsch. 1‚Äì2 S√§tze, Alltagssprache.
Kategorie/Schwerpunkt: ${topic}.

Chips (falls vorhanden):
- Ausgew√§hlte Kategorien: ${historyCats.length ? historyCats.join(", ") : "(keine)"}
- Stimmung/Ton: ${mood || "(√ºberraschend/neutral)"}
- Eigene Chips: ${customChips.length ? customChips.join(", ") : "(keine)"}

Wichtig:
- Beziehe ausgew√§hlte Kategorien + eigene Chips sinnvoll ein, ohne sie plump aufzuz√§hlen.
- Ton soll zur Stimmung passen (falls gew√§hlt).
- Keine Therapeutensprache, keine Floskeln, keine generischen Standardfragen.
- Konkret, √ºberraschend, menschlich.

Die Frage darf ALLE Deep‚ÄëTalk‚ÄëThemen abdecken (z.B. Werte, Grenzen, Intimit√§t, Familie, Freundschaft, Geld, Eifersucht, Kommunikation, Tr√§ume, Humor, Konflikte, Spiritualit√§t/Religion ‚Äì inkl. Islam ‚Äì usw.).
Wichtig: NICHT nur Vergangenheit oder NICHT nur Zukunft. Wenn du ‚ÄûVergangenheit‚Äú oder ‚ÄûZukunft‚Äú w√§hlst, mach es trotzdem konkret und nicht klischeehaft. In allen anderen Kategorien bitte Fokus auf Gegenwart/Alltag/Charakter/Beziehung ‚Äì nicht auf ‚Äûfr√ºher‚Äú oder ‚Äûsp√§ter‚Äú.

Variation:
- Vermeide Wiederholung oder √§hnliche Fragen zu den letzten 3:
${last3.map(q => `- ${q}`).join("\n") || "- (keine)"}

Nur die Frage.`;

            const question = await callAI(prompt);
const clean = question ? question.replace(/["']/g, "").trim() : "Welche kleine Sache in unserem Alltag w√ºrde unsere Beziehung sofort leichter oder sch√∂ner machen ‚Äì und warum?";
            qEl.innerText = clean;
            // remember last 3 questions for variety
            try {
              const h = JSON.parse(sessionStorage.getItem('deepTalkHistory') || "[]");
              h.push(clean);
              sessionStorage.setItem('deepTalkHistory', JSON.stringify(h.slice(-3)));
            } catch (_) {
              sessionStorage.setItem('deepTalkHistory', JSON.stringify([clean]));
            }
            sessionStorage.setItem('lastDeepTalk', clean);
            sessionStorage.setItem('deepTalkLastTopic', topic);
            qEl.style.opacity = '1'; btn.innerText = originalText; btn.disabled = false;
        };

        window.claimReward = () => {
            const modal = document.getElementById('reward-modal');
            const textEl = document.getElementById('reward-text');
            const reward = rewardPool[Math.floor(Math.random() * rewardPool.length)];
            textEl.innerText = reward;
            set(ref(db, 'stats/claimedCount'), globalClaimedCount + 1);
            modal.classList.remove('hidden');
        };

        const updateRewardUI = (doneCount, claimedCount) => {
            const rewardBar = document.getElementById('reward-progress-bar');
            const rewardText = document.getElementById('reward-progress-text');
            const rewardBtn = document.getElementById('btn-claim-reward');
            const datesPerReward = 5;
            const targetForNextReward = (claimedCount + 1) * datesPerReward;
            const isClaimable = doneCount >= targetForNextReward;
            const currentBase = claimedCount * datesPerReward;
            let currentProgress = doneCount - currentBase;
            if (currentProgress > datesPerReward) currentProgress = datesPerReward;
            let progressPercent = (currentProgress / datesPerReward) * 100;

            rewardBar.style.width = `${progressPercent}%`;
            if (isClaimable) {
                rewardText.innerText = "üéâ 5 Dates geschafft! √ñffne mich!";
                rewardText.classList.add('text-pink-500', 'animate-pulse');
                rewardBtn.disabled = false; rewardBtn.classList.remove('grayscale', 'opacity-50'); rewardBtn.classList.add('chest-shake');
            } else {
                rewardText.innerText = `${currentProgress} / ${datesPerReward} Dates bis zur Belohnung`;
                rewardText.classList.remove('text-pink-500', 'animate-pulse');
                rewardBtn.disabled = true; rewardBtn.classList.add('grayscale', 'opacity-50'); rewardBtn.classList.remove('chest-shake');
            }
        };

        window.editSystemStart = () => {
            const date = prompt("Seit wann seid ihr zusammen? (Format: YYYY-MM-DD)", "2020-01-01");
            if (date) { const ts = new Date(date).getTime(); if (!isNaN(ts)) set(ref(db, 'systemStart'), ts); }
        };

        const updateUptime = () => {
            const display = document.getElementById('uptime-display');
            if (!relationshipStart) { display.innerText = "System Uptime: Startdatum setzen"; return; }
            const diff = Date.now() - relationshipStart;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            display.innerText = `System Uptime: ${days} Tage`;
        };
        setInterval(updateUptime, 3600000);

        // --- PIN AUTH (4-stellig) ---
const PIN_LEN = 4;
let activeAuthUser = null;
let expectedPin = null;
let pinBuffer = "";
let pinSetupMode = false;
let pinSetupFirst = null;

const setPinDots = () => {
  const dots = document.querySelectorAll('[data-pin-dot]');
  dots.forEach((d, i) => d.classList.toggle('filled', i < pinBuffer.length));
};

const resetPin = () => { pinBuffer = ""; setPinDots(); };

window.pinPress = (digit) => {
  playSound('click');
  if (!activeAuthUser) return;
  if (pinBuffer.length >= PIN_LEN) return;

  pinBuffer += String(digit);
  setPinDots();

  if (pinBuffer.length === PIN_LEN) {
    setTimeout(() => verifyPin(), 120);
  }
};

window.pinBackspace = () => {
  playSound('click');
  pinBuffer = pinBuffer.slice(0, -1);
  setPinDots();
};

window.pinForgot = () => {
  playSound('click');
  alert('PIN vergessen?\n\nOptionen:\n- Admin kann PIN in Firebase unter users/<Name>/pin √§ndern\n- oder PIN-Feld l√∂schen, dann wird beim n√§chsten Login eine neue PIN gesetzt.');
};

const verifyPin = async () => {
  // Setup: 2x eingeben
  if (pinSetupMode) {
    if (pinSetupFirst == null) {
      pinSetupFirst = pinBuffer;
      resetPin();
      document.getElementById('pin-msg').innerText = 'PIN nochmal eingeben:';
      return;
    }

    if (pinBuffer !== pinSetupFirst) {
      resetPin();
      pinSetupFirst = null;
      alert('PINs stimmen nicht √ºberein. Nochmal!');
      document.getElementById('pin-msg').innerText = 'W√§hle deine erste PIN:';
      return;
    }

    // speichern
    await set(ref(db, `users/${activeAuthUser}/pin`), pinBuffer);
    pinSetupMode = false;
    pinSetupFirst = null;
    login(activeAuthUser);
    return;
  }

  // Verify
  if (pinBuffer === expectedPin) {
    login(activeAuthUser);
  } else {
    const area = document.getElementById('pin-area');
    area.classList.add('lock-rattle');
    setTimeout(() => area.classList.remove('lock-rattle'), 220);
    alert('Falsche PIN!');
    resetPin();
  }
};

// ERSETZT Passwort-Auth: Profil -> PIN Screen
window.startAuth = async (user) => {
  const snap = await get(ref(db, `users/${user}`));
  const userData = snap.val() || {};

  activeAuthUser = user;
  expectedPin = userData.pin || null;

  // Greeting wie im Screenshot (falls vorhanden)
  const title = document.getElementById('auth-title') || document.getElementById('login-title') || null;
  if (title) title.innerText = `Guten Tag,\n${userData.displayName || user}`;

  smoothHide(document.getElementById('user-selection'));
  setTimeout(() => smoothPopIn(document.getElementById('pin-area')), 110);

  resetPin();

  if (!expectedPin) {
    pinSetupMode = true;
    pinSetupFirst = null;
    document.getElementById('pin-msg').innerText = 'W√§hle deine erste PIN:';
  } else {
    pinSetupMode = false;
    pinSetupFirst = null;
    document.getElementById('pin-msg').innerText = `${user}, gib deine PIN ein:`;
  }
};



        const login = (u) => { sessionStorage.setItem('currentUser', u); sessionStorage.setItem('lastActive', String(Date.now())); 

        // Smooth: Passwort-Eingabe f√ºhlt sich weniger "abgehackt" an
        const passEl = document.getElementById('pass-input');
        if (passEl) {
            passEl.classList.add('soft-typing');
            let typingTimer = null;
            passEl.addEventListener('input', () => {
                passEl.classList.add('is-typing');
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => passEl.classList.remove('is-typing'), 260);
            });
        }

bindPolaroidUIOnce();
        checkAuth(); };

        // --- Session / Auto-Logout (nur Auth, keine App-Logik) ---
        // 1) Tab/App schlie√üen => sessionStorage wird automatisch geleert (kein Auto-Login mehr)
        // 2) Zu lange inaktiv/weg => Auto-Logout nach IDLE_LIMIT_MS
        const IDLE_LIMIT_MS = 20 * 60 * 1000; // 20 Minuten

        const bumpActivity = () => {
            if (sessionStorage.getItem('currentUser')) {
                sessionStorage.setItem('lastActive', String(Date.now()));
            }
        };

        const enforceSessionTTL = () => {
            const u = sessionStorage.getItem('currentUser');
            if (!u) return;
            const last = parseInt(sessionStorage.getItem('lastActive') || "0", 10);
            if (!last) { sessionStorage.setItem('lastActive', String(Date.now())); return; }
            if (Date.now() - last > IDLE_LIMIT_MS) {
                sessionStorage.removeItem('currentUser');
                sessionStorage.removeItem('lastActive');
                location.reload();
            }
        };

        // Aktivit√§t tracken (leichtgewichtig)
        ['pointerdown','keydown','touchstart','scroll'].forEach(evt => window.addEventListener(evt, bumpActivity, { passive: true }));
        document.addEventListener('visibilitychange', () => {
            // Beim Zur√ºckkommen sofort pr√ºfen
            if (!document.hidden) enforceSessionTTL();
        });
        window.addEventListener('focus', enforceSessionTTL);
        // Reload/Navigation => wieder Passwort n√∂tig
        window.addEventListener('beforeunload', () => {
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('lastActive');
        });

        // -----------------------------------------------

        const checkAuth = () => { 
            enforceSessionTTL();
            const u = sessionStorage.getItem('currentUser'); 
            if(u) { 
                // Smooth: Login raus, Dashboard rein
                smoothHide(document.getElementById('login-screen'));
                smoothPopIn(document.getElementById('main-dashboard'));
                smoothPopIn(document.getElementById('app-nav')); 
                document.getElementById('user-greeting').innerText = `Hallo ${u}`; 
                startPresence(u); syncData(u); 
            } 
        };
        
        const startPresence = (u) => { 
            setInterval(() => update(ref(db, `presence/${u}`), { onlineAt: Date.now() }), 5000); 
            const partner = u === "Samet" ? "Meriam" : "Samet"; 
            onValue(ref(db, `presence/${partner}`), (s) => { 
                const data = s.val();
                const indicator = document.getElementById('partner-status');
                const lastSeenText = document.getElementById('partner-last-seen');
                if (!data || !data.onlineAt) { indicator.className = "online-indicator offline"; lastSeenText.innerText = `${partner} war noch nie hier`; return; }
                const isOnline = (Date.now() - data.onlineAt) < 15000; 
                indicator.className = "online-indicator " + (isOnline ? "online" : "offline");
                if (isOnline) { lastSeenText.innerText = `${partner} online`; lastSeenText.className = "text-[9px] font-bold text-green-500 transition-all"; }
                else { 
                    const date = new Date(data.onlineAt);
                    lastSeenText.innerText = `${partner} zuletzt: ${date.toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'})}`; 
                    lastSeenText.className = "text-[9px] text-gray-400 font-medium transition-all";
                }
            }); 
        };

        window.switchTab = (tab) => { 
            ['home', 'bucket', 'fun', 'map', 'gallery'].forEach(t => { 
                const el = document.getElementById(`tab-${t}`);
                if (!el.classList.contains('hidden')) { el.classList.add('hidden'); el.classList.remove('animate-fade-in'); }
                document.getElementById(`nav-${t}`).classList.remove('active'); 
            }); 
            const targetEl = document.getElementById(`tab-${tab}`);
            targetEl.classList.remove('hidden'); targetEl.classList.add('animate-fade-in'); 
            document.getElementById(`nav-${tab}`).classList.add('active'); 
            if (tab === 'map') setTimeout(() => { loadMapMarkers(); }, 100);
        };

        const getWeekKey = (date) => { 
            const d = new Date(date); d.setHours(0,0,0,0); 
            d.setDate(d.getDate() + 4 - (d.getDay() || 7)); 
            let yearStart = new Date(d.getFullYear(), 0, 1); 
            return d.getFullYear() + "-" + Math.ceil((((d - yearStart) / 86400000) + 1) / 7); 
        };
        const getNextSunday = () => { let d = new Date(); d.setDate(d.getDate() + (7 - d.getDay()) % 7); return d.toLocaleDateString('de-DE'); };

        window.startActiveDate = (id) => {
            update(ref(db, `wishes/${id}`), { status: 'active' });
            document.getElementById('result-box').classList.add('hidden');
            document.getElementById('result-box').classList.remove('magic-pop-in');
        };

        // --- MULTI PHOTO (max 3) for Date Memories ---
        let currentPhotosBase64 = [];   // array of compressed data_urls (temporary, not stored in DB)
        let currentThumbIndex = 0;
        let memoryManageMode = false;

        const renderMemoryThumbs = () => {
            const wrap = document.getElementById('memory-thumbs');
            const preview = document.getElementById('preview-image');
            const uploadText = document.getElementById('upload-text');
            const manageToggle = document.getElementById('memory-manage-toggle');
            if (!wrap || !preview || !uploadText) return;

            // Hide all if nothing
            if (!currentPhotosBase64.length) {
                wrap.classList.add('hidden');
                preview.classList.add('hidden');
                uploadText.innerText = "üì∏ Fotos hinzuf√ºgen (max 3)";
                if (manageToggle) manageToggle.classList.add('hidden');
                memoryManageMode = false;
                return;
            }

            // Show main preview (selected)
            preview.src = currentPhotosBase64[currentThumbIndex] || currentPhotosBase64[0];
            preview.classList.remove('hidden');

            // Build thumbs
            wrap.innerHTML = "";
            wrap.classList.remove('hidden');
            if (manageToggle) manageToggle.classList.remove('hidden');
            if (manageToggle) manageToggle.classList.remove('hidden');

            currentPhotosBase64.forEach((src, i) => {
                const box = document.createElement('div');
                box.className = "flex flex-col items-center gap-1";

                const btn = document.createElement('button');
                btn.type = "button";
                btn.className = "relative w-14 h-14 rounded-xl overflow-hidden border-2 " + (i === currentThumbIndex ? "border-teal-400" : "border-teal-100");
                btn.innerHTML = `
                    <img src="${src}" class="w-full h-full object-cover">
                    ${i === currentThumbIndex ? `<div class="absolute bottom-1 right-1 text-[10px] bg-teal-500 text-white px-1.5 py-0.5 rounded-lg font-black">‚≠ê</div>` : ""}
                `.trim();
                btn.onclick = () => { currentThumbIndex = i; renderMemoryThumbs(); };

                box.appendChild(btn);

                // Management buttons (bigger, not tiny overlays)
                if (memoryManageMode) {
                    const row = document.createElement('div');
                    row.className = "flex gap-1";
                    const repBtn = document.createElement('button');
                    repBtn.type = "button";
                    repBtn.className = "px-2 py-1 rounded-lg text-[11px] border border-teal-200 bg-white/80";
                    repBtn.textContent = "Ersetzen";
                    repBtn.onclick = (ev) => { ev.stopPropagation(); window.replaceMemoryPhoto(i); };

                    const delBtn = document.createElement('button');
                    delBtn.type = "button";
                    delBtn.className = "px-2 py-1 rounded-lg text-[11px] border border-red-200 bg-white/80 text-red-600";
                    delBtn.textContent = "L√∂schen";
                    delBtn.onclick = (ev) => { ev.stopPropagation(); window.deleteMemoryPhoto(i); };

                    row.appendChild(repBtn);
                    row.appendChild(delBtn);
                    box.appendChild(row);
                }

                wrap.appendChild(box);
            });
uploadText.innerText = currentPhotosBase64.length >= 3 ? "‚úÖ 3 Foto(s) vorhanden" : `‚úÖ ${currentPhotosBase64.length} Foto(s) vorhanden ‚Äì weitere hinzuf√ºgen (max 3)`;
        };

        const toggleMemoryManage = () => { memoryManageMode = !memoryManageMode; renderMemoryThumbs(); };
        const _memTglBtn = document.getElementById('memory-manage-toggle');
        if (_memTglBtn) _memTglBtn.onclick = toggleMemoryManage;

        const compressImageFileToDataUrl = (file, maxWidth = 900, quality = 0.65) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round(height * (maxWidth / width));
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        window.handleMemoryFilesUpload = async (input) => {
            try {
                const files = Array.from(input.files || []).filter(Boolean).slice(0, 3);
                if (!files.length) return;

                currentPhotosBase64 = [];
                currentThumbIndex = 0;

                // compress sequentially to keep memory low
                for (const f of files) {
                    const dataUrl = await compressImageFileToDataUrl(f, 900, 0.65);
                    currentPhotosBase64.push(dataUrl);
                }

                // Keep compatibility with existing code paths that expect 1 photo
                currentPhotoBase64 = currentPhotosBase64[0] || "";

                renderMemoryThumbs();
            } catch (e) {
                console.error("handleMemoryFilesUpload failed:", e);
                alert("Foto-Upload fehlgeschlagen: " + (e?.message || e));
            }
        };

        async function uploadPhotoForWishAtIndex(wishId, idx, dataUrl) {
            if (!dataUrl) return { fullUrl: "", thumbUrl: "" };

            // If already URL, keep it
            if (typeof dataUrl === "string" && !dataUrl.startsWith("data:")) {
                return { fullUrl: dataUrl, thumbUrl: "" };
            }

            const thumbDataUrl = await makeThumbnailDataURL(dataUrl, 480, 0.90);

            const fullRef = sRef(storage, `wishes/${wishId}/photos/${idx}/full.jpg`);
            await uploadString(fullRef, dataUrl, "data_url");
            const fullUrl = await getDownloadURL(fullRef);

            let thumbUrl = "";
            if (thumbDataUrl) {
                const thumbRef = sRef(storage, `wishes/${wishId}/photos/${idx}/thumb.jpg`);
                await uploadString(thumbRef, thumbDataUrl, "data_url");
                thumbUrl = await getDownloadURL(thumbRef);
            }

            return { fullUrl, thumbUrl };
        }


        // --- MILESTONE EDIT: Thumbnail Auswahl (f√ºr Karten + Map-Pin) ---
        let msExistingPhotos = [];
        let msThumbIndex = 0;
        let msManageMode = false;

        const renderMilestoneThumbs = () => {
            const wrap = document.getElementById('ms-photo-thumbs');
            const hint = document.getElementById('ms-photo-hint');
            const manageToggle = document.getElementById('ms-manage-toggle');
            if (!wrap) return;

            if (!msExistingPhotos.length) {
                if (manageToggle) manageToggle.classList.add('hidden');
                msManageMode = false;
                wrap.classList.add('hidden');
                if (hint) hint.classList.add('hidden');
                wrap.innerHTML = "";
                return;
            }

            wrap.classList.remove('hidden');
            if (manageToggle) manageToggle.classList.remove('hidden');
            if (manageToggle) manageToggle.classList.remove('hidden');
            if (hint) hint.classList.remove('hidden');
            wrap.innerHTML = "";

            msExistingPhotos.forEach((p, i) => {
                const src = p.thumbUrl || p.fullUrl || "";
                const box = document.createElement('div');
                box.className = "flex flex-col items-center gap-1";

                const btn = document.createElement('button');
                btn.type = "button";
                btn.className = "relative w-14 h-14 rounded-xl overflow-hidden border-2 " + (i === msThumbIndex ? "border-pink-400" : "border-pink-100");
                btn.innerHTML = `
                    <img src="${src}" class="w-full h-full object-cover">
                    ${i === msThumbIndex ? `<div class="absolute bottom-1 right-1 text-[10px] bg-pink-500 text-white px-1.5 py-0.5 rounded-lg font-black">‚≠ê</div>` : ""}
                `.trim();

                btn.onclick = () => {
                    msThumbIndex = i;
                    renderMilestoneThumbs();
                    const prev = document.getElementById('ms-preview-image');
                    if (prev) { prev.src = (msExistingPhotos[msThumbIndex]?.fullUrl || msExistingPhotos[msThumbIndex]?.thumbUrl || ""); }
                };

                box.appendChild(btn);

                if (msManageMode) {
                    const row = document.createElement('div');
                    row.className = "flex gap-1";
                    const repBtn = document.createElement('button');
                    repBtn.type = "button";
                    repBtn.className = "px-2 py-1 rounded-lg text-[11px] border border-teal-200 bg-white/80";
                    repBtn.textContent = "Ersetzen";
                    repBtn.onclick = (ev) => { ev.stopPropagation(); window.replaceMilestonePhoto(i); };

                    const delBtn = document.createElement('button');
                    delBtn.type = "button";
                    delBtn.className = "px-2 py-1 rounded-lg text-[11px] border border-red-200 bg-white/80 text-red-600";
                    delBtn.textContent = "L√∂schen";
                    delBtn.onclick = (ev) => { ev.stopPropagation(); window.deleteMilestonePhoto(i); };

                    row.appendChild(repBtn);
                    row.appendChild(delBtn);
                    box.appendChild(row);
                }

                wrap.appendChild(box);
            });
};
        // --- VIEW: support swipe / carousel if multiple photos exist ---
        let viewMemoryPhotos = [];
        let viewMemoryIdx = 0;

        const setDots = () => {
            const dots = document.getElementById('view-dots');
            if (!dots) return;
            if (viewMemoryPhotos.length <= 1) { dots.classList.add('hidden'); dots.innerHTML = ""; return; }
            dots.classList.remove('hidden');
            dots.innerHTML = "";
            viewMemoryPhotos.forEach((_, i) => {
                const d = document.createElement('button');
                d.type = "button";
                d.className = "w-2.5 h-2.5 rounded-full " + (i === viewMemoryIdx ? "bg-gray-800" : "bg-gray-300");
                d.onclick = () => showViewMemoryIndex(i);
                dots.appendChild(d);
            });
        };

        const showViewMemoryIndex = (idx) => {
            if (!viewMemoryPhotos.length) return;
            viewMemoryIdx = (idx + viewMemoryPhotos.length) % viewMemoryPhotos.length;

            const imgEl = document.getElementById('view-img');
            const prevBtn = document.getElementById('view-prev');
            const nextBtn = document.getElementById('view-next');
            if (!imgEl) return;

            if (prevBtn && nextBtn) {
                const multi = viewMemoryPhotos.length > 1;
                prevBtn.classList.toggle('hidden', !multi);
                nextBtn.classList.toggle('hidden', !multi);
            }

            setDots();

            const p = viewMemoryPhotos[viewMemoryIdx] || {};
            const thumbSrc = p.thumbUrl || "";
            const fullSrc = p.fullUrl || "";

            imgEl.style.transition = "opacity 180ms ease";
            imgEl.style.opacity = "1";

            if (thumbSrc && thumbSrc !== fullSrc) imgEl.src = thumbSrc;
            else imgEl.src = fullSrc;

            if (thumbSrc && thumbSrc !== fullSrc) {
                const pre = new Image();
                pre.onload = () => {
                    imgEl.style.opacity = "0";
                    setTimeout(() => {
                        imgEl.src = fullSrc;
                        requestAnimationFrame(() => { imgEl.style.opacity = "1"; });
                    }, 160);
                };
                pre.src = fullSrc;
            }
        };

        const bindViewCarouselOnce = (() => {
            let bound = false;
            return () => {
                if (bound) return;
                bound = true;

                const prevBtn = document.getElementById('view-prev');
                const nextBtn = document.getElementById('view-next');
                const imgEl = document.getElementById('view-img');
                if (prevBtn) prevBtn.onclick = () => showViewMemoryIndex(viewMemoryIdx - 1);
                if (nextBtn) nextBtn.onclick = () => showViewMemoryIndex(viewMemoryIdx + 1);

                // Swipe
                if (imgEl) {
                    let sx = 0, sy = 0, active = false;
                    imgEl.addEventListener('touchstart', (e) => {
                        if (!viewMemoryPhotos.length) return;
                        const t = e.touches[0];
                        sx = t.clientX; sy = t.clientY; active = true;
                    }, { passive: true });

                    imgEl.addEventListener('touchend', (e) => {
                        if (!active) return;
                        active = false;
                        const t = e.changedTouches[0];
                        const dx = t.clientX - sx;
                        const dy = t.clientY - sy;
                        if (Math.abs(dx) < 40 || Math.abs(dx) < Math.abs(dy)) return;
                        if (dx < 0) showViewMemoryIndex(viewMemoryIdx + 1);
                        else showViewMemoryIndex(viewMemoryIdx - 1);
                    }, { passive: true });
                }
            };
        })();

        window.handleFileUpload = (input) => {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 600; let width = img.width; let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height);
                    currentPhotoBase64 = canvas.toDataURL('image/jpeg', 0.6);
                    const preview = document.getElementById('preview-image'); preview.src = currentPhotoBase64; preview.classList.remove('hidden');
                    document.getElementById('upload-text').innerText = "üì∏ Fotos verwalten (max 3)";
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        window.handleMilestonePhotoUpload = async (input) => {
            try {
                const files = Array.from(input.files || []).filter(Boolean);
                if (!files.length) return;

                // wie viele Slots sind noch frei?
                const remaining = Math.max(0, 3 - (msExistingPhotos?.length || 0));
                const use = files.slice(0, remaining);

                if (!use.length) {
                    alert("Maximal 3 Fotos pro Date üíõ");
                    input.value = "";
                    return;
                }

                // compress sequentially
                for (const f of use) {
                    const dataUrl = await compressImageFileToDataUrl(f, 900, 0.65);
                    msExistingPhotos.push({ fullUrl: dataUrl, thumbUrl: "" });
                }

                // clamp
                msExistingPhotos = msExistingPhotos.slice(0, 3);

                // preview auf aktuelles Thumbnail/cover
                msThumbIndex = Math.max(0, Math.min(msThumbIndex || 0, msExistingPhotos.length - 1));
                const sel = msExistingPhotos[msThumbIndex] || msExistingPhotos[0] || {};
                const preview = document.getElementById('ms-preview-image');
                if (preview) {
                    preview.src = sel.fullUrl || sel.thumbUrl || preview.src || "";
                    if (preview.src) preview.classList.remove('hidden');
                }

                const uploadTextEl = document.getElementById('ms-upload-text');
                if (uploadTextEl) {
                    uploadTextEl.innerText = `‚úÖ ${msExistingPhotos.length} Foto(s) vorhanden ‚Äì weitere hinzuf√ºgen (max 3)`;
                }

                // alte Single-Replace-Logik deaktivieren
                currentPhotoBase64 = "";

                renderMilestoneThumbs();
                input.value = "";
            } catch (e) {
                console.error("handleMilestonePhotoUpload failed:", e);
                alert("Foto-Upload fehlgeschlagen: " + (e?.message || e));
            }
        };
            async function uploadPhotoForWish(wishId, dataUrl) {
  if (!dataUrl) return { fullUrl: "", thumbUrl: "" };

  if (typeof dataUrl === "string" && !dataUrl.startsWith("data:")) {
    return { fullUrl: dataUrl, thumbUrl: "" };
  }

  const thumbDataUrl = await makeThumbnailDataURL(dataUrl, 480, 0.90);

  const fullRef = sRef(storage, `wishes/${wishId}/memory.jpg`);
  await uploadString(fullRef, dataUrl, "data_url");
  const fullUrl = await getDownloadURL(fullRef);

  let thumbUrl = "";
  if (thumbDataUrl) {
    const thumbRef = sRef(storage, `wishes/${wishId}/thumb.jpg`);
    await uploadString(thumbRef, thumbDataUrl, "data_url");
    thumbUrl = await getDownloadURL(thumbRef);
  }

  return { fullUrl, thumbUrl };
}

            function makeThumbnailDataURL(originalDataUrl, maxSize = 480, quality = 0.90) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");

                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = "high";

                const ratio = Math.min(maxSize / img.width, maxSize / img.height, 1);

                // Wenn kein Downscale n√∂tig ist, kein Thumbnail erstellen (spart Speicher & Uploads)
                if (ratio >= 0.999) { resolve(null); return; }
                const w = Math.round(img.width * ratio);
                const h = Math.round(img.height * ratio);

                canvas.width = w;
                canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);

                resolve(canvas.toDataURL("image/jpeg", quality));
                };
                img.src = originalDataUrl;
            });
            }

        // --- NEW VIEW MODAL LOGIC (Nur Ansehen) ---
        window.openMemoryView = async (id) => {
            const modal = document.getElementById('view-memory-modal');
            const imgEl = document.getElementById('view-img');
            const titleEl = document.getElementById('view-title');
            const noteEl = document.getElementById('view-note');
            const dateEl = document.getElementById('view-date');

            // Reset
            imgEl.src = ""; titleEl.innerText = "Laden..."; noteEl.innerText = ""; dateEl.innerText = "";
            modal.classList.remove('hidden');
            playSound('photo');

            const snapshot = await get(ref(db, `wishes/${id}`));
            const data = snapshot.val();
            
            if (data && (data.memoryPhoto || (data.memoryPhotos && data.memoryPhotos.length))) {
                titleEl.innerText = data.text || "";
                noteEl.innerText = data.memoryNote || "Keine Notiz dazu.";
                const d = new Date(data.doneAt || Date.now());
                dateEl.innerText = d.toLocaleDateString('de-DE') + (data.location ? (" ‚Ä¢ " + data.location) : "");

                // Multi / Single normalisieren
                viewMemoryPhotos = Array.isArray(data.memoryPhotos) && data.memoryPhotos.length
                    ? data.memoryPhotos
                    : [{ fullUrl: data.memoryPhoto, thumbUrl: data.memoryThumb || "" }];

                viewMemoryIdx = Math.max(0, Math.min((data.memoryThumbIndex || 0), viewMemoryPhotos.length - 1));
                bindViewCarouselOnce();
                showViewMemoryIndex(viewMemoryIdx);
            } else {
                modal.classList.add('hidden'); // Sollte nicht passieren
            }
        };

        window.openMilestoneModal = async (mode, id = null, type = 'archive') => {
            currentModalMode = type;
            const modal = document.getElementById('milestone-modal');
            const titleEl = document.getElementById('ms-title'); const locEl = document.getElementById('ms-location'); const infoEl = document.getElementById('ms-info');
            const catEl = document.getElementById('ms-cat'); const weatherEl = document.getElementById('ms-weather'); const dateEl = document.getElementById('ms-date');
            const noteEl = document.getElementById('ms-note'); const ratingMEl = document.getElementById('ms-rating-m'); const ratingSEl = document.getElementById('ms-rating-s');
            const previewEl = document.getElementById('ms-preview-image'); const uploadTextEl = document.getElementById('ms-upload-text');
            const modalTitle = document.getElementById('modal-title'); const memoryFields = document.getElementById('ms-memory-fields');
            
            titleEl.value = ""; locEl.value = ""; infoEl.value = ""; dateEl.value = ""; noteEl.value = ""; ratingMEl.value = ""; ratingSEl.value = "";
            previewEl.src = ""; previewEl.classList.add('hidden'); uploadTextEl.innerText = "üì∏ Fotos hinzuf√ºgen (max 3)"; currentPhotoBase64 = "";
            msExistingPhotos = []; msThumbIndex = 0; const msWrap = document.getElementById("ms-photo-thumbs"); if (msWrap) { msWrap.classList.add("hidden"); msWrap.innerHTML = ""; }
            locEl.setAttribute('data-original-location', "");

            if (type === 'idea') {
                 modalTitle.innerText = mode === 'add' ? "Neue Idee üí°" : "Idee bearbeiten ‚úèÔ∏è";
                 memoryFields.classList.add('hidden');
            } else if (type === 'bucket') {
                 modalTitle.innerText = mode === 'add' ? "Neuer Bucket List Traum ‚ú®" : "Traum bearbeiten ‚úèÔ∏è";
                 if (mode === 'add') memoryFields.classList.add('hidden');
                 else {
                     const snapshot = await get(ref(db, `wishes/${id}`)); const data = snapshot.val();
                     if (data && data.status === 'done') memoryFields.classList.remove('hidden'); else memoryFields.classList.add('hidden');
                 }
            } else {
                 modalTitle.innerText = mode === 'add' ? "Meilenstein nachtragen üèÜ" : "Meilenstein bearbeiten ‚úèÔ∏è";
                 memoryFields.classList.remove('hidden');
            }

            if (mode === 'edit' && id) {
                currentEditingMilestoneId = id;
                const snapshot = await get(ref(db, `wishes/${id}`));
                const data = snapshot.val();
                if (data) {
                    titleEl.value = data.text || ""; locEl.value = data.location || ""; locEl.setAttribute('data-original-location', data.location || "");
                    infoEl.value = data.info || ""; catEl.value = data.cat || "Sofort"; weatherEl.value = data.weather || "Egal";
                    noteEl.value = data.memoryNote || ""; ratingMEl.value = data.ratingMeriam || ""; ratingSEl.value = data.ratingSamet || "";
                    if (data.memoryPhotos && Array.isArray(data.memoryPhotos) && data.memoryPhotos.length) {
                        msExistingPhotos = data.memoryPhotos;
                        msThumbIndex = Math.max(0, Math.min((data.memoryThumbIndex || 0), msExistingPhotos.length - 1));
                        const sel = msExistingPhotos[msThumbIndex] || msExistingPhotos[0] || {};
                        previewEl.src = sel.fullUrl || sel.thumbUrl || "";
                        previewEl.classList.remove('hidden');
                        uploadTextEl.innerText = `‚úÖ ${msExistingPhotos.length} Foto(s) vorhanden ‚Äì weitere hinzuf√ºgen (max 3)`;
                        currentPhotoBase64 = ""; // kein Replace-Upload automatisch
                        renderMilestoneThumbs();
                    } else if (data.memoryPhoto) {
                        // Legacy (1 Foto) -> in neues 3-Foto-Model √ºbernehmen, damit man weitere hinzuf√ºgen kann
                        msExistingPhotos = [{ fullUrl: data.memoryPhoto, thumbUrl: (data.memoryThumb || "") }];
                        msThumbIndex = 0;
                        previewEl.src = data.memoryPhoto;
                        previewEl.classList.remove('hidden');
                        uploadTextEl.innerText = "‚úÖ 1 Foto vorhanden ‚Äì weitere hinzuf√ºgen (max 3)";
                        currentPhotoBase64 = ""; // nur f√ºr neue Uploads nutzen
                        renderMilestoneThumbs();
                    }
                    if (data.doneAt) { const d = new Date(data.doneAt); d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); dateEl.value = d.toISOString().slice(0, 16); }
                }
            } else {
                currentEditingMilestoneId = null;
                if (!memoryFields.classList.contains('hidden')) { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); dateEl.value = now.toISOString().slice(0, 16); }
            }
            modal.classList.remove('hidden');
        };

        window.saveMilestone = async () => {
            const title = document.getElementById('ms-title').value.trim();
            if (!title) return alert("Titel fehlt!");
            const user = sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser');
            const location = document.getElementById('ms-location').value.trim();
            const originalLocation = document.getElementById('ms-location').getAttribute('data-original-location');

            const payload = {
                text: title,
                location: location,
                info: document.getElementById('ms-info').value.trim(),
                cat: document.getElementById('ms-cat').value,
                weather: document.getElementById('ms-weather').value
            };

            if (location !== originalLocation) { payload.lat = null; payload.lon = null; }

            if (currentModalMode === 'archive') {
                payload.status = 'done';
                payload.isBucket = false;
                payload.memoryNote = document.getElementById('ms-note').value.trim();
                payload.ratingMeriam = document.getElementById('ms-rating-m').value;
                payload.ratingSamet = document.getElementById('ms-rating-s').value;
                const dateVal = document.getElementById('ms-date').value;
                payload.doneAt = dateVal ? new Date(dateVal).getTime() : Date.now();
            } else {
                if (!currentEditingMilestoneId) {
                    payload.status = 'open';
                    payload.isBucket = true;
                    payload.timestamp = Date.now();
                } else {
                    if (!document.getElementById('ms-memory-fields').classList.contains('hidden')) {
                        payload.memoryNote = document.getElementById('ms-note').value.trim();
                        payload.ratingMeriam = document.getElementById('ms-rating-m').value;
                        payload.ratingSamet = document.getElementById('ms-rating-s').value;
                        const dateVal = document.getElementById('ms-date').value;
                        if (dateVal) payload.doneAt = new Date(dateVal).getTime();
                    }
                }
            }

            // ---- FOTO-LOGIK (max 3) ----
            // Legacy fallback: wenn aus irgendeinem Grund noch currentPhotoBase64 gesetzt ist (alt)
            if ((!msExistingPhotos || !msExistingPhotos.length) && currentPhotoBase64) {
                msExistingPhotos = [{ fullUrl: currentPhotoBase64, thumbUrl: "" }];
                msThumbIndex = 0;
            }

            const applyCoverFrom = (arr) => {
                const idx = Math.max(0, Math.min((msThumbIndex || 0), (arr.length - 1)));
                const sel = arr[idx] || arr[0] || {};
                payload.memoryThumbIndex = idx;
                payload.memoryPhoto = sel.fullUrl || "";
                payload.memoryThumb = sel.thumbUrl || "";
                payload.memoryPhotos = arr;
            };

            const uploadAndNormalizePhotos = async (wishId) => {
                if (!msExistingPhotos || !Array.isArray(msExistingPhotos) || !msExistingPhotos.length) return;

                // upload any data: entries in-place, keep order 0..2
                const normalized = [];
                for (let i = 0; i < Math.min(3, msExistingPhotos.length); i++) {
                    const p = msExistingPhotos[i] || {};
                    const full = p.fullUrl || p.url || "";
                    const thumb = p.thumbUrl || p.thumb || "";

                    if (typeof full === "string" && full.startsWith("data:")) {
                        const { fullUrl, thumbUrl } = await uploadPhotoForWishAtIndex(wishId, i, full);
                        normalized.push({ fullUrl, thumbUrl });
                    } else {
                        // already URL
                        normalized.push({ fullUrl: full, thumbUrl: thumb });
                    }
                }
                msExistingPhotos = normalized;
            };

            try {
                if (currentEditingMilestoneId) {
                    // Editing existing wish -> upload first, then update payload with URLs
                    await uploadAndNormalizePhotos(currentEditingMilestoneId);

                    if (msExistingPhotos && msExistingPhotos.length) {
                        applyCoverFrom(msExistingPhotos);
                    }

                    await update(ref(db, `wishes/${currentEditingMilestoneId}`), payload);
                } else {
                    // Create new wish
                    payload.by = user;
                    if (!payload.timestamp) payload.timestamp = Date.now();

                    // never store data: in DB
                    delete payload.memoryPhoto;
                    delete payload.memoryThumb;
                    delete payload.memoryPhotos;
                    delete payload.memoryThumbIndex;

                    const newRef = await push(ref(db, 'wishes'), payload);

                    // After push, upload photos and patch URLs
                    if (newRef && newRef.key) {
                        await uploadAndNormalizePhotos(newRef.key);

                        if (msExistingPhotos && msExistingPhotos.length) {
                            const patch = {};
                            const idx = Math.max(0, Math.min((msThumbIndex || 0), msExistingPhotos.length - 1));
                            const sel = msExistingPhotos[idx] || msExistingPhotos[0] || {};
                            patch.memoryPhotos = msExistingPhotos;
                            patch.memoryThumbIndex = idx;
                            patch.memoryPhoto = sel.fullUrl || "";
                            patch.memoryThumb = sel.thumbUrl || "";
                            await update(ref(db, `wishes/${newRef.key}`), patch);
                        }
                    }
                }
            } catch (e) {
                console.error("saveMilestone failed:", e);
                alert("Speichern fehlgeschlagen: " + (e?.message || e));
                return;
            }

            document.getElementById('milestone-modal').classList.add('hidden');
        };

        window.openCountdownModal = () => { document.getElementById('countdown-modal').classList.remove('hidden'); if (countdownTarget) document.getElementById('new-cd-title').value = countdownTitle; };
        window.editCountdown = () => { document.getElementById('countdown-modal').classList.remove('hidden'); document.getElementById('new-cd-title').value = countdownTitle; };

        document.getElementById('btn-save-countdown').onclick = async () => {
            try {
                const title = document.getElementById('new-cd-title').value.trim();
                const dateStr = document.getElementById('new-cd-date').value;
                if(!title || !dateStr) return alert("Bitte ausf√ºllen!");
                const timestamp = new Date(dateStr).getTime();
                if (isNaN(timestamp)) return alert("Ung√ºltiges Datum!");
                await set(ref(db, 'countdown/current'), { title: title, target: timestamp });
                document.getElementById('countdown-modal').classList.add('hidden');
                document.getElementById('new-cd-title').value = ""; document.getElementById('new-cd-date').value = "";
                playSound('success');
            } catch (e) { alert("Fehler: " + e.message); }
        };

        window.deleteCountdown = () => { if(confirm("L√∂schen?")) set(ref(db, 'countdown/current'), null); };

        const updateCountdownUI = () => {
            if (!countdownTarget) return;
            const diff = countdownTarget - Date.now();
            if (diff <= 0) { document.getElementById('cd-days').innerText = "0"; return; }
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById('cd-days').innerText = days;
            document.getElementById('cd-hours').innerText = hours;
            document.getElementById('cd-min').innerText = minutes;
        };
        setInterval(updateCountdownUI, 1000);

        const getCatLabel = (val) => val === 'Planung' ? 'üìÖ Planung n√∂tig' : '‚ö° Spontan m√∂glich';
        const getWeatherLabel = (val) => { if (val === 'Sonne') return '‚òÄÔ∏è Bei Sonne sch√∂ner'; if (val === 'Regen') return 'üè† Indoor / Regen-Option'; return '‚òÅÔ∏è Wetter egal'; };

        
        // --- POST-IT SENDEN (ohne OpenAI) ---
        function bindLoveLetterUI() {
            const btn = document.getElementById('btn-send-letter');
            const input = document.getElementById('love-letter-input');
            if (!btn || !input) return;

            let sending = false;

            const send = async () => {
                try {
                    if (sending) return;
                    const text = (input.value || "").trim();
                    if (!text) return alert("Bitte erst eine Nachricht eingeben üôÇ");
                    const by = (typeof currentUser !== "undefined" && currentUser)
                        || sessionStorage.getItem('currentUser')
                        || localStorage.getItem('currentUser')
                        || (typeof auth !== "undefined" && auth?.currentUser?.displayName)
                        || (typeof auth !== "undefined" && auth?.currentUser?.email)
                        || (typeof auth !== "undefined" && auth?.currentUser?.uid)
                        || null;

                    if (!by) return alert("Bitte erst einloggen.");

                    sending = true;
                    btn.disabled = true;

                    await push(ref(db, 'loveLetters'), {
                        text,
                        by,
                        sentAt: Date.now()
                    });

                    input.value = "";
                    if (typeof playSound === 'function') playSound('success');
                } catch (e) {
                    console.error("Post-it send failed:", e);
                    alert("Senden fehlgeschlagen: " + (e?.message || e));
                } finally {
                    sending = false;
                    btn.disabled = false;
                }
            };

            btn.onclick = send;
            input.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter') send();
            });
        }

const syncData = (currentUser) => {
            const partner = currentUser === "Samet" ? "Meriam" : "Samet";
            document.getElementById('love-letter-title').innerText = `Post-it an ${partner} üìù`;
            document.getElementById('vs-label').innerText = `Ich vs ${partner}`;
            bindLoveLetterUI();

            onValue(ref(db, 'stats/claimedCount'), (snap) => { globalClaimedCount = snap.val() || 0; if (globalDoneCount !== undefined) updateRewardUI(globalDoneCount, globalClaimedCount); });
            onValue(ref(db, 'systemStart'), (snap) => { relationshipStart = snap.val(); updateUptime(); });
            onValue(ref(db, 'countdown/current'), (snap) => {
                const item = snap.val();
                if (item && item.target > Date.now()) {
                    countdownTarget = item.target; countdownTitle = item.title;
                    document.getElementById('countdown-title').innerText = item.title + " ‚ù§Ô∏è";
                    document.getElementById('countdown-placeholder').classList.add('hidden'); document.getElementById('countdown-card').classList.remove('hidden'); updateCountdownUI();
                } else { document.getElementById('countdown-card').classList.add('hidden'); document.getElementById('countdown-placeholder').classList.remove('hidden'); countdownTarget = null; }
            });

            onValue(ref(db, 'loveLetters'), (snap) => {
  const container = document.getElementById('love-letter-display');
  if (!container) return;

  container.innerHTML = "";

  const data = snap.val();
  if (!data) {
    container.innerHTML = "<div style='opacity:0.6;'>Noch keine Nachrichten üíõ</div>";
    return;
  }

  const messages = Object.keys(data)
    .map(key => data[key])
    .filter(m => m && m.text)
    .sort((a,b)=> (b.sentAt||0)-(a.sentAt||0)).slice(0,3);

  messages.forEach(d => {
    const when = d.sentAt
      ? (function(ts){
          const diff = Date.now() - ts;
          const min = Math.floor(diff/60000);
          const hr = Math.floor(diff/3600000);
          const day = Math.floor(diff/86400000);
          if(min < 1) return "gerade eben";
          if(min < 60) return "vor " + min + " Min.";
          if(hr < 24) return "vor " + hr + " Std.";
          if(day === 1) return "gestern";
          return new Date(ts).toLocaleString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
      })(d.sentAt)
      : "";

    const el = document.createElement("div");
    el.style.marginBottom = "12px";
    el.innerHTML = `
      <div style="font-size:14px;">"${d.text}"</div>
      <div style="font-size:11px;opacity:0.7;">Von ${d.by} ‚Ä¢ ${when}</div>
    `;
    container.appendChild(el);
  });
});
            
            // --- QUIZ ARENA v2 UPDATE ---
            onValue(ref(db, 'quiz'), (snap) => {
                const data = snap.val() || {};
                renderQuiz2Lists(data);
            });

            // --- NEW (Index04): Polaroids Sync ---
            onValue(ref(db, 'polaroids'), (snap) => {
                const data = snap.val() || {};
                renderPolaroidsGrid(data);
            });

            onValue(ref(db, 'wishes'), (snapshot) => {
                const wishList = document.getElementById('wish-list'); const archiveList = document.getElementById('archive-list'); const bucketList = document.getElementById('bucket-list-content');
                const galleryGrid = document.getElementById('gallery-grid');
                wishList.innerHTML = ""; archiveList.innerHTML = ""; bucketList.innerHTML = ""; galleryGrid.innerHTML = "";
                const data = snapshot.val(); if(!data) return;

                let doneCount = 0, sametTotal = 0, meriamTotal = 0, total = 0, doneWeekKeys = new Set();
                let curWeekKey = getWeekKey(new Date()); let thisWeekDone = false;

                Object.keys(data).forEach(id => {
                    const item = data[id]; total++;
                    if(item.status === 'done') { doneCount++; doneWeekKeys.add(getWeekKey(item.doneAt)); if(getWeekKey(item.doneAt) === curWeekKey) thisWeekDone = true; }
                    if(item.by === 'Samet') sametTotal++; else meriamTotal++;
                });
                globalDoneCount = doneCount; updateRewardUI(globalDoneCount, globalClaimedCount);

                let streak = 0; let weekIt = new Date(); if(!thisWeekDone) weekIt.setDate(weekIt.getDate() - 7);
                while(doneWeekKeys.has(getWeekKey(weekIt))) { streak++; weekIt.setDate(weekIt.getDate() - 7); }
                document.getElementById('stat-streak').innerText = streak;
                document.getElementById('stat-vs').innerText = (currentUser === "Samet" ? sametTotal : meriamTotal) + " : " + (currentUser === "Samet" ? meriamTotal : sametTotal);
                document.getElementById('stat-progress').innerText = Math.round((doneCount / total) * 100 || 0) + "%";
                document.getElementById('streak-info').innerText = thisWeekDone ? "‚úÖ Serie sicher" : `‚è≥ N√∂tig bis ${getNextSunday()}`;
                
                const allIds = Object.keys(data);
                const activeIds = allIds.filter(id => data[id].status === 'active');
                const openIds = allIds.filter(id => data[id].status === 'open' && !data[id].isBucket).reverse();
                const doneIds = allIds.filter(id => data[id].status === 'done').sort((a, b) => data[b].doneAt - data[a].doneAt); 
                const bucketIds = allIds.filter(id => data[id].isBucket).reverse();

                // Galerie
                doneIds.forEach(id => {
                    const item = data[id];
                    if (item.memoryPhoto) {
                        const dateStr = new Date(item.doneAt).toLocaleDateString('de-DE');
                        const pol = document.createElement('div');
                        pol.className = "polaroid animate-scale-in";
                        pol.onclick = () => openMemoryView(id); 
                        pol.innerHTML = `<img src="${item.memoryThumb || item.memoryPhoto}" loading="lazy" alt="${item.text}"><p class="polaroid-caption">${dateStr} - ${item.text}</p>`;
                        galleryGrid.appendChild(pol);
                    }
                });

                activeIds.forEach(id => {
                    const item = data[id]; const isSecret = item.surprise && item.by !== currentUser;
                    const card = document.createElement('div'); card.className = "mint-card p-4 border-l-4 border-green-400 bg-green-50/90 shadow-md relative overflow-hidden animate-slide-up";
                    card.innerHTML = `<div class="absolute top-0 right-0 bg-green-400 text-white text-[9px] font-black px-2 py-1 rounded-bl-xl uppercase tracking-widest">L√§uft gerade</div><div class="flex justify-between items-start"><div class="flex-1 pr-8"><p class="font-bold text-lg text-teal-900">${isSecret ? 'ü§´ Geheime Idee' : item.text}</p>${!isSecret && item.location ? `<p class="text-[11px] text-teal-600 mt-1 font-medium">üìç ${item.location}</p>` : ''}<div class="flex gap-2 mt-2"><span class="user-badge ${item.by === 'Meriam' ? 'badge-meriam' : 'badge-samet'}">${item.by}</span></div></div><div class="flex gap-2 pt-6"><button onclick="markAsDone('${id}')" class="text-green-500 font-black text-xs bg-white px-3 py-1 rounded-full shadow-sm border border-green-200 hover:bg-green-50">BEENDEN ‚úì</button></div></div>`;
                    wishList.appendChild(card);
                });

                openIds.forEach(id => {
                    const item = data[id]; const isSecret = item.surprise && item.by !== currentUser;
                    const card = document.createElement('div'); card.className = "mint-card p-4 border-l-4 animate-slide-up " + (item.by === 'Meriam' ? 'border-pink-200' : 'border-teal-200');
                    card.innerHTML = `<div class="flex justify-between items-start"><div class="flex-1"><p class="font-bold ${isSecret ? 'italic text-gray-300' : ''}">${item.surprise && item.by === currentUser ? 'üîí ' : ''}${isSecret ? 'ü§´ Geheime Idee' : item.text}</p>${!isSecret && item.location ? `<p class="text-[11px] text-teal-600 mt-1 font-medium">üìç ${item.location}</p>` : ''}<div class="flex gap-2 mt-2"><span class="user-badge ${item.by === 'Meriam' ? 'badge-meriam' : 'badge-samet'}">${item.by}</span><span class="user-badge badge-samet text-[7px] bg-teal-50 text-teal-600">${getCatLabel(item.cat)}</span><span class="user-badge badge-samet text-[7px] bg-teal-50 text-teal-600">${getWeatherLabel(item.weather)}</span></div></div><div class="flex gap-2"><button onclick="openMilestoneModal('edit','${id}','idea')" class="text-gray-400 font-bold">‚úè</button><button onclick="markAsDone('${id}')" class="text-teal-400 font-bold">‚úì</button><button onclick="deleteWish('${id}')" class="text-gray-200 text-xs">‚úï</button></div></div>`;
                    wishList.appendChild(card);
                });

                bucketIds.forEach(id => {
                    const item = data[id]; const isDone = item.status === 'done';
                    const div = document.createElement('div'); div.className = "mint-card p-4 bucket-card animate-slide-up relative " + (isDone ? "opacity-50" : "");
                    div.innerHTML = `<div class="absolute top-2 right-2"><button onclick="openMilestoneModal('edit', '${id}', 'bucket')" class="text-gray-400 hover:text-teal-500 p-1 bg-white/50 rounded-full shadow-sm">‚úèÔ∏è</button></div><div class="flex justify-between items-center"><div><p class="font-black text-yellow-700">${item.text} ‚ú®</p><p class="text-[9px] uppercase text-yellow-600 mt-1"><span class="font-bold">Von ${item.by}</span> ‚Ä¢ ${isDone ? 'Erreicht' : 'Bucket List'}</p></div>${!isDone ? `<button onclick="markAsDone('${id}')" class="text-yellow-600 font-bold text-lg mr-6">‚úì</button>` : ''}</div>`;
                    bucketList.appendChild(div);
                });

                // TIMELINE RENDERER (Ersetzt die alte Done-Liste)
                doneIds.forEach((id, index) => {
                    const item = data[id]; const timeStr = new Date(item.doneAt).toLocaleDateString('de-DE');
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = "timeline-wrapper animate-slide-up";
                    wrapper.style.animationDelay = (index * 0.1) + "s";
                    
                    let memoryHTML = "";
                    if(item.memoryPhoto) {
                        memoryHTML = `<img src="${item.memoryThumb || item.memoryPhoto}" loading="lazy" class="w-full h-24 object-cover rounded-lg mt-2 mb-1 shadow-sm border border-gray-100" onclick="openMemoryView('${id}')">`;
                    }
                    
                    // Comments Section
                    if(item.comments) {
                        const commentsArray = Object.values(item.comments);
                        memoryHTML += `<div class="mt-2 space-y-2">`;
                        commentsArray.forEach(comment => {
                            const isMeriam = comment.by === 'Meriam';
                            const cDate = new Date(comment.timestamp).toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit'});
                            const containerClass = isMeriam ? "bg-pink-50 border-pink-100 text-pink-800" : "bg-teal-50 border-teal-100 text-teal-800";
                            memoryHTML += `<div class="p-2 rounded-xl border ${containerClass} text-xs relative"><div class="flex justify-between items-center mb-1 opacity-70"><span class="font-bold">${comment.by}</span><span class="text-[8px]">${cDate}</span></div><p class="italic">"${comment.text}"</p></div>`;
                        });
                        memoryHTML += `</div>`;
                    } else if (item.memoryNote) {
                        memoryHTML += `<p class="text-[10px] italic text-gray-600 mt-2 bg-gray-50 p-2 rounded-lg border-l-2 border-pink-200">"${item.memoryNote}"</p>`;
                    }
                    
                    memoryHTML += `<button onclick="openCommentModal('${id}')" class="w-full mt-2 text-[10px] font-bold text-gray-400 border border-dashed border-gray-300 rounded-lg py-1.5 hover:bg-gray-50 uppercase tracking-widest">üìù Kommentieren</button>`;

                    // Rating Section
                    const hasMyRating = currentUser === 'Meriam' ? item.ratingMeriam : item.ratingSamet;
                    let ratingUI = "";
                    
                    if (hasMyRating) {
                        ratingUI = `<div class="mt-2 pt-2 border-t border-gray-100 flex items-center justify-between"><span class="text-[9px] font-bold text-gray-400 uppercase">Eure Ratings:</span><div class="flex gap-2"><div class="bg-pink-50 text-pink-500 text-[9px] font-bold px-2 py-1 rounded-md border border-pink-100">M: ${item.ratingMeriam || '-'}</div><div class="bg-teal-50 text-teal-600 text-[9px] font-bold px-2 py-1 rounded-md border border-teal-100">S: ${item.ratingSamet || '-'}</div></div></div>`;
                    } else {
                        ratingUI = `<div class="mt-2 pt-2 border-t border-gray-100"><p class="text-[9px] font-bold text-teal-600 uppercase tracking-widest mb-1 text-center animate-pulse">Deine Bewertung (1-10):</p><div class="flex flex-wrap justify-center gap-1">${[1,2,3,4,5,6,7,8,9,10].map(n => `<button onclick="playSound('pop'); saveRating('${id}', ${n})" class="rating-btn hover:bg-teal-500 hover:text-white w-6 h-6 text-[9px] shadow-sm">${n}</button>`).join('')}</div></div>`;
                    }

                    wrapper.innerHTML = `
                        <div class="timeline-line"></div>
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="mint-card p-3 relative">
                                <div class="absolute top-2 right-2"><button onclick="playSound('click'); openMilestoneModal('edit', '${id}')" class="text-gray-300 hover:text-teal-500 text-xs">‚úèÔ∏è</button></div>
                                <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">${timeStr}</span>
                                <h4 class="font-bold text-teal-800 text-sm leading-tight mt-1">${item.text}</h4>
                                ${item.location ? `<p class="text-[10px] text-gray-500 mt-1">üìç ${item.location}</p>` : ''}
                                ${memoryHTML}
                                ${ratingUI}
                            </div>
                        </div>
                    `;
                    archiveList.appendChild(wrapper);
                });
            });
        };

        // --- NEW QUIZ INTERACTION LOGIC ---
        // --- QUIZ ARENA v2 (A/B/C + 10s Timer + Reveal + Check) ---
        let quiz2Cache = {};
        let quiz2ActiveId = null;
        let quiz2Timer = null;
        let quiz2TimeLeft = 0;

        const quiz2GetUser = () => {
            return sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser') || "";
        };

        const quiz2Els = () => ({
            wrap: document.getElementById('quiz2-wrap'),
            listOpen: document.getElementById('quiz2-list-open'),
            listDone: document.getElementById('quiz2-list-done'),
            play: document.getElementById('quiz2-play'),
            by: document.getElementById('quiz2-by'),
            q: document.getElementById('quiz2-question'),
            timer: document.getElementById('quiz2-timer'),
            status: document.getElementById('quiz2-status'),
            result: document.getElementById('quiz2-result'),
            resultSub: document.getElementById('quiz2-result-sub'),
            btnA: document.getElementById('quiz2-btn-A'),
            btnB: document.getElementById('quiz2-btn-B'),
            btnC: document.getElementById('quiz2-btn-C'),
            txtA: document.getElementById('quiz2-text-A'),
            txtB: document.getElementById('quiz2-text-B'),
            txtC: document.getElementById('quiz2-text-C'),
            addBtn: document.getElementById('btn-quiz2-add'),
            backBtn: document.getElementById('btn-quiz2-back'),
            checkBtn: document.getElementById('btn-quiz2-check'),
            createHint: document.getElementById('quiz2-create-hint'),
            inQ: document.getElementById('quiz2-q'),
            inA: document.getElementById('quiz2-a'),
            inB: document.getElementById('quiz2-b'),
            inC: document.getElementById('quiz2-c'),
        });

        const quiz2StopTimer = () => {
            if (quiz2Timer) clearInterval(quiz2Timer);
            quiz2Timer = null;
        };

        const quiz2SetAnswerButtonsEnabled = (enabled) => {
            const { btnA, btnB, btnC } = quiz2Els();
            [btnA, btnB, btnC].forEach(b => {
                if (!b) return;
                b.disabled = !enabled;
            });
        };

        const quiz2ResetAnswerStyles = () => {
            const { btnA, btnB, btnC } = quiz2Els();
            [btnA, btnB, btnC].forEach(b => {
                if (!b) return;
                b.classList.remove('quiz2-wrong', 'quiz2-right', 'quiz2-reveal');
            });
        };

        const quiz2MarkReveal = (item, chosen) => {
            const { btnA, btnB, btnC, result, resultSub } = quiz2Els();
            const map = { A: btnA, B: btnB, C: btnC };
            quiz2ResetAnswerStyles();

            const correctBtn = map[item.correct];
            const chosenBtn = map[chosen];

            if (chosen && chosenBtn) {
                if (chosen === item.correct) {
                    chosenBtn.classList.add('quiz2-right');
                } else {
                    chosenBtn.classList.add('quiz2-wrong');
                    if (correctBtn) correctBtn.classList.add('quiz2-right', 'quiz2-reveal');
                }
            } else {
                // TIMEOUT / no choice
                if (correctBtn) correctBtn.classList.add('quiz2-right', 'quiz2-reveal');
            }

            const chosenLabel = chosen ? chosen : "‚Äî";
            if (!chosen) {
                result.textContent = "‚è±Ô∏è Zeit abgelaufen!";
                resultSub.textContent = `Richtig w√§re: ${item.correct}`;
                playSound && playSound('click');
            } else if (chosen === item.correct) {
                result.textContent = "‚úÖ Richtig!";
                resultSub.textContent = `Du hast ${chosenLabel} gew√§hlt.`;
                playSound && playSound('success');
            } else {
                result.textContent = "‚ùå Falsch!";
                resultSub.textContent = `Du hast ${chosenLabel} gew√§hlt. Richtig w√§re: ${item.correct}`;
                playSound && playSound('click');
            }
        };

        const quiz2StartTimer = (seconds, onTimeout) => {
            const { timer, status } = quiz2Els();
            quiz2StopTimer();
            quiz2TimeLeft = seconds;
            if (timer) timer.textContent = String(quiz2TimeLeft);
            if (status) status.textContent = `Du hast ${seconds} Sekunden.`;

            quiz2Timer = setInterval(() => {
                quiz2TimeLeft -= 1;
                if (timer) timer.textContent = String(Math.max(0, quiz2TimeLeft));
                if (quiz2TimeLeft <= 0) {
                    quiz2StopTimer();
                    onTimeout && onTimeout();
                }
            }, 1000);
        };

        const quiz2Open = (id) => {
            const els = quiz2Els();
            const item = quiz2Cache[id];
            if (!item) return;

            quiz2ActiveId = id;
            quiz2StopTimer();
            quiz2ResetAnswerStyles();
            els.result.textContent = "";
            els.resultSub.textContent = "";

            els.play.classList.remove('hidden');
            els.by.textContent = item.by || "?";
            els.q.textContent = item.q || "?";
            els.txtA.textContent = item.a || "";
            els.txtB.textContent = item.b || "";
            els.txtC.textContent = item.c || "";

            // Default: disable, enable only if playable
            quiz2SetAnswerButtonsEnabled(false);
            els.checkBtn.classList.add('hidden');
            els.timer.textContent = "10";

            const me = quiz2GetUser();

            if (item.status === "open") {
                // Only partner answers (logical)
                if (me && item.by && me !== item.by) {
                    els.status.textContent = "Rate jetzt!";
                    quiz2SetAnswerButtonsEnabled(true);

                    quiz2StartTimer(10, () => {
                        // time expired -> mark as answered with no choice
                        quiz2SubmitAnswer(null, true);
                    });
                } else {
                    els.status.textContent = "Warte auf Partner‚Ä¶";
                    els.result.textContent = "";
                    els.resultSub.textContent = "";
                }
            } else {
                // answered / checked
                els.status.textContent = item.status === "checked" ? "Abgehakt ‚úÖ" : "Beantwortet";
                quiz2SetAnswerButtonsEnabled(false);
                quiz2MarkReveal(item, item.chosen || null);

                if (item.status === "answered") {
                    els.checkBtn.classList.remove('hidden');
                }
            }

            // Scroll into view (nice on small screens)
            try { els.play.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch(e) {}
        };

        const quiz2SubmitAnswer = async (choice, isTimeout=false) => {
            const item = quiz2Cache[quiz2ActiveId];
            if (!item || item.status !== "open") return;

            const me = quiz2GetUser();
            if (!me || me === item.by) return; // creator doesn't answer

            quiz2StopTimer();
            quiz2SetAnswerButtonsEnabled(false);

            // Immediate local reveal
            quiz2MarkReveal(item, choice);

            // persist
            const payload = {
                status: "answered",
                answerBy: me,
                chosen: choice ? String(choice) : null,
                answeredAt: Date.now()
            };
            await update(ref(db, `quiz/${quiz2ActiveId}`), payload);

            // show check button after answered
            const { checkBtn, status } = quiz2Els();
            if (status) status.textContent = isTimeout ? "Zeit abgelaufen" : "Beantwortet";
            if (checkBtn) checkBtn.classList.remove('hidden');
        };

        const renderQuiz2Lists = (data) => {
            quiz2Cache = data || {};
            const { listOpen, listDone, play } = quiz2Els();
            if (!listOpen || !listDone) return;

            const items = Object.keys(quiz2Cache).map(id => ({ id, ...quiz2Cache[id] }));
            // newest first
            items.sort((x, y) => (y.createdAt || 0) - (x.createdAt || 0));

            const open = items.filter(it => it.status !== "checked");
            const done = items.filter(it => it.status === "checked");

            const renderList = (container, arr, emptyText) => {
                container.innerHTML = "";
                if (!arr.length) {
                    const p = document.createElement('p');
                    p.className = "text-[10px] text-gray-400 italic px-1";
                    p.textContent = emptyText;
                    container.appendChild(p);
                    return;
                }
                arr.forEach(it => {
                    const div = document.createElement('div');
                    div.className = "p-3 bg-pink-50 rounded-xl text-xs flex justify-between items-center shadow-sm animate-slide-up cursor-pointer hover:bg-pink-100 transition-colors";
                    const badge = it.status === "open" ? "üü£ Offen" : (it.status === "answered" ? "üü¢ Beantwortet" : "‚úÖ Abgehakt");
                    const who = it.by ? `von ${it.by}` : "";
                    div.innerHTML = `<div>
                        <p class="font-bold">${badge} ‚Ä¢ ${who}</p>
                        <p class="text-[10px] text-gray-500 mt-1">${(it.q || "").slice(0, 60)}${(it.q || "").length > 60 ? "‚Ä¶" : ""}</p>
                    </div>
                    <span class="text-xl">üëâ</span>`;
                    div.onclick = () => quiz2Open(it.id);
                    container.appendChild(div);
                });
            };

            renderList(listOpen, open, "Noch keine Quizfragen üôÇ");
            renderList(listDone, done, "Noch nichts abgehakt.");

            // If currently open in play view, re-open to refresh reveal state
            if (quiz2ActiveId && quiz2Cache[quiz2ActiveId] && play && !play.classList.contains('hidden')) {
                quiz2Open(quiz2ActiveId);
            }
        };

        const initQuiz2Once = () => {
            const els = quiz2Els();
            if (!els.wrap) return;

            // Answer clicks
            [els.btnA, els.btnB, els.btnC].forEach(btn => {
                if (!btn) return;
                btn.addEventListener('click', () => {
                    const choice = btn.getAttribute('data-choice');
                    if (!choice) return;
                    quiz2SubmitAnswer(choice, false);
                });
            });

            // Back
            if (els.backBtn) {
                els.backBtn.addEventListener('click', () => {
                    quiz2StopTimer();
                    els.play.classList.add('hidden');
                    quiz2ActiveId = null;
                });
            }

            // Check (anyone can check, only if answered)
            if (els.checkBtn) {
                els.checkBtn.addEventListener('click', async () => {
                    if (!quiz2ActiveId) return;
                    const item = quiz2Cache[quiz2ActiveId];
                    if (!item || item.status !== "answered") return;
                    await update(ref(db, `quiz/${quiz2ActiveId}`), { status: "checked", checkedAt: Date.now() });
                    playSound && playSound('success');
                });
            }

            // Create
            if (els.addBtn) {
                els.addBtn.addEventListener('click', async () => {
                    const me = quiz2GetUser();
                    const q = (els.inQ?.value || "").trim();
                    const a = (els.inA?.value || "").trim();
                    const b = (els.inB?.value || "").trim();
                    const c = (els.inC?.value || "").trim();
                    const correct = (document.querySelector('input[name="quiz2-correct"]:checked')?.value || "A");

                    const hint = els.createHint;
                    const showHint = (msg) => {
                        if (!hint) return;
                        hint.textContent = msg;
                        hint.classList.remove('hidden');
                        setTimeout(() => hint.classList.add('hidden'), 2200);
                    };

                    if (!me) return showHint("Bitte erst einloggen.");
                    if (!q || !a || !b || !c) return showHint("Bitte Frage + A/B/C ausf√ºllen üôÇ");

                    await push(ref(db, 'quiz'), {
                        q, a, b, c,
                        correct,
                        by: me,
                        createdAt: Date.now(),
                        status: "open",
                        answerBy: null,
                        chosen: null,
                        answeredAt: null
                    });

                    // clear
                    els.inQ.value = "";
                    els.inA.value = "";
                    els.inB.value = "";
                    els.inC.value = "";
                    showHint("Gespeichert ‚úÖ");
                    playSound && playSound('success');
                });
            }
        };

        initQuiz2Once();
        window.markAsDone = (id) => { currentCompletingId = id; openMemoryModalInternal(); };
        window.openCommentModal = (id) => { currentCompletingId = id; openMemoryModalInternal(); }
        const openMemoryModalInternal = () => {
            document.getElementById('memory-modal').classList.remove('hidden');
            const fileEl = document.getElementById('memory-photo-file');
            if (fileEl) fileEl.value = "";
            const prev = document.getElementById('preview-image');
            if (prev) prev.classList.add('hidden');
            const thumbs = document.getElementById('memory-thumbs');
            if (thumbs) { thumbs.classList.add('hidden'); thumbs.innerHTML = ""; }
            document.getElementById('upload-text').innerText = "üì∏ Fotos hinzuf√ºgen (max 3)";
            currentPhotoBase64 = "";
            currentPhotosBase64 = [];
            currentThumbIndex = 0;
            document.getElementById('memory-note').value = "";
        }
        window.closeMemoryModal = () => { document.getElementById('memory-modal').classList.add('hidden'); currentCompletingId = null; };

        document.getElementById('btn-save-memory').onclick = async () => {
            if (!currentCompletingId) return;
            const saveBtn = document.getElementById('btn-save-memory');
            saveBtn.disabled = true;
            const oldText = saveBtn.innerText;
            saveBtn.innerText = "‚è≥ L√§dt hoch...";

            const note = document.getElementById('memory-note').value.trim();
            const user = sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser');
            const updates = {};
            updates[`wishes/${currentCompletingId}/status`] = 'done';
            const snapshot = await get(ref(db, `wishes/${currentCompletingId}`)); const item = snapshot.val();
            if (item && item.status !== 'done') updates[`wishes/${currentCompletingId}/doneAt`] = Date.now();
          if (currentPhotosBase64 && currentPhotosBase64.length) {
                const uploaded = [];
                for (let i = 0; i < currentPhotosBase64.length; i++) {
                    const { fullUrl, thumbUrl } = await uploadPhotoForWishAtIndex(currentCompletingId, i, currentPhotosBase64[i]);
                    uploaded.push({ fullUrl, thumbUrl });
                }
                // Persist array + selected thumb index
                updates[`wishes/${currentCompletingId}/memoryPhotos`] = uploaded;
                updates[`wishes/${currentCompletingId}/memoryThumbIndex`] = currentThumbIndex || 0;

                // Backwards compatible fields (f√ºr Karten + Map-Pin)
                const sel = uploaded[currentThumbIndex] || uploaded[0] || {};
                updates[`wishes/${currentCompletingId}/memoryPhoto`] = sel.fullUrl || "";
                updates[`wishes/${currentCompletingId}/memoryThumb`] = sel.thumbUrl || "";
            } else if (currentPhotoBase64) {
                // Fallback: single photo (alte Logik)
                const { fullUrl, thumbUrl } = await uploadPhotoForWish(currentCompletingId, currentPhotoBase64);
                updates[`wishes/${currentCompletingId}/memoryPhoto`] = fullUrl;
                updates[`wishes/${currentCompletingId}/memoryThumb`] = thumbUrl;
            }


            if (note) {
                // F√ºr Viewer / Zeitreise
                updates[`wishes/${currentCompletingId}/memoryNote`] = note;

                // Zus√§tzlich als Kommentar (wie bisher)
                const commentId = push(ref(db, `wishes/${currentCompletingId}/comments`)).key;
                updates[`wishes/${currentCompletingId}/comments/${commentId}`] = { text: note, by: user, timestamp: Date.now() };
            }
            await update(ref(db), updates); closeMemoryModal(); document.getElementById('result-box').classList.add('hidden');
            saveBtn.disabled = false;
            saveBtn.innerText = oldText;

        };

        window.saveRating = (id, val) => { const u = sessionStorage.getItem('currentUser'); const field = u === 'Meriam' ? 'ratingMeriam' : 'ratingSamet'; const up = {}; up[field] = val; update(ref(db, `wishes/${id}`), up); };
        window.deleteWish = (id) => remove(ref(db, `wishes/${id}`));

        document.getElementById('btn-add').onclick = () => {
            const input = document.getElementById('wish-input'); if(!input.value.trim()) return;
            push(ref(db, 'wishes'), { text: input.value, location: document.getElementById('location-input').value.trim(), info: document.getElementById('info-input').value.trim(), cat: document.getElementById('cat-select').value, weather: document.getElementById('weather-select').value, surprise: document.getElementById('surprise-toggle').checked, isBucket: document.getElementById('bucket-toggle').checked, by: (sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser')), timestamp: Date.now(), status: 'open' });
            input.value = ""; document.getElementById('location-input').value = ""; document.getElementById('info-input').value = ""; document.getElementById('surprise-toggle').checked = false; document.getElementById('bucket-toggle').checked = false;
        };

        document.getElementById('btn-roll').onclick = () => {
            const btn = document.getElementById('btn-roll');
            const diceContainer = document.getElementById('dice-container');
            const cube = document.getElementById('cube-3d');
            const lockScreen = document.getElementById('lock-screen');
            const resBox = document.getElementById('result-box');
            const flash = document.getElementById('flash-layer');
            const lockText = document.getElementById('lock-text');
            const lockSvg = document.querySelector('.lock-svg');

            resBox.classList.add('hidden'); resBox.classList.remove('magic-pop-in');
            lockScreen.classList.add('hidden'); diceContainer.classList.remove('hidden'); diceContainer.style.opacity = "1";
            lockSvg.classList.remove('lock-open', 'lock-rattle', 'lock-pop-in');

            onValue(ref(db, 'wishes'), (snap) => {
                const data = snap.val(); if(!data) return;
                let wishes = Object.keys(data).filter(id => data[id].status === 'open' && !data[id].isBucket);
                const fCat = document.getElementById('filter-cat').value; if(fCat !== "Alle") wishes = wishes.filter(id => data[id].cat === fCat);
                if(wishes.length === 0) return alert("Nichts gefunden!"); 
                rolledDateId = wishes[Math.floor(Math.random() * wishes.length)]; const chosen = data[rolledDateId];

                cube.classList.add('is-spinning'); playSound('dice'); btn.disabled = true; btn.innerHTML = "üé≤ W√úRFELT...";

                setTimeout(() => {
                    cube.classList.remove('is-spinning');
                    if(chosen.surprise) {
                        diceContainer.classList.add('hidden'); lockScreen.classList.remove('hidden'); lockSvg.classList.add('lock-pop-in'); lockText.innerText = "GEHEIME MISSION...";
                        playSound('lock');
                        setTimeout(() => { lockSvg.classList.add('lock-rattle'); lockText.innerText = "ZUGRIFF GEPR√úFT..."; }, 800);
                        setTimeout(() => { 
                            lockSvg.classList.remove('lock-rattle'); lockSvg.classList.add('lock-open'); flash.classList.add('do-flash'); lockText.innerText = "ZUGRIFF ERLAUBT!"; lockText.classList.add('text-green-500'); 
                            playSound('reveal');
                            setTimeout(() => { lockScreen.classList.add('hidden'); flash.classList.remove('do-flash'); showResult(chosen); btn.disabled = false; btn.innerText = "W√úRFELN"; lockText.classList.remove('text-green-500'); }, 1000); 
                        }, 2500);
                    } else {
                        diceContainer.classList.add('hidden'); showResult(chosen); document.getElementById('result-box').classList.add('magic-pop-in'); 
                        playSound('reveal'); 
                        btn.disabled = false; btn.innerText = "W√úRFELN";
                    }
                }, 1500);
            }, { onlyOnce: true });
        };

        const showResult = (chosen) => {
            const resBox = document.getElementById('result-box'); 
            document.getElementById('final-choice').innerText = chosen.text;
            document.getElementById('final-info').innerText = chosen.info ? chosen.info : "";
            const catMap = { 'Sofort': '‚ö° Spontan m√∂glich', 'Planung': 'üìÖ Planung n√∂tig' };
            const weatherMap = { 'Egal': '‚òÅÔ∏è Wetter spielt keine Rolle', 'Sonne': '‚òÄÔ∏è Bei Sonne sch√∂ner', 'Regen': 'üè† Indoor / Auch bei schlechten Wetter m√∂glich' };
            document.getElementById('result-labels').innerHTML = `<span class="user-badge bg-teal-50 text-teal-600 border border-teal-100">${catMap[chosen.cat] || chosen.cat}</span><span class="user-badge bg-teal-50 text-teal-600 border border-teal-100">${weatherMap[chosen.weather] || chosen.weather}</span>`;
            
            if(chosen.location) { document.getElementById('map-frame').src = `https://maps.google.com/maps?q=${encodeURIComponent(chosen.location)}&output=embed`; document.getElementById('map-container').classList.remove('hidden'); } 
            else document.getElementById('map-container').classList.add('hidden');
            
            const b = document.getElementById('result-creator-badge'); 
            // UPDATED LABEL LOGIC
            if(chosen.surprise) {
                 b.innerText = "Versteckte Idee von " + chosen.by + " üîí";
                 b.className = "user-badge bg-gray-800 text-white border border-gray-600";
            } else {
                 b.innerText = "Idee von " + chosen.by;
                 b.className = "user-badge " + (chosen.by === 'Meriam' ? 'badge-meriam' : 'badge-samet');
            }

            resBox.classList.remove('hidden'); document.getElementById('unfold-wrapper').classList.add('unfold-anim');
            document.getElementById('challenge-display').classList.add('hidden'); document.getElementById('challenge-btn-container').classList.remove('hidden');
        };

        document.getElementById('btn-accept-date-only-main').onclick = () => { window.startActiveDate(rolledDateId); };
        document.getElementById('btn-accept-both').onclick = () => { window.startActiveDate(rolledDateId); };
        document.getElementById('btn-accept-date-only-sub').onclick = () => { window.startActiveDate(rolledDateId); };
        document.getElementById('btn-logout').onclick = () => { sessionStorage.removeItem('currentUser'); sessionStorage.removeItem('lastActive'); location.reload(); };
        
        document.getElementById('btn-movie-diplomat').onclick = async () => {
            const prefM = document.getElementById('movie-pref-meriam').value.trim();
            const prefS = document.getElementById('movie-pref-samet').value.trim();
            const btn = document.getElementById('btn-movie-diplomat');
            const resBox = document.getElementById('movie-result');
            const resText = document.getElementById('movie-text');
            if (!prefM || !prefS) return alert("Bitte gebt beide eine Richtung an! üçø");
            const originalText = btn.innerText; btn.innerText = "üîç Scanne Datenbank..."; btn.disabled = true; resBox.classList.remove('hidden'); resText.style.opacity = '0.5'; resText.innerText = "Analysiere Genres...\nSuche Kompromiss...";
            const prompt = `Agiere als Film-Experte f√ºr ein Paar. Sie will: "${prefM}". Er will: "${prefS}". Finde exakt 3 existierende Filme, die den perfekten Kompromiss bilden. Format pro Zeile: "Titel (Jahr) - Kurze Begr√ºndung". W√§hle nur gute Filme (IMDb 7.0+). Antworte auf Deutsch.`;
            const suggestion = await callAI(prompt);
            resText.innerText = suggestion ? suggestion : "Keine Verbindung zu Hollywood. Probier's nochmal!";
            resText.style.opacity = '1'; btn.innerText = originalText; 
            btn.disabled = false;
            playSound('netflix-pop');
        };
        
        
        // --- NEW (Index04): Polaroids (Instax Mini) ---
        const setGalleryMode = (mode) => {
            galleryMode = mode;
            const btnDates = document.getElementById('btn-gallery-dates');
            const btnPol = document.getElementById('btn-gallery-polaroids');
            const gridDates = document.getElementById('gallery-grid');
            const polPane = document.getElementById('polaroid-pane');
            if (!btnDates || !btnPol || !gridDates || !polPane) return;

            if (mode === "polaroids") {
                gridDates.classList.add('hidden');
                polPane.classList.remove('hidden');
                btnPol.className = "px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/80 border border-gray-200 text-gray-700 shadow-sm active:scale-95";
                btnDates.className = "px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/60 border border-gray-200 text-gray-500 shadow-sm active:scale-95";
            } else {
                polPane.classList.add('hidden');
                gridDates.classList.remove('hidden');
                btnDates.className = "px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/80 border border-gray-200 text-gray-700 shadow-sm active:scale-95";
                btnPol.className = "px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest bg-white/60 border border-gray-200 text-gray-500 shadow-sm active:scale-95";
            }
        };

        const openPolaroidModal = () => {
            const modal = document.getElementById('polaroid-modal');
            const area = document.getElementById('polaroid-crop-area');
            const upText = document.getElementById('polaroid-upload-text');
            const file = document.getElementById('polaroid-file');
            const zoom = document.getElementById('polaroid-zoom');
            const note = document.getElementById('polaroid-note');
            const loc = document.getElementById('polaroid-location');
            const date = document.getElementById('polaroid-date');

            if (!modal) return;
            modal.classList.remove('hidden');
            if (area) area.classList.add('hidden');
            if (upText) upText.innerText = "üì∏ Foto ausw√§hlen";
            if (file) file.value = "";
            if (zoom) zoom.value = "1";
            polaroidZoom = 1; // will be recalculated after image load
            polaroidPanX = 0; polaroidPanY = 0;
            polaroidImg = null;
            if (note) note.value = "";
            if (loc) loc.value = "";
            if (date) {
                const d = new Date();
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                date.value = `${yyyy}-${mm}-${dd}`;
            }
            drawPolaroidCropPreview();
        };

        const closePolaroidModal = () => {
            const modal = document.getElementById('polaroid-modal');
            if (modal) modal.classList.add('hidden');
        };

        const drawRoundedRect = (ctx, x, y, w, h, r) => {
            const rr = Math.min(r, w / 2, h / 2);
            ctx.beginPath();
            ctx.moveTo(x + rr, y);
            ctx.arcTo(x + w, y, x + w, y + h, rr);
            ctx.arcTo(x + w, y + h, x, y + h, rr);
            ctx.arcTo(x, y + h, x, y, rr);
            ctx.arcTo(x, y, x + w, y, rr);
            ctx.closePath();
        };

        const drawPolaroidCropPreview = () => {
            const canvas = document.getElementById('polaroid-crop-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            const W = canvas.width, H = canvas.height;

            // Polaroid card background
            ctx.clearRect(0, 0, W, H);
            ctx.fillStyle = "#ffffff";
            drawRoundedRect(ctx, 10, 10, W - 20, H - 20, 18);
            ctx.fill();
            ctx.strokeStyle = "rgba(226,232,240,0.9)";
            ctx.lineWidth = 2;
            ctx.stroke();

            // Photo window
            const pad = 26;
            const cardX = 10, cardY = 10, cardW = W - 20, cardH = H - 20;
            const winX = cardX + pad;
            const winY = cardY + pad;
            const winW = cardW - pad * 2;

            // Instax mini image window ratio: 46 x 62 (w/h)
            const winH = Math.round(winW * (62 / 46));

            // Clip & draw image
            ctx.save();
            drawRoundedRect(ctx, winX, winY, winW, winH, 10);
            ctx.clip();

            ctx.fillStyle = "#ffffff";
            ctx.fillRect(winX, winY, winW, winH);

            if (polaroidImg) {
                const cx = winX + winW / 2 + polaroidPanX;
                const cy = winY + winH / 2 + polaroidPanY;

                const scale = polaroidZoom;
                const drawW = polaroidImgW * scale;
                const drawH = polaroidImgH * scale;

                ctx.drawImage(polaroidImg, cx - drawW / 2, cy - drawH / 2, drawW, drawH);
            }
            ctx.restore();

            // Note preview
            const noteY = winY + winH + 14;
            ctx.fillStyle = "rgba(148,163,184,0.35)";
            ctx.fillRect(winX, noteY, winW, 1);

            const note = document.getElementById('polaroid-note')?.value || "";
            const date = document.getElementById('polaroid-date')?.value || "";
            const loc = document.getElementById('polaroid-location')?.value || "";

            ctx.fillStyle = "#334155";
            ctx.font = "22px Caveat, cursive";
            const lines = (note || "").split("\n").slice(0, 3);
            lines.forEach((ln, i) => ctx.fillText(ln.slice(0, 22), winX + 4, noteY + 28 + i * 22));

            ctx.fillStyle = "#94a3b8";
            ctx.font = "bold 9px Quicksand, sans-serif";
            const sub = [date, loc].filter(Boolean).join(" ‚Ä¢ ");
            ctx.fillText(sub.slice(0, 34), winX + 4, noteY + 92);
        };

        
        // --- FUNZONE: Eins oder Zwei (Wheel) ---
        const initOneTwoWheel = () => {
            const wheel = document.getElementById('one-two-wheel');
            const btn = document.getElementById('btn-one-two-spin');
            const res = document.getElementById('one-two-result');
            const opt1 = document.getElementById('one-two-opt1');
            const opt2 = document.getElementById('one-two-opt2');

            if (!wheel || !btn || !res || !opt1 || !opt2) return;

            // restore last options (local only)
            try {
                const s1 = localStorage.getItem('oneTwoOpt1');
                const s2 = localStorage.getItem('oneTwoOpt2');
                if (s1) opt1.value = s1;
                if (s2) opt2.value = s2;
            } catch (e) {}

            let spinning = false;
            let currentAngle = 0;

            const chooseAndSpin = () => {
                const a = (opt1.value || '').trim();
                const b = (opt2.value || '').trim();

                if (!a || !b) {
                    res.textContent = "Bitte beide Optionen eintragen üôÇ";
                    playSound && playSound('click');
                    return;
                }

                // persist options
                try {
                    localStorage.setItem('oneTwoOpt1', a);
                    localStorage.setItem('oneTwoOpt2', b);
                } catch (e) {}

                if (spinning) return;
                spinning = true;
                btn.disabled = true;
                res.textContent = "";

                // 1 = pink half (0..180), 2 = teal half (180..360)
                const choice = Math.random() < 0.5 ? 1 : 2;

                // Pick a target "pointer angle" within the chosen half.
                // We solve finalAngle so that the pointer (top) lands in that half.
                const minA = choice === 1 ? 20 : 200;
                const maxA = choice === 1 ? 160 : 340;
                const desiredPointerAngle = minA + Math.random() * (maxA - minA); // degrees

                const spins = 3 + Math.floor(Math.random() * 3); // 3..5
                const offset = (360 - (desiredPointerAngle % 360)) % 360;
                const finalAngle = (360 * spins) + offset;

                currentAngle = (currentAngle + finalAngle);
                wheel.style.transform = `rotate(${currentAngle}deg)`;

                const onEnd = () => {
                    const winner = (choice === 1) ? a : b;
                    res.textContent = `‚úÖ Ergebnis: ${choice} ‚Äî ${winner}`;
                    // reset inputs after draw
                    opt1.value = "";
                    opt2.value = "";
                    try { localStorage.removeItem('oneTwoOpt1'); localStorage.removeItem('oneTwoOpt2'); } catch (e) {}
                    spinning = false;
                    btn.disabled = false;
                };

                wheel.addEventListener('transitionend', onEnd, { once: true });
                playSound && playSound('click');
            };

            btn.addEventListener('click', chooseAndSpin);
        };

const initPolaroidCropCanvas = () => {
            const canvas = document.getElementById('polaroid-crop-canvas');
            if (!canvas) return;

            const getPoint = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
                return { x, y };
            };

            const down = (e) => {
                if (!polaroidImg) return;
                polaroidDragging = true;
                const p = getPoint(e);
                polaroidLast = p;
                e.preventDefault();
            };
            const move = (e) => {
                if (!polaroidDragging) return;
                const p = getPoint(e);
                polaroidPanX += (p.x - polaroidLast.x);
                polaroidPanY += (p.y - polaroidLast.y);
                polaroidLast = p;
                drawPolaroidCropPreview();
                e.preventDefault();
            };
            const up = () => { polaroidDragging = false; };

            canvas.addEventListener('mousedown', down);
            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', up);

            canvas.addEventListener('touchstart', down, { passive: false });
            window.addEventListener('touchmove', move, { passive: false });
            window.addEventListener('touchend', up);
        };

        const renderPolaroidsGrid = (dataObj) => {
            const grid = document.getElementById('polaroid-grid');
            if (!grid) return;
            grid.innerHTML = "";
            const ids = Object.keys(dataObj || {}).sort((a, b) => (dataObj[b]?.createdAt || 0) - (dataObj[a]?.createdAt || 0));
            ids.forEach((id) => {
                const p = dataObj[id];
                if (!p) return;

                const div = document.createElement('div');
                div.className = "instax-card";
                div.onclick = () => {
                    // reuse existing fullscreen modal
                    const modal = document.getElementById('view-memory-modal');
                    if (!modal) return;
                    document.getElementById('view-img').src = p.fullUrl || p.thumbUrl || "";
                    document.getElementById('view-title').innerText = p.location ? p.location : "Polaroid";
                    document.getElementById('view-date').innerText = (p.date || "") + (p.by ? ` ‚Ä¢ ${p.by}` : "");
                    document.getElementById('view-note').innerText = p.note || "";
                    modal.classList.remove('hidden');
                };

                div.innerHTML = `
                    <img class="instax-photo" src="${p.thumbUrl || p.fullUrl || ""}" alt="Polaroid">
                    <div class="instax-meta">
                        <div class="instax-note">${(p.note || "").replace(/</g,"&lt;").slice(0, 80)}</div>
                        <div class="instax-sub">${[p.date, p.location].filter(Boolean).join(" ‚Ä¢ ")}</div>
                    </div>
                `;
                grid.appendChild(div);
            });
        };

        const makePolaroidFullCanvas = () => {
            // Full polaroid with white frame + note area
            const OUT_W = 900;
            const OUT_H = Math.round(OUT_W * (86 / 54)); // instax mini sheet ratio
            const canvas = document.createElement('canvas');
            canvas.width = OUT_W; canvas.height = OUT_H;
            const ctx = canvas.getContext('2d');

            // Background
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, OUT_W, OUT_H);

            // Slight shadow border (baked in)
            ctx.strokeStyle = "rgba(226,232,240,0.9)";
            ctx.lineWidth = 6;
            ctx.strokeRect(3, 3, OUT_W - 6, OUT_H - 6);

            // Photo window
            const pad = 70;
            const winW = OUT_W - pad * 2;
            const winH = Math.round(winW * (62 / 46));
            const winX = pad;
            const winY = pad;

            // Clip
            ctx.save();
            drawRoundedRect(ctx, winX, winY, winW, winH, 18);
            ctx.clip();
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(winX, winY, winW, winH);

            if (polaroidImg) {
                // Map preview pan/zoom to full canvas
                const prev = document.getElementById('polaroid-crop-canvas');
                const prevW = prev ? prev.width : 260;
                const prevH = prev ? prev.height : 360;
                const prevCardPad = 26;
                const prevWinW = (prevW - 20) - prevCardPad * 2;
                const prevWinH = Math.round(prevWinW * (62 / 46));

                const scaleX = winW / prevWinW;
                const scaleY = winH / prevWinH;

                const cx = winX + winW / 2 + polaroidPanX * scaleX;
                const cy = winY + winH / 2 + polaroidPanY * scaleY;

                const scale = polaroidZoom * scaleX; // keep consistent
                const drawW = polaroidImgW * scale;
                const drawH = polaroidImgH * scale;

                ctx.drawImage(polaroidImg, cx - drawW / 2, cy - drawH / 2, drawW, drawH);
            }
            ctx.restore();

            // Note
            const note = document.getElementById('polaroid-note')?.value || "";
            const date = document.getElementById('polaroid-date')?.value || "";
            const loc = document.getElementById('polaroid-location')?.value || "";

            ctx.fillStyle = "#334155";
            ctx.font = "52px Caveat, cursive";
            const lines = (note || "").split("\n").slice(0, 4);
            const textY = winY + winH + 110;
            lines.forEach((ln, i) => ctx.fillText(ln.slice(0, 28), winX + 8, textY + i * 58));

            ctx.fillStyle = "#94a3b8";
            ctx.font = "bold 22px Quicksand, sans-serif";
            const sub = [date, loc].filter(Boolean).join(" ‚Ä¢ ");
            ctx.fillText(sub.slice(0, 60), winX + 10, OUT_H - 60);

            return canvas;
        };

        const makeThumbDataUrl = (imgDataUrl) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 420;
                    let w = img.width, h = img.height;
                    if (w > MAX) { h = Math.round(h * (MAX / w)); w = MAX; }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
                img.src = imgDataUrl;
            });
        };

        const uploadPolaroidImages = async (id, fullDataUrl) => {
            const fullRef = sRef(storage, `polaroids/${id}/full.jpg`);
            await uploadString(fullRef, fullDataUrl, 'data_url');
            const fullUrl = await getDownloadURL(fullRef);

            const thumbData = await makeThumbDataUrl(fullDataUrl);
            const thumbRef = sRef(storage, `polaroids/${id}/thumb.jpg`);
            await uploadString(thumbRef, thumbData, 'data_url');
            const thumbUrl = await getDownloadURL(thumbRef);

            return { fullUrl, thumbUrl };
        };

        const savePolaroid = async () => {
            try {
                if (!polaroidImg) return alert("Bitte zuerst ein Foto ausw√§hlen.");
                const btn = document.getElementById('btn-save-polaroid');
                const old = btn ? btn.innerText : "";
                if (btn) { btn.disabled = true; btn.innerText = "‚è≥ L√§dt hoch..."; }

                const by = sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser') || "Unknown";
                const date = document.getElementById('polaroid-date')?.value || "";
                const location = document.getElementById('polaroid-location')?.value?.trim() || "";
                const note = document.getElementById('polaroid-note')?.value?.trim() || "";

                const id = push(ref(db, 'polaroids')).key;
                const fullCanvas = makePolaroidFullCanvas();
                const fullDataUrl = fullCanvas.toDataURL('image/jpeg', 0.82);

                const { fullUrl, thumbUrl } = await uploadPolaroidImages(id, fullDataUrl);

                await set(ref(db, `polaroids/${id}`), {
                    fullUrl, thumbUrl,
                    date, location, note,
                    by,
                    createdAt: Date.now()
                });

                closePolaroidModal();
                playSound('success');
                if (btn) { btn.disabled = false; btn.innerText = old; }
            } catch (e) {
                alert("Fehler: " + (e?.message || e));
                const btn = document.getElementById('btn-save-polaroid');
                if (btn) { btn.disabled = false; btn.innerText = "Speichern"; }
            }
        };

        const bindPolaroidUIOnce = () => {
            // Segmented buttons
            const btnDates = document.getElementById('btn-gallery-dates');
            const btnPol = document.getElementById('btn-gallery-polaroids');
            if (btnDates) btnDates.onclick = () => { playSound('click'); setGalleryMode("dates"); };
            if (btnPol) btnPol.onclick = () => { playSound('click'); setGalleryMode("polaroids"); };

            // Open upload modal
            const openBtn = document.getElementById('btn-open-polaroid');
            if (openBtn) openBtn.onclick = () => { playSound('pop'); openPolaroidModal(); };

            // Modal buttons
            const cancelBtn = document.getElementById('btn-cancel-polaroid');
            if (cancelBtn) cancelBtn.onclick = () => { playSound('click'); closePolaroidModal(); };

            const saveBtn = document.getElementById('btn-save-polaroid');
            if (saveBtn) saveBtn.onclick = () => { playSound('success'); savePolaroid(); };

            // Inputs re-render preview
            const note = document.getElementById('polaroid-note');
            const loc = document.getElementById('polaroid-location');
            const date = document.getElementById('polaroid-date');
            [note, loc, date].forEach(el => {
                if (!el) return;
                el.addEventListener('input', () => drawPolaroidCropPreview());
                el.addEventListener('change', () => drawPolaroidCropPreview());
            });

            // Zoom
            const zoom = document.getElementById('polaroid-zoom');
            if (zoom) zoom.oninput = () => { polaroidZoom = parseFloat(zoom.value || "1"); drawPolaroidCropPreview(); };

            // File change
            const file = document.getElementById('polaroid-file');
            if (file) file.onchange = () => {
                const f = file.files && file.files[0];
                if (!f) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Normalize: downscale large input to reasonable base (like existing memory flow)
                        const max = 1600;
                        let w = img.width, h = img.height;
                        const scale = Math.min(1, max / Math.max(w, h));
                        w = Math.round(w * scale); h = Math.round(h * scale);

                        const c = document.createElement('canvas');
                        c.width = w; c.height = h;
                        const cx = c.getContext('2d');
                        cx.drawImage(img, 0, 0, w, h);

                        polaroidImg = new Image();
                        polaroidImg.onload = () => {
                            polaroidImgW = polaroidImg.width;
                            polaroidImgH = polaroidImg.height;
                            polaroidPanX = 0; polaroidPanY = 0;

                            // Auto-Start-Zoom: so, dass das Foto nicht "zu nah" ist.
                            // Wir w√§hlen ein "cover"-Zoom f√ºr das Instax-Mini Fenster (46/62) und erlauben danach Zoom-Out/Zoom-In.
                            const canvas = document.getElementById('polaroid-crop-canvas');
                            const W = canvas ? canvas.width : 260;
                            const pad = 26;
                            const winW = (W - 20) - pad * 2;           // cardW = W-20
                            const winH = Math.round(winW * (62 / 46)); // Instax mini window
                            const coverZoom = Math.max(winW / polaroidImgW, winH / polaroidImgH);

                            polaroidZoom = Math.max(0.05, coverZoom);

                            const z = document.getElementById('polaroid-zoom');
                            if (z) {
                                const minZ = Math.max(0.05, coverZoom);
                                const maxZ = Math.max(minZ + 0.1, coverZoom * 2.5);
                                z.min = String(minZ);
                                z.max = String(maxZ);
                                z.value = String(polaroidZoom);
                            }

                            const area = document.getElementById('polaroid-crop-area');
                            if (area) area.classList.remove('hidden');
                            const upText = document.getElementById('polaroid-upload-text');
                            if (upText) upText.innerText = "‚úÖ Foto ausgew√§hlt";

                            drawPolaroidCropPreview();
                        };
                        polaroidImg.src = c.toDataURL('image/jpeg', 0.85);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(f);
            };

            initPolaroidCropCanvas();

            initOneTwoWheel();

            initDeepTalkChips();

            // Default mode
            setGalleryMode("dates");
        };



        checkAuth();
    </script>
</body>
</html>

