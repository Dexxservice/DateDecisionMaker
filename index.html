<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MerSam OS v3.3 - Spidey Special</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FCE4EC">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MerSam">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700;800&family=Caveat:wght@700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        /* Touch Optimierung */
        * { -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text; }
        
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #FCE4EC;
            color: #2D3748;
            padding-bottom: 100px;
            overflow-x: hidden;
            overscroll-behavior-y: none;
            transition: background 0.5s ease;
            position: relative;
        }

        /* --- THEMES --- */
        body.theme-original { background: linear-gradient(-45deg, #E0F2F1, #FCE4EC, #E0F7FA, #F8BBD0); background-size: 400% 400%; animation: gradient 15s ease infinite; }
        body.theme-midnight { background: linear-gradient(to bottom, #0f172a, #334155); color: #e2e8f0; }
        body.theme-sunset { background: linear-gradient(to bottom right, #ffedd5, #fdba74, #fb7185); }
        body.theme-fresh { background: linear-gradient(to top left, #d1fae5, #ecfccb, #ccfbf1); }
        
        /* SPIDERMAN THEME SPECIALS */
        body.theme-spiderman { 
            background: 
                radial-gradient(circle at 50% 50%, rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(135deg, #0d47a1 0%, #b71c1c 100%); 
            background-size: 20px 20px, 100% 100%; /* Netz-Effekt */
            color: #1a202c; 
        }
        body.theme-spiderman .pink-btn { background-color: #d32f2f; box-shadow: 0 4px 0 #b71c1c; } /* Spidey Red + Comic Shadow */
        body.theme-spiderman .pink-btn:active { background-color: #b71c1c; transform: translateY(4px); box-shadow: none; }
        body.theme-spiderman .teal-btn { background-color: #1565c0; box-shadow: 0 4px 0 #0d47a1; } /* Spidey Blue + Comic Shadow */
        body.theme-spiderman .teal-btn:active { background-color: #0d47a1; transform: translateY(4px); box-shadow: none; }
        body.theme-spiderman .mint-card { border: 3px solid #ef5350; } 
        body.theme-spiderman .hanging-spider { display: block !important; }

        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* H√§ngende Spinne (Deko oben) */
        .hanging-spider {
            display: none;
            position: fixed; top: -20px; right: 20px; width: 60px; height: 100px;
            z-index: 40; pointer-events: none;
            animation: swingSpider 3s ease-in-out infinite alternate; transform-origin: top center;
        }
        @keyframes swingSpider { from { transform: rotate(-5deg) translateY(0); } to { transform: rotate(5deg) translateY(5px); } }

        /* KRABBELNDE SPINNE (Random Event) */
        .crawler-spider {
            position: fixed; width: 50px; height: 50px; z-index: 10000; pointer-events: none;
            display: none;
        }
        .crawler-spider svg { fill: #222; filter: drop-shadow(2px 5px 2px rgba(0,0,0,0.3)); }
        
        .crawl-anim-1 { display: block; animation: crawlDiag 4s linear forwards; }
        @keyframes crawlDiag { 0% { top: 110vh; left: -10vw; transform: rotate(20deg); } 100% { top: -10vh; left: 110vw; transform: rotate(45deg); } }
        
        .crawl-anim-2 { display: block; animation: crawlDown 3s linear forwards; }
        @keyframes crawlDown { 0% { top: -10vh; left: 50vw; transform: rotate(180deg); } 100% { top: 110vh; left: 50vw; transform: rotate(180deg); } }

        /* Buttons & Cards */
        .pink-btn { background-color: #FF80AB; color: white; transition: all 0.2s; }
        .pink-btn:active { transform: scale(0.96); }
        .teal-btn { background-color: #14B8A6; color: white; transition: all 0.2s; }
        .teal-btn:active { transform: scale(0.96); }
        .mint-card { background: white; border-radius: 28px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); border: 1px solid rgba(178, 223, 219, 0.5); }
        .hidden { display: none !important; }
        
        /* Floating Hearts */
        .floating-heart { position: absolute; color: rgba(255, 128, 171, 0.6); animation: float 5s infinite linear; z-index: 0; pointer-events: none; }
        @keyframes float { 0% { transform: translateY(110vh) scale(0.5) rotate(0deg); opacity: 0; } 20% { opacity: 0.8; } 100% { transform: translateY(-10vh) scale(1.2) rotate(360deg); opacity: 0; } }

        /* 3D W√ºrfel */
        .scene { width: 80px; height: 80px; perspective: 600px; margin: 0 auto; cursor: pointer; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transform: translateZ(-40px); transition: transform 1s; }
        .cube.is-spinning { animation: spinCube 0.8s linear infinite; }
        @keyframes spinCube { 0% { transform: translateZ(-40px) rotateX(0deg) rotateY(0deg); } 100% { transform: translateZ(-40px) rotateX(360deg) rotateY(720deg); } }
        .cube__face { position: absolute; width: 80px; height: 80px; border: 2px solid white; background: linear-gradient(145deg, #ffffff, #f0f0f0); border-radius: 16px; display: flex; justify-content: center; align-items: center; backface-visibility: hidden; }
        .face-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); width: 60%; height: 60%; gap: 2px; }
        .dot { background-color: #EC4899; border-radius: 50%; width: 100%; height: 100%; }
        .d-center { grid-area: 2 / 2 / 3 / 3; } .d-tl { grid-area: 1 / 1 / 2 / 2; } .d-tr { grid-area: 1 / 3 / 2 / 4; } .d-ml { grid-area: 2 / 1 / 3 / 2; } .d-mr { grid-area: 2 / 3 / 3 / 4; } .d-bl { grid-area: 3 / 1 / 4 / 2; } .d-br { grid-area: 3 / 3 / 4 / 4; } 
        .cube__face--1 { transform: rotateY(  0deg) translateZ(40px); } .cube__face--2 { transform: rotateY( 90deg) translateZ(40px); } .cube__face--3 { transform: rotateY(180deg) translateZ(40px); } .cube__face--4 { transform: rotateY(-90deg) translateZ(40px); } .cube__face--5 { transform: rotateX( 90deg) translateZ(40px); } .cube__face--6 { transform: rotateX(-90deg) translateZ(40px); }

        /* Animationen */
        .animate-fade-in-down { animation: fadeInDown 0.8s ease-out forwards; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-scale-in { animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .magic-pop-in { animation: magicPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; transform-origin: center center; }
        @keyframes magicPop { 0% { opacity: 0; transform: scale(0.1) rotate(-10deg); filter: blur(10px); } 60% { transform: scale(1.1) rotate(2deg); } 100% { opacity: 1; transform: scale(1) rotate(0deg); filter: blur(0); } }

        /* Lock SVG */
        .lock-svg { width: 100px; height: 120px; overflow: visible; }
        .lock-body { fill: #EC4899; } .lock-shackle { fill: none; stroke: #9CA3AF; stroke-width: 12; stroke-linecap: round; transform-origin: 50% 35px; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .lock-pop-in { animation: popInLock 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popInLock { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .lock-rattle { animation: rattle 0.1s linear infinite; }
        @keyframes rattle { 0% { transform: rotate(0deg); } 25% { transform: rotate(2deg); } 75% { transform: rotate(-2deg); } 100% { transform: rotate(0deg); } }
        .lock-open .lock-shackle { transform: translateY(-25px) rotate(-45deg); stroke: #10B981; } .lock-open .lock-body { fill: #10B981; transition: fill 0.3s; }

        .flash-overlay { position: absolute; inset: 0; background: white; pointer-events: none; z-index: 50; opacity: 0; transition: opacity 1s; border-radius: 28px; }
        .do-flash { animation: flashAnim 0.8s ease-out forwards; }
        @keyframes flashAnim { 0% { opacity: 0; } 10% { opacity: 1; } 100% { opacity: 0; } }
        .unfold-anim { animation: unfold 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes unfold { 0% { transform: scaleY(0); opacity: 0; transform-origin: top; } 100% { transform: scaleY(1); opacity: 1; transform-origin: top; } }

        .user-badge { font-size: 9px; padding: 2px 8px; border-radius: 99px; font-weight: bold; text-transform: uppercase; }
        .badge-meriam { background-color: #fce4ec; color: #f06292; } .badge-samet { background-color: #e0f2f1; color: #00897b; }
        .filter-select { background-color: #f0fdfa; border: 1px solid #99f6e4; border-radius: 0.75rem; padding: 0.5rem; font-size: 0.875rem; outline: none; }
        .online-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; } .online { background-color: #4ADE80; box-shadow: 0 0 8px #4ADE80; } .offline { background-color: #CBD5E1; }
        .stat-card { text-align: center; padding: 18px 5px; display: flex; flex-direction: column; justify-content: space-between; }
        .stat-title { font-size: 0.55rem; text-transform: uppercase; color: #94A3B8; font-weight: 800; letter-spacing: 0.1em; margin-bottom: 4px; }
        .stat-val { font-size: 2rem; font-weight: 900; color: #111827; line-height: 1; }
        .stat-label { font-size: 0.5rem; color: #64748B; font-weight: 700; margin-top: 6px; text-transform: uppercase; }
        .rating-btn { width: 24px; height: 24px; font-size: 9px; font-weight: bold; border-radius: 6px; border: 1px solid #E2E8F0; background: white; color: #64748B; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        
        .nav-bar { 
            position: fixed; bottom: 0; width: 100%; max-width: 448px; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            border-top: 1px solid #B2DFDB; display: flex; justify-content: space-around; 
            padding: 12px 0 25px 0; 
            z-index: 1000; 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; font-weight: bold; color: #94A3B8; cursor: pointer; transition: transform 0.1s; } 
        .nav-item:active { transform: scale(0.9); }
        .nav-item.active { color: #14B8A6; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; } .switch input { opacity: 0; width: 0; height: 0; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; } .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: #FF80AB; } input:checked + .slider:before { transform: translateX(20px); }
        .bucket-card { border: 2px solid #FFD700; background: linear-gradient(to bottom right, #FFFFFF, #FFFDF0); }
        .sparkle-btn { background: linear-gradient(135deg, #A855F7, #EC4899); color: white; transition: all 0.3s ease; } .sparkle-btn:hover { filter: brightness(1.1); transform: scale(1.05); box-shadow: 0 0 15px rgba(168, 85, 247, 0.4); }
        .chest-shake { animation: shakeChest 1s infinite; } @keyframes shakeChest { 0% { transform: rotate(0deg); } 25% { transform: rotate(-10deg); } 50% { transform: rotate(10deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; } @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* MAP */
        #map { height: 70vh; width: 100%; border-radius: 32px; border: 4px solid white; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04), inset 0 0 40px rgba(0,0,0,0.05); z-index: 1; background-color: #f8fafc; }
        .custom-map-marker-container { display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .custom-map-marker-container:hover { transform: scale(1.2) translateY(-10px); z-index: 1000 !important; }
        .custom-map-marker { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(4px); border: 2px solid #EC4899; border-radius: 12px; padding: 6px 12px; text-align: center; font-weight: 800; font-size: 11px; color: #831843; box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3); white-space: nowrap; position: relative; transform: translateY(-10px); }
        .custom-map-marker::after { content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px; border-width: 6px 6px 0; border-style: solid; border-color: #EC4899 transparent transparent transparent; }
        .map-photo-pin { width: 48px; height: 48px; border-radius: 50%; border: 3px solid white; outline: 3px solid #14B8A6; object-fit: cover; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); background-color: white; transition: all 0.3s; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .custom-map-marker-container::before { content: ''; position: absolute; width: 10px; height: 10px; background-color: #EC4899; border-radius: 50%; bottom: -5px; opacity: 0.5; animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.33); opacity: 0.8; } 80%, 100% { transform: scale(2); opacity: 0; } }
        .leaflet-control-zoom { border: none !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important; margin-bottom: 80px !important; }
        .leaflet-control-zoom a { background-color: white !important; color: #EC4899 !important; border-radius: 8px !important; border: 1px solid #fce7f3 !important; }
        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background-color: rgba(236, 72, 153, 0.2) !important; }
        .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div { background-color: #EC4899 !important; color: white !important; font-family: 'Quicksand', sans-serif; font-weight: 800; border-radius: 50%; box-shadow: 0 0 10px rgba(236, 72, 153, 0.4); }

        /* GALERIE (Polaroids) */
        .polaroid { background: white; padding: 6px 6px 24px 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 4px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; cursor: pointer; }
        .polaroid:active { transform: scale(0.98) !important; }
        .polaroid img { width: 100%; height: 130px; object-fit: cover; border-radius: 2px; background-color: #f0f0f0; }
        .polaroid-caption { font-size: 11px; color: #333; text-align: center; margin-top: 8px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: 'Caveat', cursive; letter-spacing: 0.5px; }
        .polaroid:nth-child(3n+1) { transform: rotate(2deg); }
        .polaroid:nth-child(3n+2) { transform: rotate(-2deg); margin-top: 10px; }
        .polaroid:nth-child(3n+3) { transform: rotate(1deg); }

        /* Theme Circles */
        .theme-circle { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; }
        .theme-circle.active { border-color: #333; transform: scale(1.1); }
    </style>
</head>
<body class="theme-original min-h-screen flex flex-col items-center select-none transition-colors duration-500">

    <div id="heart-container" class="fixed inset-0 pointer-events-none z-0 overflow-hidden"></div>

    <div class="hanging-spider">
        <svg viewBox="0 0 100 200" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="50" y1="0" x2="50" y2="150" stroke="white" stroke-width="1.5" />
            <circle cx="50" cy="160" r="10" fill="#b71c1c" stroke="white" stroke-width="2"/>
            <path d="M40 160 Q30 150 25 165 M40 160 Q30 170 25 180 M60 160 Q70 150 75 165 M60 160 Q70 170 75 180" stroke="#b71c1c" stroke-width="2" fill="none"/>
            <circle cx="47" cy="162" r="2" fill="white"/>
            <circle cx="53" cy="162" r="2" fill="white"/>
        </svg>
    </div>

    <div id="crawler" class="crawler-spider">
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <path d="M50 40 C 50 30 60 30 60 40 C 60 50 50 50 50 40" fill="black" />
            <circle cx="55" cy="40" r="8" fill="black" />
            <path d="M55 40 Q 30 20 20 30 M55 40 Q 80 20 90 30 M55 40 Q 20 40 10 50 M55 40 Q 90 40 100 50 M55 40 Q 30 60 20 50 M55 40 Q 80 60 90 50 M55 40 Q 40 70 30 80 M55 40 Q 70 70 80 80" stroke="black" stroke-width="3" fill="none" />
        </svg>
    </div>

    <div id="login-screen" class="w-full max-w-md px-8 flex flex-col justify-center min-h-screen relative overflow-hidden z-10">
        <div class="mint-card p-12 text-center relative z-10 bg-white/95 backdrop-blur-xl border-t-8 border-pink-400 shadow-2xl animate-scale-in">
            <div class="mb-10">
                <div class="flex items-center justify-center gap-3 mb-3">
                    <div class="w-4 h-4 border-2 border-pink-500 border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-pink-500 font-black text-xs uppercase tracking-[0.3em] animate-pulse">System Loading</p>
                </div>
                <h1 class="text-4xl font-black text-teal-800 tracking-tighter">MerSam OS</h1>
                <p class="text-[10px] text-gray-400 font-bold uppercase mt-2">Valentinstag '26 - Special Build</p>
            </div>
            
            <div id="user-selection" class="space-y-4">
                <p class="text-xs font-bold text-gray-500 uppercase mb-4">Profil ausw√§hlen</p>
                <button onclick="playSound('success'); startAuth('Meriam')" class="pink-btn w-full py-6 rounded-3xl font-black text-xl shadow-lg transition-all">Meriam</button>
                <button onclick="playSound('success'); startAuth('Samet')" class="teal-btn w-full py-6 rounded-3xl font-black text-xl shadow-lg transition-all">Samet</button>
            </div>

            <div id="password-area" class="hidden mt-6 animate-fade-in">
                <p id="password-msg" class="text-xs font-bold text-gray-500 mb-6 uppercase">Passwort erforderlich</p>
                <input type="password" id="pass-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full text-center p-5 bg-teal-50 rounded-2xl mb-6 outline-none text-3xl tracking-[0.4em] font-black border-2 border-teal-100 focus:border-pink-300 transition-all">
                <button id="btn-login-confirm" onclick="playSound('success')" class="pink-btn w-full py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl">Entsperren ‚ú®</button>
                <button onclick="playSound('click'); location.reload()" class="text-[10px] text-gray-400 mt-6 underline uppercase font-bold">Abbrechen</button>
            </div>
        </div>
        <footer class="text-center mt-12 relative z-10 animate-fade-in" style="animation-delay: 0.5s;">
            <p class="text-[9px] text-teal-900 font-black uppercase tracking-widest leading-loose opacity-70">
                Coded, Assembled & Designed by <br>
                <span class="text-teal-500 text-xs">Samet</span> f√ºr <span class="text-pink-500 text-xs">Meriam</span>
            </p>
        </footer>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="mint-card p-6 w-full max-w-sm relative shadow-2xl border-2 border-gray-200 animate-scale-in">
            <h3 class="text-xl font-black text-gray-700 mb-4">Einstellungen ‚öôÔ∏è</h3>
            
            <p class="text-xs font-bold text-gray-400 uppercase mb-2">Hintergrund Design</p>
            <div class="flex gap-3 mb-6 justify-center flex-wrap">
                <div onclick="setTheme('theme-original')" class="theme-circle bg-gradient-to-br from-pink-100 to-teal-100 shadow-md"></div>
                <div onclick="setTheme('theme-midnight')" class="theme-circle bg-slate-800 shadow-md"></div>
                <div onclick="setTheme('theme-spiderman')" class="theme-circle bg-gradient-to-br from-blue-700 to-red-700 shadow-md border-2 border-white relative overflow-hidden"><div class="absolute inset-0 opacity-30 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMCIgaGVpZ2h0PSIxMCI+PGNpcmNsZSBjeD0iNSIgY3k9IjUiIHI9IjEiIGZpbGw9IndoaXRlIi8+PC9zdmc+')]"></div></div>
                <div onclick="setTheme('theme-sunset')" class="theme-circle bg-orange-200 shadow-md"></div>
                <div onclick="setTheme('theme-fresh')" class="theme-circle bg-green-100 shadow-md"></div>
            </div>

            <p class="text-xs font-bold text-gray-400 uppercase mb-2">App Sounds</p>
            <div class="flex justify-between items-center mb-6 p-3 bg-gray-50 rounded-xl">
                <span class="text-sm font-bold text-gray-600">Sound Effekte</span>
                <label class="switch"><input type="checkbox" id="sound-toggle" onchange="toggleSound(this)"><span class="slider"></span></label>
            </div>

            <button onclick="localStorage.clear(); location.reload()" class="w-full text-xs text-red-400 font-bold border border-red-200 p-3 rounded-xl mb-2 hover:bg-red-50">‚ö†Ô∏è App Daten zur√ºcksetzen</button>
            <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="w-full bg-gray-200 text-gray-600 font-bold p-3 rounded-xl text-xs uppercase mt-2">Schlie√üen</button>
        </div>
    </div>

    <div id="view-memory-modal" class="hidden fixed inset-0 bg-black/80 z-[210] flex items-center justify-center p-6 backdrop-blur-md transition-opacity">
        <div class="relative w-full max-w-sm animate-scale-in">
            <button onclick="document.getElementById('view-memory-modal').classList.add('hidden')" class="absolute -top-10 right-0 text-white text-3xl font-bold">√ó</button>
            <div class="bg-white p-2 rounded-2xl shadow-2xl rotate-1">
                <img id="view-img" class="w-full rounded-xl object-cover max-h-[60vh] bg-gray-100">
                <div class="p-6 text-center">
                    <h3 id="view-title" class="font-black text-2xl text-gray-800 mb-1 font-['Caveat']"></h3>
                    <p id="view-date" class="text-[10px] uppercase font-bold text-gray-400 mb-4"></p>
                    <p id="view-note" class="text-sm text-gray-600 italic font-medium leading-relaxed"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="memory-modal" class="hidden fixed inset-0 bg-black/50 z-[150] flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <div class="mint-card p-6 w-full max-w-sm relative shadow-2xl border-2 border-teal-100 animate-scale-in">
            <h3 class="text-xl font-black text-teal-800 mb-2">Gedanken zum Date üì∏</h3>
            <p class="text-xs text-gray-500 mb-4 font-medium">Halte den Moment fest!</p>
            <div class="space-y-3">
                <label class="block w-full p-4 bg-teal-50 rounded-xl border border-dashed border-teal-300 text-center cursor-pointer hover:bg-teal-100 transition-colors relative">
                    <span id="upload-text" class="text-xs font-bold text-teal-600 uppercase tracking-widest">üì∏ Foto hinzuf√ºgen</span>
                    <input id="memory-photo-file" type="file" accept="image/*" class="hidden" onchange="handleFileUpload(this)">
                </label>
                <img id="preview-image" class="hidden w-full h-32 object-cover rounded-xl mt-2 border border-teal-100 shadow-sm animate-fade-in">
                <textarea id="memory-note" placeholder="Schreibe einen Kommentar..." class="w-full p-4 bg-teal-50 rounded-xl outline-none text-sm h-24 resize-none border border-transparent focus:border-teal-300 transition-all"></textarea>
            </div>
            <div class="mt-6 space-y-2">
                <button id="btn-save-memory" onclick="playSound('success')" class="pink-btn w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg text-xs">Speichern / Kommentieren</button>
                <button onclick="closeMemoryModal()" class="text-[10px] text-gray-400 font-bold uppercase w-full py-2 hover:text-gray-600">Abbrechen</button>
            </div>
        </div>
    </div>

    <div id="milestone-modal" class="hidden fixed inset-0 bg-black/50 z-[160] flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
        <div class="mint-card p-6 w-full max-w-sm relative shadow-2xl border-2 border-teal-100 animate-scale-in my-8">
            <h3 id="modal-title" class="text-xl font-black text-teal-800 mb-2">Eintrag bearbeiten ‚úèÔ∏è</h3>
            <input type="hidden" id="ms-id">
            <div class="space-y-2 text-sm">
                <input id="ms-title" type="text" placeholder="Titel / Was?" class="w-full p-3 bg-teal-50 rounded-xl outline-none">
                <input id="ms-location" type="text" placeholder="üìç Ort" class="w-full p-3 bg-teal-50 rounded-xl outline-none" data-original-location="">
                <input id="ms-info" type="text" placeholder="üí° Insider-Info" class="w-full p-3 bg-teal-50 rounded-xl outline-none">
                <div class="flex gap-2">
                    <select id="ms-cat" class="flex-1 bg-teal-50 p-2 rounded-xl outline-none text-xs"><option value="Sofort">‚ö° Spontan</option><option value="Planung">üìÖ Planung</option></select>
                    <select id="ms-weather" class="flex-1 bg-teal-50 p-2 rounded-xl outline-none text-xs"><option value="Egal">‚òÅÔ∏è Egal</option><option value="Sonne">‚òÄÔ∏è Sonne</option><option value="Regen">üè† Regen</option></select>
                </div>
                <div id="ms-memory-fields">
                    <p class="text-[10px] font-bold text-gray-400 mt-2 uppercase">Wann war das?</p>
                    <input id="ms-date" type="datetime-local" class="w-full p-3 bg-white border border-gray-200 rounded-xl outline-none text-center">
                    <p class="text-[10px] font-bold text-gray-400 mt-2 uppercase">Bewertungen (1-10)</p>
                    <div class="flex gap-2">
                        <div class="flex-1"><label class="text-[9px] font-bold text-pink-400 uppercase">Meriam</label><input id="ms-rating-m" type="number" min="1" max="10" class="w-full p-2 bg-pink-50 rounded-lg text-center outline-none border border-pink-100"></div>
                        <div class="flex-1"><label class="text-[9px] font-bold text-teal-400 uppercase">Samet</label><input id="ms-rating-s" type="number" min="1" max="10" class="w-full p-2 bg-teal-50 rounded-lg text-center outline-none border border-teal-100"></div>
                    </div>
                    <label class="block w-full p-3 bg-teal-50 rounded-xl border border-dashed border-teal-300 text-center cursor-pointer hover:bg-teal-100 transition-colors relative mt-3">
                        <span id="ms-upload-text" class="text-xs font-bold text-teal-600 uppercase tracking-widest">üì∏ Foto √§ndern</span>
                        <input id="ms-photo-file" type="file" accept="image/*" class="hidden" onchange="handleMilestonePhotoUpload(this)">
                    </label>
                    <img id="ms-preview-image" class="hidden w-full h-24 object-cover rounded-xl mt-2 border border-teal-100 shadow-sm">
                    <textarea id="ms-note" placeholder="Notiz..." class="w-full p-3 bg-teal-50 rounded-xl outline-none h-20 resize-none mt-2"></textarea>
                </div>
            </div>
            <div class="mt-6 space-y-2">
                <button onclick="saveMilestone(); playSound('success')" class="teal-btn w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg text-xs">Speichern</button>
                <button onclick="document.getElementById('milestone-modal').classList.add('hidden')" class="text-[10px] text-gray-400 font-bold uppercase w-full py-2 hover:text-gray-600">Abbrechen</button>
            </div>
        </div>
    </div>

    <div id="countdown-modal" class="hidden fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="mint-card p-6 w-full max-w-sm relative shadow-2xl border-2 border-pink-100 animate-scale-in">
            <h3 class="text-xl font-black text-pink-600 mb-4">Countdown setzen ‚è≥</h3>
            <input id="new-cd-title" type="text" placeholder="Ereignis (z.B. Urlaub üå¥)" class="w-full p-3 bg-pink-50 rounded-xl mb-2 outline-none text-sm font-bold text-gray-700">
            <input id="new-cd-date" type="datetime-local" class="w-full p-3 bg-white border border-gray-200 rounded-xl mb-4 outline-none text-sm text-center text-gray-700">
            <button id="btn-save-countdown" onclick="playSound('success')" type="button" class="pink-btn w-full py-3 rounded-xl font-black uppercase tracking-widest text-xs">Starten</button>
            <button onclick="playSound('click'); document.getElementById('countdown-modal').classList.add('hidden')" class="text-[10px] text-gray-400 font-bold uppercase w-full py-2 mt-2 hover:text-gray-600">Abbrechen</button>
        </div>
    </div>

    <div id="reward-modal" class="hidden fixed inset-0 bg-black/60 z-[250] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="mint-card p-8 w-full max-w-sm relative shadow-2xl border-4 border-yellow-300 bg-gradient-to-br from-yellow-50 to-white text-center pop-in">
            <div class="text-6xl mb-4 animate-bounce">üéÅ</div>
            <h3 class="text-2xl font-black text-yellow-600 mb-2 tracking-tight">Belohnung!</h3>
            <p class="text-xs text-gray-500 font-bold uppercase mb-6">F√ºr mehr Quality Time & Verw√∂hnmomente!</p>
            <div class="bg-white p-6 rounded-2xl border-2 border-dashed border-yellow-200 mb-6 shadow-inner animate-fade-in">
                <p id="reward-text" class="text-lg font-black text-teal-800 leading-relaxed"></p>
            </div>
            <button onclick="playSound('reveal'); document.getElementById('reward-modal').classList.add('hidden')" class="bg-yellow-400 text-white w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg text-xs hover:bg-yellow-500 transition-colors">Einl√∂sen & Reset üîÑ</button>
        </div>
    </div>

    <div id="main-dashboard" class="hidden w-full max-w-md p-4 relative z-10">
        <header class="flex flex-col mb-8 mt-2 px-2 animate-fade-in-down">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h1 class="text-3xl font-black text-teal-800 tracking-tighter drop-shadow-sm">MerSam OS <span class="text-pink-400 text-lg">v3.3</span></h1>
                    <p id="user-greeting" class="text-xs text-teal-600 font-bold uppercase tracking-widest mt-1"></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="openSettings()" class="bg-white/80 backdrop-blur-sm border border-gray-200 text-gray-400 hover:text-teal-600 p-3 rounded-2xl transition-all shadow-sm active:scale-95">‚öôÔ∏è</button>
                    <button id="btn-logout" class="bg-white/80 backdrop-blur-sm border border-pink-100 text-pink-400 hover:text-pink-600 hover:bg-pink-50 p-3 rounded-2xl transition-all shadow-sm active:scale-95" title="Abmelden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    </button>
                </div>
            </div>
            <div class="flex flex-wrap gap-2 justify-center items-center mt-2">
                <button onclick="editSystemStart();" id="uptime-display" class="bg-white/60 backdrop-blur-md border border-teal-100 text-[10px] text-teal-600 font-bold uppercase tracking-wider px-3 py-1.5 rounded-full shadow-sm hover:bg-white transition-all flex items-center gap-2">
                    <span class="animate-pulse text-teal-400 text-xs">‚óè</span> System Uptime: Laden...
                </button>
                <div class="bg-white/60 backdrop-blur-md border border-pink-100 text-[10px] text-gray-500 font-bold px-3 py-1.5 rounded-full shadow-sm flex items-center gap-2">
                    <span id="partner-status" class="online-indicator offline"></span>
                    <span id="partner-last-seen">Suche Partner...</span>
                </div>
            </div>
        </header>

        <div id="tab-home" class="animate-fade-in">
            <div id="countdown-card" class="mint-card p-6 mb-6 bg-gradient-to-r from-pink-50 to-teal-50 border-none shadow-md relative overflow-hidden hidden animate-scale-in">
                <div class="absolute top-2 right-2 flex gap-2 z-20">
                    <button onclick="editCountdown()" class="text-gray-400 hover:text-teal-500 p-2 bg-white/80 rounded-full shadow-sm transition-colors active:scale-95" title="Bearbeiten">‚úèÔ∏è</button>
                    <button onclick="deleteCountdown()" class="text-gray-400 hover:text-red-500 p-2 bg-white/80 rounded-full shadow-sm transition-colors active:scale-95" title="L√∂schen">üóëÔ∏è</button>
                </div>
                <p class="text-center text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">N√§chstes Highlight</p>
                <h3 id="countdown-title" class="text-center text-xl font-black text-gray-800 mb-3 tracking-tight truncate px-4"></h3>
                <div class="flex justify-center gap-4 text-center">
                    <div class="bg-white/60 rounded-lg p-2 min-w-[50px]"><span id="cd-days" class="block text-2xl font-black text-pink-500 leading-none">0</span><span class="text-[7px] uppercase font-bold text-gray-400">Tage</span></div>
                    <div class="bg-white/60 rounded-lg p-2 min-w-[50px]"><span id="cd-hours" class="block text-2xl font-black text-teal-500 leading-none">0</span><span class="text-[7px] uppercase font-bold text-gray-400">Std</span></div>
                    <div class="bg-white/60 rounded-lg p-2 min-w-[50px]"><span id="cd-min" class="block text-2xl font-black text-indigo-500 leading-none">0</span><span class="text-[7px] uppercase font-bold text-gray-400">Min</span></div>
                </div>
            </div>
            <div id="countdown-placeholder" class="mb-6 text-center hidden animate-fade-in">
                <button onclick="openCountdownModal()" class="w-full text-[10px] font-bold text-gray-400 border-2 border-dashed border-gray-200 px-6 py-6 rounded-2xl uppercase tracking-widest hover:bg-white hover:border-pink-300 hover:text-pink-400 transition-all flex flex-col items-center justify-center gap-2">
                    <span class="text-2xl opacity-50">‚ûï</span> <span>Countdown hinzuf√ºgen</span>
                </button>
            </div>
            <div class="mint-card p-2 mb-6 grid grid-cols-3 gap-0 divide-x divide-teal-50 shadow-sm border-b-4 border-teal-200 animate-slide-up">
                <div class="stat-card"><p class="stat-title">Date-Serie</p><p id="stat-streak" class="stat-val text-pink-500">0</p><p class="stat-label">Wochen</p><p id="streak-info" class="streak-status italic text-[7px] leading-tight mt-1"></p></div>
                <div class="stat-card"><p class="stat-title">Ideen-Duell</p><p id="stat-vs" class="stat-val text-teal-600">0:0</p><p id="vs-label" class="stat-label text-[7px]">Ich vs Partner</p></div>
                <div class="stat-card"><p class="stat-title">Erf√ºllt</p><p id="stat-progress" class="stat-val text-indigo-500">0%</p><p class="stat-label">Der W√ºnsche</p></div>
            </div>
            <div id="reward-card" class="mint-card p-4 mb-6 border-l-4 border-yellow-300 bg-gradient-to-r from-yellow-50 to-white shadow-sm flex items-center justify-between animate-slide-up" style="animation-delay: 0.1s;">
                <div class="flex-1">
                    <p class="text-[9px] font-black text-yellow-600 uppercase tracking-widest mb-1">N√§chstes Level üèÜ</p>
                    <div class="w-full bg-gray-100 rounded-full h-2.5 mb-1 overflow-hidden"><div id="reward-progress-bar" class="bg-yellow-400 h-2.5 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                    <p id="reward-progress-text" class="text-[9px] font-bold text-gray-400">0 / 5 Dates bis zur Belohnung</p>
                </div>
                <div class="ml-4"><button id="btn-claim-reward" onclick="playSound('reveal'); claimReward()" class="text-3xl filter grayscale opacity-50 transition-all transform hover:scale-110 active:scale-95 disabled:cursor-not-allowed" disabled>üéÅ</button></div>
            </div>
            <div class="bg-yellow-100 border-l-8 border-yellow-400 p-4 mb-8 rounded-r-2xl shadow-sm relative rotate-1 animate-slide-up" style="animation-delay: 0.2s;">
                <p id="love-letter-title" class="text-[10px] font-black text-yellow-600 uppercase tracking-widest mb-1">Post-it</p>
                <p id="love-letter-display" class="text-sm text-yellow-800 italic font-medium">Laden...</p>
                <div class="flex justify-between items-center mt-3 gap-2">
                    <button id="btn-ai-letter" onclick="playSound('pop')" class="sparkle-btn w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold shadow-md active:scale-95" title="Nachricht generieren">‚ú®</button>
                    <input id="love-letter-input" type="text" placeholder="Hinterlasse eine Nachricht..." class="bg-white/50 text-xs p-2 rounded-lg border-none outline-none flex-1 italic">
                    <button id="btn-send-letter" onclick="playSound('success')" class="bg-yellow-400 text-white p-2 rounded-lg text-xs font-bold uppercase">Senden</button>
                </div>
            </div>
            <div class="mint-card p-6 mb-6 animate-slide-up" style="animation-delay: 0.3s;">
                <h3 class="font-black text-teal-800 mb-4 uppercase text-xs tracking-widest">F√ºge eine Date-Idee hinzu ‚ú®</h3>
                <div class="flex gap-2 mb-3 items-center">
                    <input id="wish-input" type="text" placeholder="Was machen wir?" class="flex-1 p-4 bg-teal-50 rounded-xl outline-none text-lg">
                    <button id="btn-ai-wish" onclick="playSound('pop')" class="sparkle-btn h-14 w-14 rounded-xl shadow-lg flex items-center justify-center text-xl active:scale-95" title="Idee generieren">‚ú®</button>
                </div>
                <input id="location-input" type="text" placeholder="üìç Wo? (F√ºr die Karte)" class="w-full p-3 bg-white border border-teal-100 rounded-xl mb-2 outline-none text-sm">
                <input id="info-input" type="text" placeholder="üí° Insider-Info?" class="w-full p-3 bg-white border border-teal-100 rounded-xl mb-4 outline-none text-sm italic">
                <div class="flex gap-2 mb-6">
                    <select id="cat-select" class="flex-1 filter-select"><option value="Sofort">‚ö° Spontan?</option><option value="Planung">üìÖ Planung?</option></select>
                    <select id="weather-select" class="flex-1 filter-select"><option value="Egal">‚òÅÔ∏è Wetter egal?</option><option value="Sonne">‚òÄÔ∏è Sonne</option><option value="Regen">üè† Regen</option></select>
                </div>
                <div class="flex justify-between items-center px-2 mb-6">
                    <span class="text-[10px] font-bold text-gray-400 uppercase">Geheim? ü§´ <label class="switch"><input type="checkbox" id="surprise-toggle"><span class="slider"></span></label></span>
                    <span class="text-[10px] font-bold text-yellow-600 uppercase">In die Bucket List legen? <label class="switch"><input type="checkbox" id="bucket-toggle"><span class="slider"></span></label></span>
                </div>
                <button id="btn-add" onclick="playSound('success')" class="pink-btn w-full py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg">Hinzuf√ºgen</button>
            </div>
            <div class="mint-card p-8 mb-6 text-center bg-gradient-to-b from-white to-teal-50 animate-slide-up" style="animation-delay: 0.4s;">
                <h3 class="font-black text-teal-800 mb-4 uppercase text-xs tracking-widest">üé≤ Zufallsgenerator Date Maker</h3>
                <div class="flex gap-2 mb-6 justify-center text-[10px] font-bold">
                    <select id="filter-cat" class="flex-1 filter-select"><option value="Alle">F√ºr alle Optionen offen?</option><option value="Sofort">‚ö° Spontan</option><option value="Planung">üìÖ Planung</option></select>
                    <select id="filter-weather" class="flex-1 filter-select"><option value="Alle">Wetter egal?</option><option value="Sonne">‚òÄÔ∏è Sonne</option><option value="Regen">üè† Regen</option></select>
                </div>
                <div class="relative overflow-hidden rounded-3xl p-4">
                    <div id="flash-layer" class="flash-overlay"></div>
                    <div id="dice-container" class="transition-all duration-500 py-6">
                        <div class="scene"><div id="cube-3d" class="cube"><div class="cube__face cube__face--1"><div class="face-grid"><div class="dot d-center"></div></div></div><div class="cube__face cube__face--2"><div class="face-grid"><div class="dot d-tl"></div><div class="dot d-br"></div></div></div><div class="cube__face cube__face--3"><div class="face-grid"><div class="dot d-tl"></div><div class="dot d-center"></div><div class="dot d-br"></div></div></div><div class="cube__face cube__face--4"><div class="face-grid"><div class="dot d-tl"></div><div class="dot d-tr"></div><div class="dot d-bl"></div><div class="dot d-br"></div></div></div><div class="cube__face cube__face--5"><div class="face-grid"><div class="dot d-tl"></div><div class="dot d-tr"></div><div class="dot d-center"></div><div class="dot d-bl"></div><div class="dot d-br"></div></div></div><div class="cube__face cube__face--6"><div class="face-grid"><div class="dot d-tl"></div><div class="dot d-tr"></div><div class="dot d-ml"></div><div class="dot d-mr"></div><div class="dot d-bl"></div><div class="dot d-br"></div></div></div></div></div>
                    </div>
                    <div id="lock-screen" class="hidden flex flex-col items-center justify-center py-8">
                        <svg class="lock-svg" viewBox="0 0 100 120"><path id="lock-shackle-path" class="lock-shackle" d="M25,50 V25 A25,25 0 0,1 75,25 V50" /><rect id="lock-body-rect" class="lock-body" x="15" y="50" width="70" height="60" rx="10" /><circle cx="50" cy="80" r="6" fill="white" opacity="0.5"/><rect x="48" y="80" width="4" height="15" fill="white" opacity="0.5"/></svg>
                        <p id="lock-text" class="text-pink-500 font-black text-xs mt-6 tracking-[0.2em] uppercase">Secret Locked</p>
                    </div>
                </div>
                <div id="result-box" class="mt-2 hidden">
                    <div id="unfold-wrapper">
                        <p class="text-[10px] uppercase text-gray-400 mb-1 tracking-widest font-bold">Euer Schicksal:</p>
                        <h2 id="final-choice" class="text-2xl font-bold text-pink-600 mb-1 leading-tight"></h2>
                        <p id="final-info" class="text-sm text-gray-600 mb-4 italic"></p>
                        <div id="map-container" class="hidden mb-6 rounded-3xl overflow-hidden border-4 border-white shadow-sm"><iframe id="map-frame" width="100%" height="180" frameborder="0" style="border:0"></iframe></div>
                        <div id="result-info" class="mb-6 flex flex-col items-center justify-center"><span id="result-creator-badge" class="user-badge mb-2"></span><div id="result-labels" class="flex justify-center gap-2"></div></div>
                        <div class="flex flex-col gap-3">
                            <button id="btn-accept-date-only-main" onclick="playSound('success')" class="w-full bg-teal-500 text-white py-4 rounded-2xl font-bold uppercase text-[11px] shadow-lg">Date annehmen ‚úì</button>
                            <div id="challenge-section" class="border-t border-pink-50 pt-4">
                                <div id="challenge-btn-container"><button id="btn-show-challenge" onclick="playSound('pop')" class="text-[10px] font-bold text-pink-500 border-2 border-pink-200 px-8 py-2 rounded-full uppercase tracking-widest hover:bg-pink-50 transition-colors">‚ú® Bonus-Challenge? ‚ú®</button></div>
                                <div id="challenge-display" class="hidden mt-2 p-6 bg-gradient-to-br from-pink-50 to-white rounded-3xl border-2 border-pink-100 shadow-inner">
                                    <p id="challenge-text" class="text-pink-700 font-bold italic mb-6 text-base leading-relaxed"></p>
                                    <div class="flex flex-col gap-3"><button id="btn-accept-both" onclick="playSound('success')" class="w-full pink-btn py-4 rounded-2xl font-bold uppercase text-[11px] shadow-lg">Date & Challenge annehmen</button><button id="btn-accept-date-only-sub" onclick="playSound('click')" class="w-full text-gray-400 font-bold text-[9px] uppercase py-2">Nur Date annehmen</button><button id="btn-reroll-challenge" class="text-[9px] text-pink-400 font-bold uppercase mt-2 tracking-widest hover:text-pink-600 transition-colors">‚Üª Andere Challenge</button></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button id="btn-roll" onclick="playSound('click')" class="mt-6 bg-teal-700 text-white px-12 py-5 rounded-full font-bold shadow-xl w-full active:scale-95 uppercase tracking-widest">W√úRFELN</button>
            </div>
            <h3 class="font-black text-teal-800 mb-4 px-2 text-sm uppercase tracking-widest text-center italic animate-fade-in" style="animation-delay: 0.5s;">Unsere Ideen üí°</h3>
            <div id="wish-list" class="space-y-4 mb-10"></div>
            <div class="flex items-center justify-between px-2 mb-4">
                <h3 class="font-bold text-gray-400 text-sm uppercase tracking-widest italic text-center flex-1">Meilensteine üèÜ</h3>
                <button onclick="playSound('pop'); openMilestoneModal('add', null, 'archive')" class="text-xs bg-pink-100 text-pink-500 px-3 py-1 rounded-lg font-bold hover:bg-pink-200 transition-colors shadow-sm">+</button>
            </div>
            <div id="archive-list" class="space-y-3 pb-20 opacity-90"></div>
        </div>

        <div id="tab-map" class="hidden pb-20 animate-fade-in">
            <h2 class="text-2xl font-bold text-teal-700 mb-4 text-center mt-2">Unsere Welt üåç</h2>
            <p class="text-center text-[10px] text-gray-400 mb-4">Wo wir schon √ºberall unsere Spuren hinterlassen haben.</p>
            <div id="map" class="shadow-xl"></div>
        </div>

        <div id="tab-gallery" class="hidden pb-20 animate-fade-in">
            <h2 class="text-2xl font-bold text-pink-600 mb-2 text-center mt-2">Erinnerungen üì∏</h2>
            <p class="text-center text-[10px] text-gray-400 mb-6">Unsere sch√∂nsten Momente</p>
            <div id="gallery-grid" class="grid grid-cols-2 gap-4 px-2"></div>
        </div>

        <div id="tab-bucket" class="hidden pb-20 animate-fade-in">
            <div class="flex items-center justify-center relative mb-2">
                <h2 class="text-2xl font-bold text-yellow-600 text-center">Bucket List ‚ú®</h2>
                <button onclick="playSound('pop'); openMilestoneModal('add', null, 'bucket')" class="absolute right-2 text-xs bg-yellow-100 text-yellow-600 px-3 py-1 rounded-lg font-bold hover:bg-yellow-200 transition-colors shadow-sm">+ Neu</button>
            </div>
            <p class="text-center text-[10px] text-gray-500 mb-6 italic px-6 leading-relaxed">Unsere gro√üen Lebenstr√§ume: Ob Bungee-Jumping, Weltreisen oder verr√ºckte Abenteuer ‚Äì hier sammeln wir alles, was wir in diesem Leben unbedingt noch gemeinsam erleben wollen! üåç‚úàÔ∏èüöÄ</p>
            <div id="bucket-list-content" class="space-y-4"></div>
        </div>

        <div id="tab-fun" class="hidden pb-20 animate-fade-in">
            <div class="mint-card p-8 mb-6 text-center animate-slide-up">
                <h3 class="font-black text-indigo-600 mb-4 uppercase text-xs tracking-widest">üó£Ô∏è Deep Talk</h3>
                <p class="text-[10px] text-gray-400 mb-6">Keine Lust auf Smalltalk? Lass uns tiefer gehen.</p>
                <div id="deeptalk-container" class="bg-indigo-50 p-6 rounded-2xl mb-6 hidden border border-indigo-100 shadow-inner">
                    <p id="deeptalk-question" class="text-lg font-bold text-indigo-900 italic leading-relaxed"></p>
                </div>
                <button id="btn-deeptalk" onclick="playSound('pop')" class="bg-indigo-500 text-white px-8 py-3 rounded-2xl font-bold uppercase text-[10px] tracking-widest shadow-md hover:bg-indigo-600 transition-colors w-full">‚ú® Neues Thema</button>
            </div>
            <div class="mint-card p-6 mb-6 text-center animate-slide-up">
                <h3 class="font-black text-red-600 mb-2 uppercase text-xs tracking-widest">üé¨ Netflix Diplomat</h3>
                <p class="text-[10px] text-gray-400 mb-4">Film-Streit? Ich finde den perfekten Kompromiss!</p>
                <div class="space-y-3 mb-4">
                    <div class="relative"><span class="absolute left-3 top-3 text-xs">üë©</span><input id="movie-pref-meriam" type="text" placeholder="Worauf hat Meriam Lust?" class="w-full pl-8 p-3 bg-red-50 rounded-xl outline-none text-xs border border-red-100 placeholder-red-300 text-red-900 font-medium"></div>
                    <div class="relative"><span class="absolute left-3 top-3 text-xs">üë®</span><input id="movie-pref-samet" type="text" placeholder="Worauf hat Samet Lust?" class="w-full pl-8 p-3 bg-gray-50 rounded-xl outline-none text-xs border border-gray-200 placeholder-gray-400 text-gray-800 font-medium"></div>
                </div>
                <button id="btn-movie-diplomat" onclick="playSound('click')" class="bg-red-600 text-white w-full py-3 rounded-xl font-bold uppercase text-[10px] tracking-widest shadow-md active:scale-95 transition-all hover:bg-red-700">üçø Film finden</button>
                <div id="movie-result" class="hidden mt-4 text-left bg-white border border-red-100 rounded-xl p-4 shadow-inner relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div><p class="text-[9px] font-black text-gray-400 uppercase mb-2">Die Vorschl√§ge der Jury:</p><div id="movie-text" class="text-xs text-gray-700 leading-relaxed whitespace-pre-line"></div>
                </div>
            </div>
            <div class="mint-card p-8 mb-6 text-center animate-slide-up" style="animation-delay: 0.1s;">
                <h3 class="font-bold text-teal-800 mb-4 uppercase text-xs tracking-widest font-black">üé° Entscheidungs-Roulette</h3>
                <p class="text-[10px] text-gray-400 mb-6">Wer kocht? Wer w√§hlt den Film? Das Schicksal entscheidet!</p>
                <div id="roulette-result" class="text-3xl font-black text-teal-600 mb-8 h-12 flex items-center justify-center bg-teal-50 rounded-2xl shadow-inner border border-teal-100">?</div>
                <button id="btn-spin-roulette" class="teal-btn px-12 py-4 rounded-2xl font-bold uppercase tracking-widest text-xs shadow-md">Spin Roulette</button>
            </div>
            <div class="mint-card p-6 animate-slide-up" style="animation-delay: 0.2s;">
                <h3 class="font-bold text-pink-600 mb-4 uppercase text-xs tracking-widest">‚ùì Quiz-Ecke</h3>
                <div id="quiz-list" class="space-y-4 mb-6"></div>
                <div class="border-t pt-4">
                    <input id="quiz-q" type="text" placeholder="Deine Frage..." class="w-full p-3 bg-pink-50 rounded-xl mb-2 outline-none text-sm">
                    <input id="quiz-a" type="text" placeholder="Die Antwort..." class="w-full p-3 bg-pink-50 rounded-xl mb-3 outline-none text-sm">
                    <button id="btn-add-quiz" onclick="playSound('success')" class="pink-btn w-full py-2 rounded-xl font-bold text-xs uppercase">Hinzuf√ºgen</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="nav-bar hidden shadow-2xl" id="app-nav">
        <button onclick="switchTab('home')" class="nav-item active" id="nav-home"><span class="text-xl mb-1">üè†</span><span>Home</span></button>
        <button onclick="switchTab('gallery')" class="nav-item" id="nav-gallery"><span class="text-xl mb-1">üì∏</span><span>Galerie</span></button>
        <button onclick="switchTab('map')" class="nav-item" id="nav-map"><span class="text-xl mb-1">üåç</span><span>Karte</span></button>
        <button onclick="switchTab('bucket')" class="nav-item" id="nav-bucket"><span class="text-xl mb-1">‚ú®</span><span>Bucket</span></button>
        <button onclick="switchTab('fun')" class="nav-item" id="nav-fun"><span class="text-xl mb-1">üé°</span><span>Fun</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, set, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        const firebaseConfig = { apiKey: "AIzaSyCKF4yb7X6XDt5PSTMwiXmn0y7j9aTVMjc", authDomain: "date-decision-maker.firebaseapp.com", databaseURL: "https://date-decision-maker-default-rtdb.europe-west1.firebasedatabase.app", projectId: "date-decision-maker", storageBucket: "date-decision-maker.firebasestorage.app", messagingSenderId: "187389563873", appId: "1:187389563873:web:4fa5fea6a44c42e18078a0", measurementId: "G-LKDJCYHYQW" };
        const app = initializeApp(firebaseConfig); 
        const db = getDatabase(app);

        // --- SOUND & SETTINGS ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false'; 
        let currentTheme = localStorage.getItem('theme') || 'theme-original';

        document.body.className = currentTheme + " min-h-screen flex flex-col items-center select-none transition-colors duration-500";
        document.getElementById('sound-toggle').checked = soundEnabled;

        // SPIDEY RANDOM EVENT
        const spawnSpider = () => {
            if (currentTheme !== 'theme-spiderman') return;
            const el = document.getElementById('crawler');
            el.className = "crawler-spider " + (Math.random() > 0.5 ? "crawl-anim-1" : "crawl-anim-2");
            // Kleiner Krabbel-Sound
            if(Math.random() > 0.7) playSound('click'); 
            setTimeout(() => { el.className = "crawler-spider"; }, 4000);
        };
        // Alle 15-30 Sek checken
        setInterval(() => { if(Math.random() > 0.4) spawnSpider(); }, 10000);

        window.openSettings = () => { document.getElementById('settings-modal').classList.remove('hidden'); };
        window.toggleSound = (el) => { soundEnabled = el.checked; localStorage.setItem('soundEnabled', soundEnabled); };
        window.setTheme = (theme) => { 
            document.body.className = theme + " min-h-screen flex flex-col items-center select-none transition-colors duration-500"; 
            localStorage.setItem('theme', theme); 
            currentTheme = theme;
        };

        window.playSound = function(type) {
            if (!soundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'click') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(500, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.05);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.start(now); osc.stop(now + 0.05);
            } 
            else if (type === 'pop') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(500, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } 
            else if (type === 'success') {
                const frequencies = [523.25, 659.25, 783.99]; 
                frequencies.forEach((f, i) => {
                    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                    o.type = 'sine'; o.frequency.value = f;
                    o.connect(g); g.connect(audioCtx.destination);
                    g.gain.setValueAtTime(0.1, now + i*0.05); g.gain.exponentialRampToValueAtTime(0.001, now + 0.5 + i*0.05);
                    o.start(now + i*0.05); o.stop(now + 0.6);
                });
            }
            else if (type === 'reveal') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(1200, now + 0.5);
                gainNode.gain.setValueAtTime(0.1, now); gainNode.gain.linearRampToValueAtTime(0.2, now + 0.3); gainNode.gain.linearRampToValueAtTime(0.001, now + 0.8);
                osc.start(now); osc.stop(now + 0.8);
                const lfo = audioCtx.createOscillator(); lfo.type = 'square'; lfo.frequency.value = 20;
                const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 500;
                lfo.connect(lfoGain); lfoGain.connect(osc.frequency); lfo.start(now); lfo.stop(now+0.8);
            }
            else if (type === 'lock') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(80, now); osc.frequency.linearRampToValueAtTime(40, now + 0.2);
                gainNode.gain.setValueAtTime(0.3, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            }
        };

        const apiKey = "AIzaSyAwOCM2L7YshWtlvzp9R4guzWNrTtpCXh8"; 

        async function callGemini(prompt) {
            if (!apiKey) return null;
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) return null;
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
            } catch (error) { return null; }
        }

        // --- MAP LOGIC ---
        let map;
        let markers = [];
        let markerClusterGroup; 

        window.initMap = function() { 
            if (map) return;
            map = L.map('map').setView([51.1657, 10.4515], 6); 
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors ¬© <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);
        }

        async function getCoordinates(location) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`);
                const data = await response.json();
                if (data && data.length > 0) return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
            } catch (e) { console.error("Geocoding error", e); }
            return null;
        }

        function loadMapMarkers() {
            if (!map) initMap();
            if (markerClusterGroup) map.removeLayer(markerClusterGroup);
            
            markerClusterGroup = L.markerClusterGroup({
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                spiderfyOnMaxZoom: true,
                animate: true
            });

            markers = [];

            onValue(ref(db, 'wishes'), async (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                const bounds = [];
                for (const id in data) {
                    const item = data[id];
                    if (item.status === 'done' && item.location) {
                        let lat = item.lat;
                        let lon = item.lon;
                        if (!lat || !lon) {
                            const coords = await getCoordinates(item.location);
                            if (coords) {
                                lat = coords.lat; lon = coords.lon;
                                update(ref(db, `wishes/${id}`), { lat, lon });
                            }
                        }
                        if (lat && lon) {
                            const isPhoto = item.memoryPhoto ? true : false;
                            let borderColor = '#EC4899'; 
                            if (item.by === 'Samet') borderColor = '#14B8A6'; 
                            if (item.isBucket) borderColor = '#EAB308'; 

                            const customIcon = L.divIcon({
                                className: 'custom-map-marker-container',
                                html: isPhoto 
                                    ? `<img src="${item.memoryPhoto}" class="map-photo-pin" style="outline-color: ${borderColor}">` 
                                    : `<div class="custom-map-marker" style="border-color: ${borderColor}; color: ${borderColor === '#EAB308' ? '#854d0e' : '#831843'}">${item.text}</div>`,
                                iconSize: [40, 40],
                                iconAnchor: [20, 40]
                            });

                            const marker = L.marker([lat, lon], { icon: customIcon });
                            // LOGIK UPDATE: Wenn Foto da -> View Mode, sonst Edit Mode
                            marker.on('click', () => { 
                                playSound('pop'); 
                                if (isPhoto) openMemoryView(id); 
                                else openMilestoneModal('edit', id);
                            });
                            markerClusterGroup.addLayer(marker);
                            bounds.push([lat, lon]);
                        }
                    }
                }
                map.addLayer(markerClusterGroup);
                if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
            }, { onlyOnce: true });
        }

        const backupWishes = ["Kochen zusammen üçù", "Picknick im Park üå≥", "Kinoabend daheim üçø", "Spaziergang am See üåä", "Neues Caf√© testen ‚òï", "Spieleabend üé≤", "Zusammen malen üé®", "Massageabend üíÜ", "Sternegucken ‚ú®"];
        const backupLoveNotes = ["Ich liebe dich sehr! ‚ù§Ô∏è", "Du bist mein Ein und Alles üí´", "Danke, dass es dich gibt! üåπ", "Du siehst heute toll aus! üòç"];
        const allChallenges = ["Handy-Verbot üìµ (30 min)", "Filmszene nachstellen üì∏", "Song summen & raten üéµ", "Kompliment fl√ºstern ü§´", "Akzent beim Bestellen üó£Ô∏è"];
        const rewardPool = ["üíÜ 20 Min. Massage", "üßñ‚Äç‚ôÄÔ∏è 10 Min. Kopfkraulen", "ü¶∂ 15 Min. Fu√ümassage", "ü•û Fr√ºhst√ºck ans Bett", "üçù Lieblingsessen wird gekocht", "üé¨ Film-Wahl ohne Veto", "üç´ Lieblings-Snack sofort besorgen"];

        let rolledDateId = null;
        let currentCompletingId = null;
        let currentPhotoBase64 = "";
        let countdownTarget = null;
        let countdownTitle = "";
        let relationshipStart = null;
        let globalDoneCount = 0;
        let globalClaimedCount = 0;
        let currentEditingMilestoneId = null; 
        let currentModalMode = 'archive';

        const createHeart = () => {
            const heart = document.createElement('div'); heart.innerHTML = "‚ù§"; heart.className = "floating-heart";
            heart.style.left = Math.random() * 100 + "vw"; heart.style.fontSize = (Math.random() * 20 + 10) + "px";
            const duration = Math.random() * 8 + 12;
            heart.style.animationDuration = duration + "s";
            document.getElementById('heart-container')?.appendChild(heart); 
            setTimeout(() => heart.remove(), duration * 1000);
        };
        setInterval(createHeart, 300);

        document.getElementById('btn-ai-wish').onclick = async () => {
            const btn = document.getElementById('btn-ai-wish');
            const input = document.getElementById('wish-input');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="animate-spin-slow">‚ú®</div>`; btn.disabled = true;
            const prompt = "Erstelle eine kreative, kurze Date-Idee (max 6 W√∂rter) f√ºr ein Paar. Auf Deutsch. Nur die Idee, kein Intro.";
            const idea = await callGemini(prompt);
            input.value = idea ? idea.replace(/["']/g, "") : backupWishes[Math.floor(Math.random() * backupWishes.length)];
            btn.innerHTML = originalText; btn.disabled = false;
        };

        document.getElementById('btn-ai-letter').onclick = async () => {
            const btn = document.getElementById('btn-ai-letter');
            const input = document.getElementById('love-letter-input');
            btn.innerHTML = `‚åõ`; btn.disabled = true;
            const prompt = "Schreibe eine sehr kurze, s√º√üe, romantische Nachricht (max 8 W√∂rter) an den Partner. Auf Deutsch. Nur der Text.";
            const note = await callGemini(prompt);
            input.value = note ? note.replace(/["']/g, "") : backupLoveNotes[Math.floor(Math.random() * backupLoveNotes.length)];
            btn.innerHTML = `‚ú®`; btn.disabled = false;
        };

        async function generateChallenge() {
            const prompt = "Erstelle eine lustige, kleine 5-Minuten-Challenge f√ºr ein Paar, die man sofort machen kann. Max 1 Satz. Deutsch.";
            const challenge = await callGemini(prompt);
            return challenge || allChallenges[Math.floor(Math.random() * allChallenges.length)];
        }

        document.getElementById('btn-show-challenge').onclick = async () => { 
            const textEl = document.getElementById('challenge-text');
            textEl.innerText = "Frage das Orakel... ‚ú®";
            document.getElementById('challenge-display').classList.remove('hidden'); 
            document.getElementById('challenge-btn-container').classList.add('hidden');
            playSound('pop');
            const challengeText = await generateChallenge();
            textEl.innerText = challengeText;
        };
        
        document.getElementById('btn-reroll-challenge').onclick = async () => {
            const textEl = document.getElementById('challenge-text');
            const btn = document.getElementById('btn-reroll-challenge');
            const originalText = btn.innerText;
            btn.innerText = "‚åõ Lade..."; btn.disabled = true; textEl.style.opacity = '0.5';
            playSound('click');
            const challengeText = await generateChallenge();
            textEl.innerText = challengeText;
            textEl.style.opacity = '1'; btn.innerText = originalText; btn.disabled = false;
        };

        document.getElementById('btn-deeptalk').onclick = async () => {
            const qEl = document.getElementById('deeptalk-question');
            const container = document.getElementById('deeptalk-container');
            const btn = document.getElementById('btn-deeptalk');
            const originalText = btn.innerText;
            btn.innerText = "‚ú® Suche Thema..."; btn.disabled = true; container.classList.remove('hidden'); qEl.style.opacity = '0.5';
            playSound('pop');
            const prompt = "Erstelle eine interessante Frage f√ºr ein Paar, √ºber die man gut reden kann. 1-2 S√§tze, Alltagssprache.";
            const question = await callGemini(prompt);
            qEl.innerText = question ? question.replace(/["']/g, "") : "Welchen Tag aus unserer Beziehung w√ºrdest du gerne noch einmal erleben?";
            qEl.style.opacity = '1'; btn.innerText = originalText; btn.disabled = false;
        };

        window.claimReward = () => {
            const modal = document.getElementById('reward-modal');
            const textEl = document.getElementById('reward-text');
            const reward = rewardPool[Math.floor(Math.random() * rewardPool.length)];
            textEl.innerText = reward;
            set(ref(db, 'stats/claimedCount'), globalClaimedCount + 1);
            modal.classList.remove('hidden');
        };

        const updateRewardUI = (doneCount, claimedCount) => {
            const rewardBar = document.getElementById('reward-progress-bar');
            const rewardText = document.getElementById('reward-progress-text');
            const rewardBtn = document.getElementById('btn-claim-reward');
            const datesPerReward = 5;
            const targetForNextReward = (claimedCount + 1) * datesPerReward;
            const isClaimable = doneCount >= targetForNextReward;
            const currentBase = claimedCount * datesPerReward;
            let currentProgress = doneCount - currentBase;
            if (currentProgress > datesPerReward) currentProgress = datesPerReward;
            let progressPercent = (currentProgress / datesPerReward) * 100;

            rewardBar.style.width = `${progressPercent}%`;
            if (isClaimable) {
                rewardText.innerText = "üéâ 5 Dates geschafft! √ñffne mich!";
                rewardText.classList.add('text-pink-500', 'animate-pulse');
                rewardBtn.disabled = false; rewardBtn.classList.remove('grayscale', 'opacity-50'); rewardBtn.classList.add('chest-shake');
            } else {
                rewardText.innerText = `${currentProgress} / ${datesPerReward} Dates bis zur Belohnung`;
                rewardText.classList.remove('text-pink-500', 'animate-pulse');
                rewardBtn.disabled = true; rewardBtn.classList.add('grayscale', 'opacity-50'); rewardBtn.classList.remove('chest-shake');
            }
        };

        window.editSystemStart = () => {
            const date = prompt("Seit wann seid ihr zusammen? (Format: YYYY-MM-DD)", "2020-01-01");
            if (date) { const ts = new Date(date).getTime(); if (!isNaN(ts)) set(ref(db, 'systemStart'), ts); }
        };

        const updateUptime = () => {
            const display = document.getElementById('uptime-display');
            if (!relationshipStart) { display.innerText = "System Uptime: Startdatum setzen"; return; }
            const diff = Date.now() - relationshipStart;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            display.innerText = `System Uptime: ${days} Tage`;
        };
        setInterval(updateUptime, 3600000);

        window.startAuth = async (user) => {
            const snap = await get(ref(db, `users/${user}`)); 
            const userData = snap.val();
            document.getElementById('user-selection').classList.add('hidden');
            document.getElementById('password-area').classList.remove('hidden');
            if (!userData || !userData.password) {
                document.getElementById('password-msg').innerText = "W√§hle dein erstes Passwort:";
                document.getElementById('btn-login-confirm').onclick = async () => {
                    const p = document.getElementById('pass-input').value; 
                    if(p.length < 4) return alert("Min. 4 Zeichen!");
                    await set(ref(db, `users/${user}/password`), p); login(user);
                };
            } else {
                document.getElementById('password-msg').innerText = `${user}, gib dein Passwort ein:`;
                document.getElementById('btn-login-confirm').onclick = () => {
                    if(document.getElementById('pass-input').value === userData.password) login(user); else alert("Falsches Passwort!");
                };
            }
        };

        const login = (u) => { localStorage.setItem('currentUser', u); checkAuth(); };
        const checkAuth = () => { 
            const u = localStorage.getItem('currentUser'); 
            if(u) { 
                document.getElementById('login-screen').classList.add('hidden'); 
                document.getElementById('main-dashboard').classList.remove('hidden'); 
                document.getElementById('app-nav').classList.remove('hidden'); 
                document.getElementById('user-greeting').innerText = `Hallo ${u}`; 
                startPresence(u); syncData(u); 
            } 
        };
        
        const startPresence = (u) => { 
            setInterval(() => update(ref(db, `presence/${u}`), { onlineAt: Date.now() }), 5000); 
            const partner = u === "Samet" ? "Meriam" : "Samet"; 
            onValue(ref(db, `presence/${partner}`), (s) => { 
                const data = s.val();
                const indicator = document.getElementById('partner-status');
                const lastSeenText = document.getElementById('partner-last-seen');
                if (!data || !data.onlineAt) { indicator.className = "online-indicator offline"; lastSeenText.innerText = `${partner} war noch nie hier`; return; }
                const isOnline = (Date.now() - data.onlineAt) < 15000; 
                indicator.className = "online-indicator " + (isOnline ? "online" : "offline");
                if (isOnline) { lastSeenText.innerText = `${partner} online`; lastSeenText.className = "text-[9px] font-bold text-green-500 transition-all"; }
                else { 
                    const date = new Date(data.onlineAt);
                    lastSeenText.innerText = `${partner} zuletzt: ${date.toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'})}`; 
                    lastSeenText.className = "text-[9px] text-gray-400 font-medium transition-all";
                }
            }); 
        };

        window.switchTab = (tab) => { 
            ['home', 'bucket', 'fun', 'map', 'gallery'].forEach(t => { 
                const el = document.getElementById(`tab-${t}`);
                if (!el.classList.contains('hidden')) { el.classList.add('hidden'); el.classList.remove('animate-fade-in'); }
                document.getElementById(`nav-${t}`).classList.remove('active'); 
            }); 
            const targetEl = document.getElementById(`tab-${tab}`);
            targetEl.classList.remove('hidden'); targetEl.classList.add('animate-fade-in'); 
            document.getElementById(`nav-${tab}`).classList.add('active'); 
            if (tab === 'map') setTimeout(() => { loadMapMarkers(); }, 100);
        };

        const getWeekKey = (date) => { 
            const d = new Date(date); d.setHours(0,0,0,0); 
            d.setDate(d.getDate() + 4 - (d.getDay() || 7)); 
            let yearStart = new Date(d.getFullYear(), 0, 1); 
            return d.getFullYear() + "-" + Math.ceil((((d - yearStart) / 86400000) + 1) / 7); 
        };
        const getNextSunday = () => { let d = new Date(); d.setDate(d.getDate() + (7 - d.getDay()) % 7); return d.toLocaleDateString('de-DE'); };

        window.startActiveDate = (id) => {
            update(ref(db, `wishes/${id}`), { status: 'active' });
            document.getElementById('result-box').classList.add('hidden');
            document.getElementById('result-box').classList.remove('magic-pop-in');
        };

        window.handleFileUpload = (input) => {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 600; let width = img.width; let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height);
                    currentPhotoBase64 = canvas.toDataURL('image/jpeg', 0.6);
                    const preview = document.getElementById('preview-image'); preview.src = currentPhotoBase64; preview.classList.remove('hidden');
                    document.getElementById('upload-text').innerText = "‚úÖ Foto ausgew√§hlt";
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        window.handleMilestonePhotoUpload = (input) => {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 600; let width = img.width; let height = img.height;
                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height);
                    currentPhotoBase64 = canvas.toDataURL('image/jpeg', 0.6);
                    const preview = document.getElementById('ms-preview-image'); preview.src = currentPhotoBase64; preview.classList.remove('hidden');
                    document.getElementById('ms-upload-text').innerText = "‚úÖ Foto ge√§ndert";
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- NEW VIEW MODAL LOGIC (Nur Ansehen) ---
        window.openMemoryView = async (id) => {
            const modal = document.getElementById('view-memory-modal');
            const imgEl = document.getElementById('view-img');
            const titleEl = document.getElementById('view-title');
            const noteEl = document.getElementById('view-note');
            const dateEl = document.getElementById('view-date');

            // Reset
            imgEl.src = ""; titleEl.innerText = "Laden..."; noteEl.innerText = ""; dateEl.innerText = "";
            modal.classList.remove('hidden');
            playSound('pop');

            const snapshot = await get(ref(db, `wishes/${id}`));
            const data = snapshot.val();
            
            if (data && data.memoryPhoto) {
                imgEl.src = data.memoryPhoto;
                titleEl.innerText = data.text;
                noteEl.innerText = data.memoryNote || "Keine Notiz dazu.";
                const d = new Date(data.doneAt);
                dateEl.innerText = d.toLocaleDateString('de-DE') + " ‚Ä¢ " + data.location;
            } else {
                modal.classList.add('hidden'); // Sollte nicht passieren
            }
        };

        window.openMilestoneModal = async (mode, id = null, type = 'archive') => {
            currentModalMode = type;
            const modal = document.getElementById('milestone-modal');
            const titleEl = document.getElementById('ms-title'); const locEl = document.getElementById('ms-location'); const infoEl = document.getElementById('ms-info');
            const catEl = document.getElementById('ms-cat'); const weatherEl = document.getElementById('ms-weather'); const dateEl = document.getElementById('ms-date');
            const noteEl = document.getElementById('ms-note'); const ratingMEl = document.getElementById('ms-rating-m'); const ratingSEl = document.getElementById('ms-rating-s');
            const previewEl = document.getElementById('ms-preview-image'); const uploadTextEl = document.getElementById('ms-upload-text');
            const modalTitle = document.getElementById('modal-title'); const memoryFields = document.getElementById('ms-memory-fields');
            
            titleEl.value = ""; locEl.value = ""; infoEl.value = ""; dateEl.value = ""; noteEl.value = ""; ratingMEl.value = ""; ratingSEl.value = "";
            previewEl.src = ""; previewEl.classList.add('hidden'); uploadTextEl.innerText = "üì∏ Foto hinzuf√ºgen"; currentPhotoBase64 = "";
            locEl.setAttribute('data-original-location', "");

            if (type === 'bucket') {
                 modalTitle.innerText = mode === 'add' ? "Neuer Bucket List Traum ‚ú®" : "Traum bearbeiten ‚úèÔ∏è";
                 if (mode === 'add') memoryFields.classList.add('hidden');
                 else {
                     const snapshot = await get(ref(db, `wishes/${id}`)); const data = snapshot.val();
                     if (data && data.status === 'done') memoryFields.classList.remove('hidden'); else memoryFields.classList.add('hidden');
                 }
            } else {
                 modalTitle.innerText = mode === 'add' ? "Meilenstein nachtragen üèÜ" : "Meilenstein bearbeiten ‚úèÔ∏è";
                 memoryFields.classList.remove('hidden');
            }

            if (mode === 'edit' && id) {
                currentEditingMilestoneId = id;
                const snapshot = await get(ref(db, `wishes/${id}`));
                const data = snapshot.val();
                if (data) {
                    titleEl.value = data.text || ""; locEl.value = data.location || ""; locEl.setAttribute('data-original-location', data.location || "");
                    infoEl.value = data.info || ""; catEl.value = data.cat || "Sofort"; weatherEl.value = data.weather || "Egal";
                    noteEl.value = data.memoryNote || ""; ratingMEl.value = data.ratingMeriam || ""; ratingSEl.value = data.ratingSamet || "";
                    if (data.memoryPhoto) { previewEl.src = data.memoryPhoto; previewEl.classList.remove('hidden'); uploadTextEl.innerText = "‚úÖ Foto vorhanden"; currentPhotoBase64 = data.memoryPhoto; }
                    if (data.doneAt) { const d = new Date(data.doneAt); d.setMinutes(d.getMinutes() - d.getTimezoneOffset()); dateEl.value = d.toISOString().slice(0, 16); }
                }
            } else {
                currentEditingMilestoneId = null;
                if (!memoryFields.classList.contains('hidden')) { const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); dateEl.value = now.toISOString().slice(0, 16); }
            }
            modal.classList.remove('hidden');
        };

        window.saveMilestone = async () => {
            const title = document.getElementById('ms-title').value.trim();
            if (!title) return alert("Titel fehlt!");
            const user = localStorage.getItem('currentUser');
            const location = document.getElementById('ms-location').value.trim();
            const originalLocation = document.getElementById('ms-location').getAttribute('data-original-location');

            const payload = { text: title, location: location, info: document.getElementById('ms-info').value.trim(), cat: document.getElementById('ms-cat').value, weather: document.getElementById('ms-weather').value };

            if (location !== originalLocation) { payload.lat = null; payload.lon = null; }
            
            if (currentModalMode === 'archive') {
                payload.status = 'done'; payload.isBucket = false;
                payload.memoryNote = document.getElementById('ms-note').value.trim();
                payload.ratingMeriam = document.getElementById('ms-rating-m').value;
                payload.ratingSamet = document.getElementById('ms-rating-s').value;
                const dateVal = document.getElementById('ms-date').value;
                payload.doneAt = dateVal ? new Date(dateVal).getTime() : Date.now();
                if (currentPhotoBase64) payload.memoryPhoto = currentPhotoBase64;
            } else {
                if (!currentEditingMilestoneId) { payload.status = 'open'; payload.isBucket = true; payload.timestamp = Date.now(); }
                else {
                    if (!document.getElementById('ms-memory-fields').classList.contains('hidden')) {
                         payload.memoryNote = document.getElementById('ms-note').value.trim();
                         payload.ratingMeriam = document.getElementById('ms-rating-m').value;
                         payload.ratingSamet = document.getElementById('ms-rating-s').value;
                         const dateVal = document.getElementById('ms-date').value;
                         if (dateVal) payload.doneAt = new Date(dateVal).getTime();
                         if (currentPhotoBase64) payload.memoryPhoto = currentPhotoBase64;
                    }
                }
            }

            if (currentEditingMilestoneId) await update(ref(db, `wishes/${currentEditingMilestoneId}`), payload);
            else { payload.by = user; if (!payload.timestamp) payload.timestamp = Date.now(); await push(ref(db, 'wishes'), payload); }
            document.getElementById('milestone-modal').classList.add('hidden');
        };

        window.openCountdownModal = () => { document.getElementById('countdown-modal').classList.remove('hidden'); if (countdownTarget) document.getElementById('new-cd-title').value = countdownTitle; };
        window.editCountdown = () => { document.getElementById('countdown-modal').classList.remove('hidden'); document.getElementById('new-cd-title').value = countdownTitle; };

        document.getElementById('btn-save-countdown').onclick = async () => {
            try {
                const title = document.getElementById('new-cd-title').value.trim();
                const dateStr = document.getElementById('new-cd-date').value;
                if(!title || !dateStr) return alert("Bitte ausf√ºllen!");
                const timestamp = new Date(dateStr).getTime();
                if (isNaN(timestamp)) return alert("Ung√ºltiges Datum!");
                await set(ref(db, 'countdown/current'), { title: title, target: timestamp });
                document.getElementById('countdown-modal').classList.add('hidden');
                document.getElementById('new-cd-title').value = ""; document.getElementById('new-cd-date').value = "";
                playSound('success');
            } catch (e) { alert("Fehler: " + e.message); }
        };

        window.deleteCountdown = () => { if(confirm("L√∂schen?")) set(ref(db, 'countdown/current'), null); };

        const updateCountdownUI = () => {
            if (!countdownTarget) return;
            const diff = countdownTarget - Date.now();
            if (diff <= 0) { document.getElementById('cd-days').innerText = "0"; return; }
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById('cd-days').innerText = days;
            document.getElementById('cd-hours').innerText = hours;
            document.getElementById('cd-min').innerText = minutes;
        };
        setInterval(updateCountdownUI, 1000);

        const getCatLabel = (val) => val === 'Planung' ? 'üìÖ Planung n√∂tig' : '‚ö° Spontan m√∂glich';
        const getWeatherLabel = (val) => { if (val === 'Sonne') return '‚òÄÔ∏è Bei Sonne sch√∂ner'; if (val === 'Regen') return 'üè† Indoor / Regen-Option'; return '‚òÅÔ∏è Wetter egal'; };

        const syncData = (currentUser) => {
            const partner = currentUser === "Samet" ? "Meriam" : "Samet";
            document.getElementById('love-letter-title').innerText = `Post-it an ${partner} üìù`;
            document.getElementById('vs-label').innerText = `Ich vs ${partner}`;

            onValue(ref(db, 'stats/claimedCount'), (snap) => { globalClaimedCount = snap.val() || 0; if (globalDoneCount !== undefined) updateRewardUI(globalDoneCount, globalClaimedCount); });
            onValue(ref(db, 'systemStart'), (snap) => { relationshipStart = snap.val(); updateUptime(); });
            onValue(ref(db, 'countdown/current'), (snap) => {
                const item = snap.val();
                if (item && item.target > Date.now()) {
                    countdownTarget = item.target; countdownTitle = item.title;
                    document.getElementById('countdown-title').innerText = item.title + " ‚ù§Ô∏è";
                    document.getElementById('countdown-placeholder').classList.add('hidden'); document.getElementById('countdown-card').classList.remove('hidden'); updateCountdownUI();
                } else { document.getElementById('countdown-card').classList.add('hidden'); document.getElementById('countdown-placeholder').classList.remove('hidden'); countdownTarget = null; }
            });

            onValue(ref(db, 'loveLetter'), (snap) => { const d = snap.val(); if(d) document.getElementById('love-letter-display').innerText = `"${d.text}" - Von ${d.by}`; });
            onValue(ref(db, 'quiz'), (snap) => { 
                const quizList = document.getElementById('quiz-list'); quizList.innerHTML = ""; 
                const data = snap.val(); if(!data) return; 
                Object.keys(data).reverse().forEach(id => { 
                    const item = data[id]; const div = document.createElement('div'); 
                    div.className = "p-3 bg-pink-50 rounded-xl text-xs flex justify-between items-center shadow-sm animate-slide-up"; 
                    div.innerHTML = `<div><p class="font-bold">${item.q}</p><p class="text-[10px] text-gray-400 mt-1 hidden" id="a-${id}">Antwort: ${item.a}</p></div><button onclick="document.getElementById('a-${id}').classList.toggle('hidden')" class="text-pink-500 font-bold">L√∂sung</button>`; 
                    quizList.appendChild(div); 
                }); 
            });

            onValue(ref(db, 'wishes'), (snapshot) => {
                const wishList = document.getElementById('wish-list'); const archiveList = document.getElementById('archive-list'); const bucketList = document.getElementById('bucket-list-content');
                const galleryGrid = document.getElementById('gallery-grid');
                wishList.innerHTML = ""; archiveList.innerHTML = ""; bucketList.innerHTML = ""; galleryGrid.innerHTML = "";
                const data = snapshot.val(); if(!data) return;

                let doneCount = 0, sametTotal = 0, meriamTotal = 0, total = 0, doneWeekKeys = new Set();
                let curWeekKey = getWeekKey(new Date()); let thisWeekDone = false;

                Object.keys(data).forEach(id => {
                    const item = data[id]; total++;
                    if(item.status === 'done') { doneCount++; doneWeekKeys.add(getWeekKey(item.doneAt)); if(getWeekKey(item.doneAt) === curWeekKey) thisWeekDone = true; }
                    if(item.by === 'Samet') sametTotal++; else meriamTotal++;
                });
                globalDoneCount = doneCount; updateRewardUI(globalDoneCount, globalClaimedCount);

                let streak = 0; let weekIt = new Date(); if(!thisWeekDone) weekIt.setDate(weekIt.getDate() - 7);
                while(doneWeekKeys.has(getWeekKey(weekIt))) { streak++; weekIt.setDate(weekIt.getDate() - 7); }
                document.getElementById('stat-streak').innerText = streak;
                document.getElementById('stat-vs').innerText = (currentUser === "Samet" ? sametTotal : meriamTotal) + " : " + (currentUser === "Samet" ? meriamTotal : sametTotal);
                document.getElementById('stat-progress').innerText = Math.round((doneCount / total) * 100 || 0) + "%";
                document.getElementById('streak-info').innerText = thisWeekDone ? "‚úÖ Serie sicher" : `‚è≥ N√∂tig bis ${getNextSunday()}`;
                
                const allIds = Object.keys(data);
                const activeIds = allIds.filter(id => data[id].status === 'active');
                const openIds = allIds.filter(id => data[id].status === 'open' && !data[id].isBucket).reverse();
                const doneIds = allIds.filter(id => data[id].status === 'done').reverse();
                const bucketIds = allIds.filter(id => data[id].isBucket).reverse();

                // F√ºlle die Galerie (Optimiert!)
                doneIds.forEach(id => {
                    const item = data[id];
                    if (item.memoryPhoto) {
                        const dateStr = new Date(item.doneAt).toLocaleDateString('de-DE');
                        const pol = document.createElement('div');
                        pol.className = "polaroid animate-scale-in";
                        // WICHTIG: Hier jetzt das VIEW modal √∂ffnen, nicht das EDIT modal
                        pol.onclick = () => openMemoryView(id); 
                        pol.innerHTML = `<img src="${item.memoryPhoto}" loading="lazy" alt="${item.text}"><p class="polaroid-caption">${dateStr} - ${item.text}</p>`;
                        galleryGrid.appendChild(pol);
                    }
                });

                activeIds.forEach(id => {
                    const item = data[id]; const isSecret = item.surprise && item.by !== currentUser;
                    const card = document.createElement('div'); card.className = "mint-card p-4 border-l-4 border-green-400 bg-green-50/90 shadow-md relative overflow-hidden animate-slide-up";
                    card.innerHTML = `<div class="absolute top-0 right-0 bg-green-400 text-white text-[9px] font-black px-2 py-1 rounded-bl-xl uppercase tracking-widest">L√§uft gerade</div><div class="flex justify-between items-start"><div class="flex-1 pr-8"><p class="font-bold text-lg text-teal-900">${isSecret ? 'ü§´ Geheime Idee' : item.text}</p>${!isSecret && item.location ? `<p class="text-[11px] text-teal-600 mt-1 font-medium">üìç ${item.location}</p>` : ''}<div class="flex gap-2 mt-2"><span class="user-badge ${item.by === 'Meriam' ? 'badge-meriam' : 'badge-samet'}">${item.by}</span></div></div><div class="flex gap-2 pt-6"><button onclick="markAsDone('${id}')" class="text-green-500 font-black text-xs bg-white px-3 py-1 rounded-full shadow-sm border border-green-200 hover:bg-green-50">BEENDEN ‚úì</button></div></div>`;
                    wishList.appendChild(card);
                });

                openIds.forEach(id => {
                    const item = data[id]; const isSecret = item.surprise && item.by !== currentUser;
                    const card = document.createElement('div'); card.className = "mint-card p-4 border-l-4 animate-slide-up " + (item.by === 'Meriam' ? 'border-pink-200' : 'border-teal-200');
                    card.innerHTML = `<div class="flex justify-between items-start"><div class="flex-1"><p class="font-bold ${isSecret ? 'italic text-gray-300' : ''}">${item.surprise && item.by === currentUser ? 'üîí ' : ''}${isSecret ? 'ü§´ Geheime Idee' : item.text}</p>${!isSecret && item.location ? `<p class="text-[11px] text-teal-600 mt-1 font-medium">üìç ${item.location}</p>` : ''}<div class="flex gap-2 mt-2"><span class="user-badge ${item.by === 'Meriam' ? 'badge-meriam' : 'badge-samet'}">${item.by}</span><span class="user-badge badge-samet text-[7px] bg-teal-50 text-teal-600">${getCatLabel(item.cat)}</span><span class="user-badge badge-samet text-[7px] bg-teal-50 text-teal-600">${getWeatherLabel(item.weather)}</span></div></div><div class="flex gap-2"><button onclick="markAsDone('${id}')" class="text-teal-400 font-bold">‚úì</button><button onclick="deleteWish('${id}')" class="text-gray-200 text-xs">‚úï</button></div></div>`;
                    wishList.appendChild(card);
                });

                bucketIds.forEach(id => {
                    const item = data[id]; const isDone = item.status === 'done';
                    const div = document.createElement('div'); div.className = "mint-card p-4 bucket-card animate-slide-up relative " + (isDone ? "opacity-50" : "");
                    div.innerHTML = `<div class="absolute top-2 right-2"><button onclick="openMilestoneModal('edit', '${id}', 'bucket')" class="text-gray-400 hover:text-teal-500 p-1 bg-white/50 rounded-full shadow-sm">‚úèÔ∏è</button></div><div class="flex justify-between items-center"><div><p class="font-black text-yellow-700">${item.text} ‚ú®</p><p class="text-[9px] uppercase text-yellow-600 mt-1">${isDone ? 'Erreicht' : 'Bucket List'}</p></div>${!isDone ? `<button onclick="markAsDone('${id}')" class="text-yellow-600 font-bold text-lg mr-6">‚úì</button>` : ''}</div>`;
                    bucketList.appendChild(div);
                });

                doneIds.forEach(id => {
                    const item = data[id]; const timeStr = new Date(item.doneAt).toLocaleDateString('de-DE');
                    const card = document.createElement('div'); card.className = "mint-card p-4 bg-white/95 border border-teal-50 shadow-inner animate-slide-up relative group";
                    const hasMyRating = currentUser === 'Meriam' ? item.ratingMeriam : item.ratingSamet;
                    let ratingUI = `<div class="mt-4 border-t border-teal-50 pt-3">`;
                    let memoryUI = "";
                    if (item.memoryPhoto) memoryUI += `<div class="mt-3 bg-teal-50/50 p-3 rounded-xl border border-teal-100/50"><img src="${item.memoryPhoto}" loading="lazy" class="w-full h-32 object-cover rounded-lg mb-2 shadow-sm"></div>`;
                    
                    if (item.comments) {
                         const commentsArray = Object.values(item.comments); memoryUI += `<div class="mt-2 space-y-2">`;
                         commentsArray.forEach(comment => {
                             const isMeriam = comment.by === 'Meriam';
                             const containerClass = isMeriam ? "bg-pink-50 border-pink-200 text-pink-800" : "bg-teal-50 border-teal-200 text-teal-800";
                             memoryUI += `<div class="p-2 rounded-xl border ${containerClass} text-xs"><p class="font-bold opacity-70">${comment.by}</p><p class="italic">"${comment.text}"</p></div>`;
                         });
                         memoryUI += `</div>`;
                    } else if (item.memoryNote) memoryUI += `<div class="mt-3 bg-teal-50/50 p-3 rounded-xl border border-teal-100/50"><p class="text-[10px] text-teal-800 italic">"${item.memoryNote}"</p></div>`;
                    memoryUI += `<button onclick="openCommentModal('${id}')" class="w-full mt-2 text-[10px] font-bold text-gray-400 border border-dashed border-gray-300 rounded-lg py-2 hover:bg-gray-50 uppercase tracking-widest">üìù Kommentieren</button>`;

                    if (hasMyRating) ratingUI += `<div class="flex items-center justify-center gap-8"><div class="flex flex-col items-center"><span class="text-[10px] font-black text-pink-400 uppercase mb-1">Meriam</span><div class="text-lg font-black text-pink-500 bg-pink-50 w-10 h-10 flex items-center justify-center rounded-2xl shadow-sm border border-pink-100">${item.ratingMeriam || '-'}</div></div><div class="flex flex-col items-center"><span class="text-[10px] font-black text-teal-400 uppercase mb-1">Samet</span><div class="text-lg font-black text-teal-600 bg-teal-50 w-10 h-10 flex items-center justify-center rounded-2xl shadow-sm border border-teal-100">${item.ratingSamet || '-'}</div></div></div>`;
                    else ratingUI += `<p class="text-[9px] font-bold text-teal-600 uppercase tracking-widest mb-2 text-center animate-pulse">Rate das Date 1-10</p><div class="flex justify-center gap-1 overflow-x-auto pb-1 px-2">${[1,2,3,4,5,6,7,8,9,10].map(n => `<button onclick="playSound('pop'); saveRating('${id}', ${n})" class="rating-btn hover:bg-teal-500 hover:text-white w-7 h-7 text-[10px] shadow-sm">${n}</button>`).join('')}</div>`;
                    ratingUI += `</div>`;
                    
                    card.innerHTML = `<div class="absolute top-2 right-2"><button onclick="playSound('pop'); openMilestoneModal('edit', '${id}')" class="text-gray-400 hover:text-teal-500 p-1 bg-white/50 rounded-full shadow-sm">‚úèÔ∏è</button></div><p class="font-bold text-teal-800 pr-6">${item.text} üèÜ</p><p class="text-[8px] uppercase text-gray-400 mt-1">${timeStr} ‚Ä¢ Von ${item.by}</p><div class="flex gap-2 my-2"><span class="user-badge badge-samet text-[7px] bg-teal-50 text-teal-600">${getCatLabel(item.cat)}</span><span class="user-badge badge-samet text-[7px] bg-teal-50 text-teal-600">${getWeatherLabel(item.weather)}</span></div>${item.location ? `<p class="text-[10px] mt-1 italic">üìç ${item.location}</p>` : ''}${item.info ? `<p class="text-[10px] text-gray-500 italic mt-1 border-l-2 border-teal-100 pl-2">üí° ${item.info}</p>` : ''}${memoryUI}${ratingUI}`;
                    archiveList.appendChild(card);
                });
            });
        };

        document.getElementById('btn-send-letter').onclick = () => { const input = document.getElementById('love-letter-input'); if(!input.value.trim()) return; set(ref(db, 'loveLetter'), { text: input.value, by: localStorage.getItem('currentUser'), time: Date.now() }); input.value = ""; };
        document.getElementById('btn-spin-roulette').onclick = () => { const res = document.getElementById('roulette-result'); res.innerText = "‚è≥..."; setTimeout(() => { res.innerText = Math.random() > 0.5 ? "Samet üèÜ" : "Meriam üèÜ"; }, 1000); };
        document.getElementById('btn-add-quiz').onclick = () => { const q = document.getElementById('quiz-q'); const a = document.getElementById('quiz-a'); if(!q.value || !a.value) return; push(ref(db, 'quiz'), { q: q.value, a: a.value, by: localStorage.getItem('currentUser') }); q.value = ""; a.value = ""; };
        
        window.markAsDone = (id) => { currentCompletingId = id; openMemoryModalInternal(); };
        window.openCommentModal = (id) => { currentCompletingId = id; openMemoryModalInternal(); }
        const openMemoryModalInternal = () => { document.getElementById('memory-modal').classList.remove('hidden'); document.getElementById('memory-photo-file').value = ""; document.getElementById('preview-image').classList.add('hidden'); document.getElementById('upload-text').innerText = "üì∏ Foto hinzuf√ºgen"; currentPhotoBase64 = ""; document.getElementById('memory-note').value = ""; }
        window.closeMemoryModal = () => { document.getElementById('memory-modal').classList.add('hidden'); currentCompletingId = null; };

        document.getElementById('btn-save-memory').onclick = async () => {
            if (!currentCompletingId) return;
            const note = document.getElementById('memory-note').value.trim();
            const user = localStorage.getItem('currentUser');
            const updates = {};
            updates[`wishes/${currentCompletingId}/status`] = 'done';
            const snapshot = await get(ref(db, `wishes/${currentCompletingId}`)); const item = snapshot.val();
            if (item && item.status !== 'done') updates[`wishes/${currentCompletingId}/doneAt`] = Date.now();
            if (currentPhotoBase64) updates[`wishes/${currentCompletingId}/memoryPhoto`] = currentPhotoBase64;
            if (note) { const commentId = push(ref(db, `wishes/${currentCompletingId}/comments`)).key; updates[`wishes/${currentCompletingId}/comments/${commentId}`] = { text: note, by: user, timestamp: Date.now() }; }
            await update(ref(db), updates); closeMemoryModal(); document.getElementById('result-box').classList.add('hidden');
        };

        window.saveRating = (id, val) => { const u = localStorage.getItem('currentUser'); const field = u === 'Meriam' ? 'ratingMeriam' : 'ratingSamet'; const up = {}; up[field] = val; update(ref(db, `wishes/${id}`), up); };
        window.deleteWish = (id) => remove(ref(db, `wishes/${id}`));

        document.getElementById('btn-add').onclick = () => {
            const input = document.getElementById('wish-input'); if(!input.value.trim()) return;
            push(ref(db, 'wishes'), { text: input.value, location: document.getElementById('location-input').value.trim(), info: document.getElementById('info-input').value.trim(), cat: document.getElementById('cat-select').value, weather: document.getElementById('weather-select').value, surprise: document.getElementById('surprise-toggle').checked, isBucket: document.getElementById('bucket-toggle').checked, by: localStorage.getItem('currentUser'), timestamp: Date.now(), status: 'open' });
            input.value = ""; document.getElementById('location-input').value = ""; document.getElementById('info-input').value = ""; document.getElementById('surprise-toggle').checked = false; document.getElementById('bucket-toggle').checked = false;
        };

        document.getElementById('btn-roll').onclick = () => {
            const btn = document.getElementById('btn-roll');
            const diceContainer = document.getElementById('dice-container');
            const cube = document.getElementById('cube-3d');
            const lockScreen = document.getElementById('lock-screen');
            const resBox = document.getElementById('result-box');
            const flash = document.getElementById('flash-layer');
            const lockText = document.getElementById('lock-text');
            const lockSvg = document.querySelector('.lock-svg');

            resBox.classList.add('hidden'); resBox.classList.remove('magic-pop-in');
            lockScreen.classList.add('hidden'); diceContainer.classList.remove('hidden'); diceContainer.style.opacity = "1";
            lockSvg.classList.remove('lock-open', 'lock-rattle', 'lock-pop-in');

            onValue(ref(db, 'wishes'), (snap) => {
                const data = snap.val(); if(!data) return;
                let wishes = Object.keys(data).filter(id => data[id].status === 'open' && !data[id].isBucket);
                const fCat = document.getElementById('filter-cat').value; if(fCat !== "Alle") wishes = wishes.filter(id => data[id].cat === fCat);
                if(wishes.length === 0) return alert("Nichts gefunden!"); 
                rolledDateId = wishes[Math.floor(Math.random() * wishes.length)]; const chosen = data[rolledDateId];

                cube.classList.add('is-spinning'); btn.disabled = true; btn.innerHTML = "üé≤ W√úRFELT...";

                setTimeout(() => {
                    cube.classList.remove('is-spinning');
                    if(chosen.surprise) {
                        diceContainer.classList.add('hidden'); lockScreen.classList.remove('hidden'); lockSvg.classList.add('lock-pop-in'); lockText.innerText = "GEHEIME MISSION...";
                        setTimeout(() => { lockSvg.classList.add('lock-rattle'); lockText.innerText = "ZUGRIFF GEPR√úFT..."; }, 800);
                        setTimeout(() => { lockSvg.classList.remove('lock-rattle'); lockSvg.classList.add('lock-open'); flash.classList.add('do-flash'); lockText.innerText = "ZUGRIFF ERLAUBT!"; lockText.classList.add('text-green-500'); setTimeout(() => { playSound('success'); lockScreen.classList.add('hidden'); flash.classList.remove('do-flash'); showResult(chosen); btn.disabled = false; btn.innerText = "W√úRFELN"; lockText.classList.remove('text-green-500'); }, 1000); }, 2500);
                    } else {
                        diceContainer.classList.add('hidden'); showResult(chosen); document.getElementById('result-box').classList.add('magic-pop-in'); playSound('success'); btn.disabled = false; btn.innerText = "W√úRFELN";
                    }
                }, 1500);
            }, { onlyOnce: true });
        };

        const showResult = (chosen) => {
            const resBox = document.getElementById('result-box'); 
            document.getElementById('final-choice').innerText = chosen.text;
            document.getElementById('final-info').innerText = chosen.info ? chosen.info : "";
            const catMap = { 'Sofort': '‚ö° Spontan m√∂glich', 'Planung': 'üìÖ Planung n√∂tig' };
            const weatherMap = { 'Egal': '‚òÅÔ∏è Wetter spielt keine Rolle', 'Sonne': '‚òÄÔ∏è Bei Sonne sch√∂ner', 'Regen': 'üè† Indoor / Auch bei schlechten Wetter m√∂glich' };
            document.getElementById('result-labels').innerHTML = `<span class="user-badge bg-teal-50 text-teal-600 border border-teal-100">${catMap[chosen.cat] || chosen.cat}</span><span class="user-badge bg-teal-50 text-teal-600 border border-teal-100">${weatherMap[chosen.weather] || chosen.weather}</span>`;
            
            if(chosen.location) { document.getElementById('map-frame').src = `https://maps.google.com/maps?q=${encodeURIComponent(chosen.location)}&output=embed`; document.getElementById('map-container').classList.remove('hidden'); } 
            else document.getElementById('map-container').classList.add('hidden');
            
            const b = document.getElementById('result-creator-badge'); b.innerText = "Idee von " + chosen.by; b.className = "user-badge " + (chosen.by === 'Meriam' ? 'badge-meriam' : 'badge-samet');
            resBox.classList.remove('hidden'); document.getElementById('unfold-wrapper').classList.add('unfold-anim');
            document.getElementById('challenge-display').classList.add('hidden'); document.getElementById('challenge-btn-container').classList.remove('hidden');
        };

        document.getElementById('btn-accept-date-only-main').onclick = () => { window.startActiveDate(rolledDateId); };
        document.getElementById('btn-accept-both').onclick = () => { window.startActiveDate(rolledDateId); };
        document.getElementById('btn-accept-date-only-sub').onclick = () => { window.startActiveDate(rolledDateId); };
        document.getElementById('btn-logout').onclick = () => { localStorage.clear(); location.reload(); };
        
        document.getElementById('btn-movie-diplomat').onclick = async () => {
            const prefM = document.getElementById('movie-pref-meriam').value.trim();
            const prefS = document.getElementById('movie-pref-samet').value.trim();
            const btn = document.getElementById('btn-movie-diplomat');
            const resBox = document.getElementById('movie-result');
            const resText = document.getElementById('movie-text');
            if (!prefM || !prefS) return alert("Bitte gebt beide eine Richtung an! üçø");
            const originalText = btn.innerText; btn.innerText = "üîç Scanne Datenbank..."; btn.disabled = true; resBox.classList.remove('hidden'); resText.style.opacity = '0.5'; resText.innerText = "Analysiere Genres...\nSuche Kompromiss...";
            const prompt = `Agiere als Film-Experte f√ºr ein Paar. Sie will: "${prefM}". Er will: "${prefS}". Finde exakt 3 existierende Filme, die den perfekten Kompromiss bilden. Format pro Zeile: "Titel (Jahr) - Kurze Begr√ºndung". W√§hle nur gute Filme (IMDb 7.0+). Antworte auf Deutsch.`;
            const suggestion = await callGemini(prompt);
            resText.innerText = suggestion ? suggestion : "Keine Verbindung zu Hollywood. Probier's nochmal!";
            resText.style.opacity = '1'; btn.innerText = originalText; btn.disabled = false;
        };
        
        checkAuth();
    </script>
</body>
</html>
