<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date Decision Maker | Mystery Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #E0F2F1; color: #2D3748; }
        .pink-btn { background-color: #FF80AB; color: white; transition: all 0.2s; }
        .pink-btn:hover { background-color: #F06292; transform: translateY(-1px); }
        .teal-btn { background-color: #14B8A6; color: white; transition: all 0.2s; }
        .teal-btn:hover { background-color: #0D9488; transform: translateY(-1px); }
        .mint-card { background: white; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 2px solid #B2DFDB; }
        .hidden { display: none !important; }
        
        #dice { transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: inline-block; font-size: 5.5rem; padding: 1.5rem 0; }
        .rolling { animation: shake 0.1s infinite; }
        @keyframes shake {
            0% { transform: translate(2px, 1px) rotate(0deg); }
            20% { transform: translate(-1px, -2px) rotate(-1deg); }
            40% { transform: translate(-3px, 0px) rotate(1deg); }
            100% { transform: translate(-1px, 2px) rotate(-1deg); }
        }

        .filter-select { background-color: #f0fdfa; border: 1px solid #99f6e4; border-radius: 0.75rem; padding: 0.5rem; font-size: 0.875rem; outline: none; }
        .user-badge { font-size: 9px; padding: 2px 8px; border-radius: 99px; font-weight: bold; text-transform: uppercase; }
        .badge-meriam { background-color: #fce4ec; color: #f06292; }
        .badge-samet { background-color: #e0f2f1; color: #00897b; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #FF80AB; }
        input:checked + .slider:before { transform: translateX(20px); }

        .online-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; vertical-align: middle; }
        .online { background-color: #4ADE80; box-shadow: 0 0 10px #4ADE80; }
        .offline { background-color: #CBD5E1; }
        
        /* Spezial Animationen */
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .unlock-anim { animation: unlock 0.8s ease-out forwards; }
        @keyframes unlock {
            0% { transform: scale(1) rotate(0); }
            50% { transform: scale(1.3) rotate(-15deg); }
            100% { transform: scale(1) rotate(0); }
        }
    </style>
</head>
<body class="p-4 min-h-screen flex flex-col items-center">

    <div id="login-screen" class="w-full max-w-md mt-10 md:mt-20">
        <div class="mint-card p-10 text-center border-t-8 border-teal-400">
            <h1 class="text-3xl font-bold text-teal-800 tracking-tight">Date-Decision-Maker</h1>
            <p class="text-xl text-teal-600 mb-10 font-medium">Willkommen</p>
            <div class="grid grid-cols-2 gap-4">
                <button id="btn-meriam" class="pink-btn py-8 rounded-3xl font-bold text-xl shadow-lg active:scale-95">Meriam</button>
                <button id="btn-samet" class="teal-btn py-8 rounded-3xl font-bold text-xl shadow-lg active:scale-95">Samet</button>
            </div>
        </div>
    </div>

    <div id="main-dashboard" class="hidden w-full max-w-md">
        <header class="flex justify-between items-center mb-6 mt-4 px-2">
            <div>
                <div class="flex items-center">
                    <span id="partner-status" class="online-indicator offline"></span>
                    <h1 class="text-2xl font-bold text-teal-800 tracking-tight">Date Maker</h1>
                </div>
                <p id="user-greeting" class="text-[10px] text-pink-500 font-bold uppercase tracking-widest"></p>
            </div>
            <button id="btn-logout" class="text-xs text-gray-400 underline uppercase font-bold tracking-wider">Abmelden</button>
        </header>

        <div class="mint-card p-6 mb-6">
            <input id="wish-input" type="text" placeholder="Deine neue Idee..." class="w-full p-4 bg-teal-50 rounded-xl mb-4 outline-none text-lg">
            <div class="flex gap-2 mb-4 text-xs">
                <select id="cat-select" class="flex-1 filter-select"><option value="Spontan">‚ö° Spontan</option><option value="Geplant">üìÖ Geplant</option></select>
                <select id="weather-select" class="flex-1 filter-select"><option value="Egal">‚òÅÔ∏è Egal</option><option value="Sonne">‚òÄÔ∏è Sonne</option><option value="Regen">üè† Regen</option></select>
            </div>
            <div class="flex items-center justify-between px-2 mb-4">
                <span class="text-sm font-bold text-gray-500 text-xs">√úberraschung? ü§´</span>
                <label class="switch"><input type="checkbox" id="surprise-toggle"><span class="slider"></span></label>
            </div>
            <button id="btn-add" class="pink-btn w-full py-3 rounded-xl font-bold uppercase tracking-widest shadow-md">Hinzuf√ºgen</button>
        </div>

        <div class="mint-card p-8 mb-6 text-center bg-gradient-to-b from-white to-teal-50 overflow-hidden">
            <div class="flex gap-2 mb-4 justify-center text-[10px] font-bold">
                <select id="filter-cat" class="flex-1 filter-select"><option value="Alle">Alles</option><option value="Spontan">‚ö° Spontan</option><option value="Geplant">üìÖ Geplant</option></select>
                <select id="filter-weather" class="flex-1 filter-select"><option value="Alle">Wetter: Egal</option><option value="Sonne">‚òÄÔ∏è Sonne</option><option value="Regen">üè† Regen</option></select>
            </div>
            <div id="dice-container"><div id="dice">üé≤</div></div>
            
            <div id="result-box" class="mt-2 hidden">
                <div id="surprise-reveal" class="hidden mb-2">
                    <div class="text-3xl unlock-anim mb-1">üîì</div>
                    <p class="text-[10px] font-bold text-pink-500 uppercase tracking-[0.2em]">‚ú® Spezial-√úberraschung ‚ú®</p>
                </div>

                <p class="text-[10px] uppercase text-gray-400 mb-1 tracking-widest">W√ºrfel sagt:</p>
                <h2 id="final-choice" class="text-2xl font-bold text-pink-600 animate-bounce mb-2"></h2>
                <div id="result-info" class="mb-6 flex justify-center"><span id="result-creator-badge" class="user-badge"></span></div>
                
                <div id="challenge-section">
                    <div id="challenge-btn-container">
                        <button id="btn-show-challenge" class="text-[10px] font-bold text-teal-600 border border-teal-200 px-6 py-2 rounded-full hover:bg-teal-50 transition-all uppercase tracking-widest shadow-sm">Bonus-Challenge?</button>
                    </div>
                    <div id="challenge-display" class="hidden mt-4 p-5 bg-pink-50 rounded-3xl border-2 border-pink-100 text-pink-600 text-sm pop-in">
                        <p id="challenge-text" class="italic mb-4 font-medium"></p>
                        <div class="flex gap-2 justify-center">
                            <button id="btn-accept-challenge" class="bg-teal-500 text-white text-[10px] px-4 py-2 rounded-xl font-bold uppercase shadow-sm">Annehmen & Erledigt</button>
                            <button id="btn-decline-challenge" class="bg-white text-gray-400 text-[10px] px-4 py-2 rounded-xl font-bold uppercase border border-gray-100">Andere</button>
                        </div>
                    </div>
                </div>
            </div>
            <button id="btn-roll" class="mt-4 bg-teal-700 text-white px-10 py-4 rounded-full font-bold shadow-xl w-full active:scale-95 transition-all">W√úRFELN</button>
        </div>

        <div id="wish-list" class="space-y-4 mb-10"></div>
        <h3 class="font-bold text-gray-400 mb-3 px-2 text-sm uppercase tracking-widest italic">Meilensteine üèÜ</h3>
        <div id="archive-list" class="space-y-3 pb-20 opacity-90"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKF4yb7X6XDt5PSTMwiXmn0y7j9aTVMjc",
            authDomain: "date-decision-maker.firebaseapp.com",
            databaseURL: "https://date-decision-maker-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "date-decision-maker",
            storageBucket: "date-decision-maker.firebasestorage.app",
            messagingSenderId: "187389563873",
            appId: "1:187389563873:web:4fa5fea6a44c42e18078a0",
            measurementId: "G-LKDJCYHYQW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const allChallenges = [
            "Handy-Verbot f√ºr das gesamte Date! üìµ", "Bestellt euch gegenseitig ein Getr√§nk/Essen. üçπ",
            "Macht ein kurzes Video von diesem Moment. üìπ", "Tauscht f√ºr 10 Minuten eure Rollen. üé≠",
            "Sucht euch ein Lied aus f√ºr diesen Abend. üé∂", "Fl√ºstert euch nur noch zu. ü§´",
            "Macht einen Moonwalk, bevor ihr geht. üï∫", "Schreibt eine Nachricht f√ºr in einem Jahr. üíå",
            "Samet macht Meriam 3 Komplimente. üåπ", "H√§ndchenhalten ist f√ºr 30 Min Pflicht! ü§ù",
            "Kein Wort √ºber Arbeit oder Stress! üôÖ‚Äç‚ôÇÔ∏è", "Findet ein neues Geheimnis heraus. üîç",
            "Macht ein lustiges Selfie. üì∏", "Wer zuerst blinzelt, verliert! üëÄ",
            "Erz√§hlt euren sch√∂nsten gemeinsamen Moment. ‚ú®", "Gebt euch neue Kosenamen f√ºr heute. ü•∞"
        ];

        let usedIndices = [];
        let currentChallengeIndex = null;
        let rolledDateId = null;

        const login = (u) => { localStorage.setItem('currentUser', u); checkAuth(); };
        const checkAuth = () => {
            const u = localStorage.getItem('currentUser');
            if(u) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-dashboard').classList.remove('hidden');
                document.getElementById('user-greeting').innerText = `Angemeldet als ${u}`;
                startPresence(u); syncData(u);
            }
        };

        const startPresence = (u) => {
            setInterval(() => set(ref(db, `presence/${u}`), Date.now()), 5000);
            const partner = u === "Samet" ? "Meriam" : "Samet";
            onValue(ref(db, `presence/${partner}`), (s) => {
                const isOnline = s.val() && (Date.now() - s.val() < 12000);
                document.getElementById('partner-status').className = "online-indicator " + (isOnline ? "online" : "offline");
            });
        };

        const syncData = (currentUser) => {
            onValue(ref(db, 'usedChallenges'), (snap) => { usedIndices = snap.val() ? Object.values(snap.val()) : []; });
            onValue(ref(db, 'wishes'), (snapshot) => {
                const wishList = document.getElementById('wish-list');
                const archiveList = document.getElementById('archive-list');
                wishList.innerHTML = ""; archiveList.innerHTML = "";
                const data = snapshot.val();
                if(!data) return;
                Object.keys(data).reverse().forEach(id => {
                    const item = data[id];
                    const isDone = item.status === 'done';
                    const d = new Date(isDone ? item.doneAt : item.timestamp);
                    const timeStr = d.toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit'}) + ", " + d.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
                    if(!isDone) {
                        const isSecret = item.surprise && item.by !== currentUser;
                        const card = document.createElement('div');
                        card.className = "mint-card p-4 border-l-4 bg-white " + (item.by === 'Meriam' ? 'border-pink-200' : 'border-teal-200');
                        card.innerHTML = `<div class="flex justify-between items-start"><div class="flex-1"><p class="font-bold ${isSecret ? 'italic text-gray-300 font-normal' : 'text-gray-700'}">${item.by === currentUser && item.surprise ? 'üîí ' : ''}${isSecret ? 'ü§´ Geheime Idee' : item.text}</p>${item.by === currentUser && item.surprise ? '<p class="text-[9px] text-pink-400 italic mt-0.5 mb-1">Partner sieht diese Idee erst, wenn sie gew√ºrfelt wurde.</p>' : ''}<div class="flex flex-wrap items-center gap-2 mt-2"><span class="user-badge ${item.by === 'Meriam' ? 'badge-meriam' : 'badge-samet'}">${item.by}</span><span class="text-[9px] text-teal-500 font-bold uppercase">${item.cat} ‚Ä¢ ${item.weather}</span><span class="text-[9px] text-gray-300">${timeStr}</span></div></div><div class="flex gap-3 ml-2"><button onclick="markAsDone('${id}')" class="text-teal-400 text-xl font-bold">‚úì</button><button onclick="deleteWish('${id}')" class="text-gray-200 text-lg">‚úï</button></div></div>`;
                        wishList.appendChild(card);
                    } else {
                        const card = document.createElement('div');
                        card.className = "mint-card p-4 bg-gradient-to-r from-teal-50 to-white border-l-4 border-teal-500 text-xs";
                        card.innerHTML = `<div class="flex justify-between items-start"><div class="flex-1"><p class="font-bold text-gray-700 mb-1">${item.text} üèÜ</p>${item.acceptedChallenge ? `<p class="text-[10px] text-pink-500 italic mb-2 font-medium">‚ú® Challenge: ${item.acceptedChallenge}</p>` : ''}<p class="text-[8px] text-gray-400 uppercase font-bold tracking-widest">Erlebt am ${timeStr} ‚Ä¢ Von ${item.by}</p></div></div>`;
                        archiveList.appendChild(card);
                    }
                });
            });
        };

        window.markAsDone = (id, challengeText = null) => {
            const updates = { status: 'done', doneAt: Date.now() };
            if(challengeText) updates.acceptedChallenge = challengeText;
            update(ref(db, `wishes/${id}`), updates);
        };
        window.deleteWish = (id) => remove(ref(db, `wishes/${id}`));

        document.getElementById('btn-meriam').addEventListener('click', () => login('Meriam'));
        document.getElementById('btn-samet').addEventListener('click', () => login('Samet'));
        document.getElementById('btn-logout').addEventListener('click', () => { localStorage.clear(); location.reload(); });

        document.getElementById('btn-add').addEventListener('click', () => {
            const input = document.getElementById('wish-input');
            const user = localStorage.getItem('currentUser');
            if(!input.value.trim() || !user) return;
            push(ref(db, 'wishes'), { text: input.value, cat: document.getElementById('cat-select').value, weather: document.getElementById('weather-select').value, surprise: document.getElementById('surprise-toggle').checked, by: user, timestamp: Date.now(), status: 'open' });
            input.value = ""; document.getElementById('surprise-toggle').checked = false;
        });

        const pickNewChallenge = () => {
            const available = allChallenges.map((_, i) => i).filter(i => !usedIndices.includes(i));
            if(available.length === 0) {
                document.getElementById('challenge-section').innerHTML = '<p class="text-[10px] text-gray-400 italic">Keine Bonus-Challenges mehr offen!</p>';
                return;
            }
            currentChallengeIndex = available[Math.floor(Math.random() * available.length)];
            document.getElementById('challenge-text').innerText = "üí° " + allChallenges[currentChallengeIndex];
        };

        document.getElementById('btn-roll').addEventListener('click', () => {
            onValue(ref(db, 'wishes'), (snap) => {
                const data = snap.val(); if(!data) return;
                let wishes = Object.keys(data).filter(id => data[id].status === 'open');
                const fCat = document.getElementById('filter-cat').value;
                const fWeather = document.getElementById('filter-weather').value;
                if(fCat !== "Alle") wishes = wishes.filter(id => data[id].cat === fCat);
                if(fWeather !== "Alle") wishes = wishes.filter(id => data[id].weather === fWeather || data[id].weather === "Egal");
                if(wishes.length === 0) return alert("Nichts gefunden!");
                
                rolledDateId = wishes[Math.floor(Math.random() * wishes.length)];
                const chosen = data[rolledDateId];
                
                const dice = document.getElementById('dice');
                const resBox = document.getElementById('result-box');
                const surpriseReveal = document.getElementById('surprise-reveal');

                dice.classList.add('rolling'); 
                resBox.classList.add('hidden');
                surpriseReveal.classList.add('hidden');
                document.getElementById('challenge-display').classList.add('hidden');
                document.getElementById('challenge-btn-container').classList.remove('hidden');

                setTimeout(() => {
                    dice.classList.remove('rolling');
                    document.getElementById('final-choice').innerText = chosen.text;
                    const b = document.getElementById('result-creator-badge');
                    b.innerText = "Von " + chosen.by;
                    b.className = "user-badge " + (chosen.by === 'Meriam' ? 'badge-meriam' : 'badge-samet');
                    
                    // FALLS √úBERRASCHUNG: Spezial-UI zeigen
                    if(chosen.surprise) {
                        surpriseReveal.classList.remove('hidden');
                    } else {
                        surpriseReveal.classList.add('hidden');
                    }

                    resBox.classList.remove('hidden');
                }, 1200);
            }, { onlyOnce: true });
        });

        document.getElementById('btn-show-challenge').addEventListener('click', () => {
            pickNewChallenge();
            document.getElementById('challenge-display').classList.remove('hidden');
            document.getElementById('challenge-btn-container').classList.add('hidden');
        });

        document.getElementById('btn-accept-challenge').addEventListener('click', () => {
            if(currentChallengeIndex !== null && rolledDateId !== null) {
                const challengeText = allChallenges[currentChallengeIndex];
                push(ref(db, 'usedChallenges'), currentChallengeIndex);
                markAsDone(rolledDateId, challengeText);
                document.getElementById('challenge-display').innerHTML = '<p class="text-teal-600 font-bold text-[10px] uppercase tracking-widest animate-pulse">Challenge & Date angenommen! ‚ú®</p>';
                setTimeout(() => { document.getElementById('result-box').classList.add('hidden'); }, 3000);
            }
        });

        document.getElementById('btn-decline-challenge').addEventListener('click', pickNewChallenge);

        checkAuth();
    </script>
</body>
</html>